var Oe=Object.defineProperty;var Ve=(n,t,e)=>t in n?Oe(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var c=(n,t,e)=>Ve(n,typeof t!="symbol"?t+"":t,e);import{r as requireLib$1,n as nip19_exports$2,s as sha256,a as schnorr,b as bytesToHex,m as matchFilters,h as hexToBytes,g as getPublicKey,e as encrypt$2,c as generateSecretKey,d as decrypt$2,f as finalizeEvent,i as nip44_exports,j as nip04_exports,k as nip19_star,l as nip49_star,o as matchFilter}from"./vendor-DP19vGRW.js";import{g as getDefaultExportFromCjs,D as Dexie}from"./dexie-CoGj-NRt.js";var lib={},types={},hasRequiredTypes;function requireTypes(){return hasRequiredTypes||(hasRequiredTypes=1,Object.defineProperty(types,"__esModule",{value:!0})),types}var ee={},taskCollection$1={},taskCollection={},utils$1={},hasRequiredUtils$1;function requireUtils$1(){if(hasRequiredUtils$1)return utils$1;hasRequiredUtils$1=1,Object.defineProperty(utils$1,"__esModule",{value:!0}),utils$1._fast_remove_single=void 0;function n(t,e){e!==-1&&(e===0?t.shift():e===t.length-1?t.length=t.length-1:t.splice(e,1))}return utils$1._fast_remove_single=n,utils$1}var bakeCollection={},hasRequiredBakeCollection;function requireBakeCollection(){return hasRequiredBakeCollection||(hasRequiredBakeCollection=1,(function(exports$1){Object.defineProperty(exports$1,"__esModule",{value:!0}),exports$1.bakeCollectionVariadic=exports$1.bakeCollectionAwait=exports$1.bakeCollection=exports$1.BAKED_EMPTY_FUNC=void 0,exports$1.BAKED_EMPTY_FUNC=(function(){});var FORLOOP_FALLBACK=1500;function generateArgsDefCode(n){var t="";if(n===0)return t;for(var e=0;e<n-1;++e)t+="arg"+String(e)+", ";return t+="arg"+String(n-1),t}function generateBodyPartsCode(n,t){for(var e="",s="",i=0;i<t;++i)e+="var f".concat(i," = collection[").concat(i,`];
`),s+="f".concat(i,"(").concat(n,`)
`);return{funcDefCode:e,funcCallCode:s}}function generateBodyPartsVariadicCode(n){for(var t="",e="",s=0;s<n;++s)t+="var f".concat(s," = collection[").concat(s,`];
`),e+="f".concat(s,`.apply(undefined, arguments)
`);return{funcDefCode:t,funcCallCode:e}}function bakeCollection(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                `).concat(funcCallCode,`
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);collection.length%10===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 10) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                        collection[i+4](`).concat(argsDefCode,`);
                        collection[i+5](`).concat(argsDefCode,`);
                        collection[i+6](`).concat(argsDefCode,`);
                        collection[i+7](`).concat(argsDefCode,`);
                        collection[i+8](`).concat(argsDefCode,`);
                        collection[i+9](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%4===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 4) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                        collection[i+3](`).concat(argsDefCode,`);
                    }
                });
            })`):collection.length%3===0?funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; i += 3) {
                        collection[i](`).concat(argsDefCode,`);
                        collection[i+1](`).concat(argsDefCode,`);
                        collection[i+2](`).concat(argsDefCode,`);
                    }
                });
            })`):funcFactoryCode=`(function(collection) {
                return (function(`.concat(argsDefCode,`) {
                    for (var i = 0; i < collection.length; ++i) {
                        collection[i](`).concat(argsDefCode,`);
                    }
                });
            })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollection=bakeCollection;function bakeCollectionAwait(collection,fixedArgsNum){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var argsDefCode=generateArgsDefCode(fixedArgsNum),_a=generateBodyPartsCode(argsDefCode,collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function(`).concat(argsDefCode,`) {
                return Promise.all([ `).concat(funcCallCode,` ]);
            });
        })`)}else{var argsDefCode=generateArgsDefCode(fixedArgsNum);funcFactoryCode=`(function(collection) {
            return (function(`.concat(argsDefCode,`) {
                var promises = Array(collection.length);
                for (var i = 0; i < collection.length; ++i) {
                    promises[i] = collection[i](`).concat(argsDefCode,`);
                }
                return Promise.all(promises);
            });
        })`)}{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionAwait=bakeCollectionAwait;function bakeCollectionVariadic(collection){if(collection.length===0)return exports$1.BAKED_EMPTY_FUNC;if(collection.length===1)return collection[0];var funcFactoryCode;if(collection.length<FORLOOP_FALLBACK){var _a=generateBodyPartsVariadicCode(collection.length),funcDefCode=_a.funcDefCode,funcCallCode=_a.funcCallCode;funcFactoryCode=`(function(collection) {
            `.concat(funcDefCode,`
            collection = undefined;
            return (function() {
                `).concat(funcCallCode,`
            });
        })`)}else funcFactoryCode=`(function(collection) {
            return (function() {
                for (var i = 0; i < collection.length; ++i) {
                    collection[i].apply(undefined, arguments);
                }
            });
        })`;{var funcFactory=eval(funcFactoryCode);return funcFactory(collection)}}exports$1.bakeCollectionVariadic=bakeCollectionVariadic})(bakeCollection)),bakeCollection}var hasRequiredTaskCollection$1;function requireTaskCollection$1(){if(hasRequiredTaskCollection$1)return taskCollection;hasRequiredTaskCollection$1=1;var n=taskCollection&&taskCollection.__spreadArray||function(_,S,y){if(y||arguments.length===2)for(var v=0,k=S.length,R;v<k;v++)(R||!(v in S))&&(R||(R=Array.prototype.slice.call(S,0,v)),R[v]=S[v]);return _.concat(R||Array.prototype.slice.call(S))};Object.defineProperty(taskCollection,"__esModule",{value:!0}),taskCollection.TaskCollection=void 0;var t=requireUtils$1(),e=requireBakeCollection();function s(_,S){var y=this.length;if(y>1)if(S){var v;(v=this._tasks).push.apply(v,arguments),this.length+=arguments.length}else this._tasks.push(_),this.length++;else if(S){if(y===1){var k=Array(1+arguments.length);k.push(k),k.push.apply(k,arguments),this._tasks=k}else{var k=Array(arguments.length);k.push.apply(k,arguments),this._tasks=k}this.length+=arguments.length}else y===1?this._tasks=[this._tasks,_]:this._tasks=_,this.length++}function i(_,S){var y=this.length;if(y>1)if(S){var v;(v=this._tasks).push.apply(v,arguments),this.length+=arguments.length}else this._tasks.push(_),this.length++;else if(S){if(y===1){var k=Array(1+arguments.length);k.push(k),k.push.apply(k,arguments),this._tasks=k}else{var k=Array(arguments.length);k.push.apply(k,arguments),this._tasks=k}this.length+=arguments.length}else y===1?this._tasks=[this._tasks,_]:this._tasks=_,this.length++;this.firstEmitBuildStrategy?this.call=f:this.rebuild()}function r(_){this.length!==0&&(this.length===1?this._tasks===_&&(this.length=0):((0,t._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(_)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length))}function a(_){if(this.length!==0){if(this.length===1)if(this._tasks===_&&(this.length=0),this.firstEmitBuildStrategy){this.call=e.BAKED_EMPTY_FUNC;return}else{this.rebuild();return}else(0,t._fast_remove_single)(this._tasks,this._tasks.lastIndexOf(_)),this._tasks.length===1?(this._tasks=this._tasks[0],this.length=1):this.length=this._tasks.length;this.firstEmitBuildStrategy?this.call=f:this.rebuild()}}function o(_){for(var S,y=[],v=1;v<arguments.length;v++)y[v-1]=arguments[v];this.length===0?(this._tasks=y,this.length=1):this.length===1?(y.unshift(this._tasks),this._tasks=y,this.length=this._tasks.length):((S=this._tasks).splice.apply(S,n([_,0],y,!1)),this.length=this._tasks.length)}function l(_){for(var S,y=[],v=1;v<arguments.length;v++)y[v-1]=arguments[v];this.length===0?(this._tasks=y,this.length=1):this.length===1?(y.unshift(this._tasks),this._tasks=y,this.length=this._tasks.length):((S=this._tasks).splice.apply(S,n([_,0],y,!1)),this.length=this._tasks.length),this.firstEmitBuildStrategy?this.call=f:this.rebuild()}function h(){this.length===0?this.call=e.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,e.bakeCollection)(this._tasks,this.argsNum)}function u(){this.length===0?this.call=e.BAKED_EMPTY_FUNC:this.length===1?this.call=this._tasks:this.call=(0,e.bakeCollectionAwait)(this._tasks,this.argsNum)}function f(){this.rebuild(),this.call.apply(void 0,arguments)}var p=(function(){function _(S,y,v,k){y===void 0&&(y=!0),v===void 0&&(v=null),k===void 0&&(k=!1),this.awaitTasks=k,this.call=e.BAKED_EMPTY_FUNC,this.argsNum=S,this.firstEmitBuildStrategy=!0,k?this.rebuild=u.bind(this):this.rebuild=h.bind(this),this.setAutoRebuild(y),v?typeof v=="function"?(this._tasks=v,this.length=1):(this._tasks=v,this.length=v.length):(this._tasks=null,this.length=0),y&&this.rebuild()}return _})();taskCollection.TaskCollection=p;function g(){this._tasks=null,this.length=0,this.call=e.BAKED_EMPTY_FUNC}function m(){this._tasks=null,this.length=0,this.call=e.BAKED_EMPTY_FUNC}function w(_){this.argsNum<_&&(this.argsNum=_,this.firstEmitBuildStrategy?this.call=f:this.rebuild())}function b(_){_?(this.push=i.bind(this),this.insert=l.bind(this),this.removeLast=a.bind(this)):(this.push=s.bind(this),this.insert=o.bind(this),this.removeLast=r.bind(this))}function E(){return this.length===0?[]:this.length===1?[this._tasks]:this._tasks}function $(_){_.length===0?(this.length=0,this.call=e.BAKED_EMPTY_FUNC):_.length===1?(this.length=1,this.call=_[0],this._tasks=_[0]):(this.length=_.length,this._tasks=_,this.firstEmitBuildStrategy?this.call=f:this.rebuild())}return p.prototype.fastClear=g,p.prototype.clear=m,p.prototype.growArgsNum=w,p.prototype.setAutoRebuild=b,p.prototype.tasksAsArray=E,p.prototype.setTasks=$,taskCollection}var hasRequiredTaskCollection;function requireTaskCollection(){return hasRequiredTaskCollection||(hasRequiredTaskCollection=1,(function(n){var t=taskCollection$1&&taskCollection$1.__createBinding||(Object.create?(function(s,i,r,a){a===void 0&&(a=r);var o=Object.getOwnPropertyDescriptor(i,r);(!o||("get"in o?!i.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return i[r]}}),Object.defineProperty(s,a,o)}):(function(s,i,r,a){a===void 0&&(a=r),s[a]=i[r]})),e=taskCollection$1&&taskCollection$1.__exportStar||function(s,i){for(var r in s)r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&t(i,s,r)};Object.defineProperty(n,"__esModule",{value:!0}),e(requireTaskCollection$1(),n)})(taskCollection$1)),taskCollection$1}var utils={},hasRequiredUtils;function requireUtils(){if(hasRequiredUtils)return utils;hasRequiredUtils=1,Object.defineProperty(utils,"__esModule",{value:!0}),utils.nullObj=void 0;function n(){var t={};return t.__proto__=null,t}return utils.nullObj=n,utils}var hasRequiredEe;function requireEe(){if(hasRequiredEe)return ee;hasRequiredEe=1;var n=ee&&ee.__spreadArray||function(y,v,k){if(k||arguments.length===2)for(var R=0,T=v.length,N;R<T;R++)(N||!(R in v))&&(N||(N=Array.prototype.slice.call(v,0,R)),N[R]=v[R]);return y.concat(N||Array.prototype.slice.call(v))};Object.defineProperty(ee,"__esModule",{value:!0}),ee.EventEmitter=void 0;var t=requireTaskCollection(),e=requireUtils$1(),s=requireUtils();function i(y,v,k,R,T,N){var A=this.events[y];if(A){if(A.length===0)return!1;if(A.argsNum<6)A.call(v,k,R,T,N);else{for(var D=new Array(A.argsNum),C=0,I=D.length;C<I;++C)D[C]=arguments[C+1];A.call.apply(void 0,D)}return!0}return!1}function r(y,v,k,R,T,N){var A=this.events[y],D;if(A!==void 0){if(A.length===0)return!1;if(A.argsNum<6)A.call(v,k,R,T,N);else{D=new Array(A.argsNum);for(var C=0,I=D.length;C<I;++C)D[C]=arguments[C+1];A.call.apply(void 0,D)}}var x=this.onceEvents[y];if(x){if(typeof x=="function")if(this.onceEvents[y]=void 0,arguments.length<6)x(v,k,R,T,N);else{if(D===void 0){D=new Array(arguments.length-1);for(var C=0,I=D.length;C<I;++C)D[C]=arguments[C+1]}x.apply(void 0,D)}else{var re=x;if(this.onceEvents[y]=void 0,arguments.length<6)for(var C=0;C<re.length;++C)re[C](v,k,R,T,N);else{if(D===void 0){D=new Array(arguments.length-1);for(var C=0,I=D.length;C<I;++C)D[C]=arguments[C+1]}for(var C=0;C<re.length;++C)re[C].apply(void 0,D)}}return!0}return A!==void 0}var a=(function(){function y(){this.events=(0,s.nullObj)(),this.onceEvents=(0,s.nullObj)(),this._symbolKeys=new Set,this.maxListeners=1/0}return Object.defineProperty(y.prototype,"_eventsCount",{get:function(){return this.eventNames().length},enumerable:!1,configurable:!0}),y})();ee.EventEmitter=a;function o(y,v){switch(this.emit===i&&(this.emit=r),typeof this.onceEvents[y]){case"undefined":this.onceEvents[y]=v,typeof y=="symbol"&&this._symbolKeys.add(y);break;case"function":this.onceEvents[y]=[this.onceEvents[y],v];break;case"object":this.onceEvents[y].push(v)}return this}function l(y,v,k){if(k===void 0&&(k=v.length),typeof v!="function")throw new TypeError("The listener must be a function");var R=this.events[y];return R?(R.push(v),R.growArgsNum(k),this.maxListeners!==1/0&&this.maxListeners<=R.length&&console.warn('Maximum event listeners for "'.concat(String(y),'" event!'))):(this.events[y]=new t.TaskCollection(k,!0,v,!1),typeof y=="symbol"&&this._symbolKeys.add(y)),this}function h(y,v){var k=this.events[y];k&&k.removeLast(v);var R=this.onceEvents[y];return R&&(typeof R=="function"?this.onceEvents[y]=void 0:typeof R=="object"&&(R.length===1&&R[0]===v?this.onceEvents[y]=void 0:(0,e._fast_remove_single)(R,R.lastIndexOf(v)))),this}function u(y,v,k,R){k===void 0&&(k=this),R===void 0&&(R=v.length),this.boundFuncs||(this.boundFuncs=new Map);var T=v.bind(k);return this.boundFuncs.set(v,T),this.addListener(y,T,R)}function f(y,v){var k,R,T=(k=this.boundFuncs)===null||k===void 0?void 0:k.get(v);return(R=this.boundFuncs)===null||R===void 0||R.delete(v),this.removeListener(y,T)}function p(y){return this.events[y]&&!!this.events[y].length}function g(y,v,k){if(k===void 0&&(k=v.length),typeof v!="function")throw new TypeError("The listener must be a function");var R=this.events[y];return!R||!(R instanceof t.TaskCollection)?(R=this.events[y]=new t.TaskCollection(k,!0,v,!1),typeof y=="symbol"&&this._symbolKeys.add(y)):(R.insert(0,v),R.growArgsNum(k),this.maxListeners!==1/0&&this.maxListeners<=R.length&&console.warn('Maximum event listeners for "'.concat(String(y),'" event!'))),this}function m(y,v){this.emit===i&&(this.emit=r);var k=this.onceEvents[y];return k?typeof k!="object"?(this.onceEvents[y]=[v,k],typeof y=="symbol"&&this._symbolKeys.add(y)):(k.unshift(v),this.maxListeners!==1/0&&this.maxListeners<=k.length&&console.warn('Maximum event listeners for "'.concat(String(y),'" once event!'))):(this.onceEvents[y]=[v],typeof y=="symbol"&&this._symbolKeys.add(y)),this}function w(y){return y===void 0?(this.events=(0,s.nullObj)(),this.onceEvents=(0,s.nullObj)(),this._symbolKeys=new Set):(this.events[y]=void 0,this.onceEvents[y]=void 0,typeof y=="symbol"&&this._symbolKeys.delete(y)),this}function b(y){return this.maxListeners=y,this}function E(){return this.maxListeners}function $(y){return this.emit===i?this.events[y]?this.events[y].tasksAsArray().slice():[]:this.events[y]&&this.onceEvents[y]?n(n([],this.events[y].tasksAsArray(),!0),typeof this.onceEvents[y]=="function"?[this.onceEvents[y]]:this.onceEvents[y],!0):this.events[y]?this.events[y].tasksAsArray():this.onceEvents[y]?typeof this.onceEvents[y]=="function"?[this.onceEvents[y]]:this.onceEvents[y]:[]}function _(){var y=this;if(this.emit===i){var v=Object.keys(this.events);return n(n([],v,!0),Array.from(this._symbolKeys),!0).filter(function(R){return R in y.events&&y.events[R]&&y.events[R].length})}else{var v=Object.keys(this.events).filter(function(T){return y.events[T]&&y.events[T].length}),k=Object.keys(this.onceEvents).filter(function(T){return y.onceEvents[T]&&y.onceEvents[T].length});return n(n(n([],v,!0),k,!0),Array.from(this._symbolKeys).filter(function(T){return T in y.events&&y.events[T]&&y.events[T].length||T in y.onceEvents&&y.onceEvents[T]&&y.onceEvents[T].length}),!0)}}function S(y){return this.emit===i?this.events[y]&&this.events[y].length||0:(this.events[y]&&this.events[y].length||0)+(this.onceEvents[y]&&this.onceEvents[y].length||0)}return a.prototype.emit=i,a.prototype.on=l,a.prototype.once=o,a.prototype.addListener=l,a.prototype.removeListener=h,a.prototype.addListenerBound=u,a.prototype.removeListenerBound=f,a.prototype.hasListeners=p,a.prototype.prependListener=g,a.prototype.prependOnceListener=m,a.prototype.off=h,a.prototype.removeAllListeners=w,a.prototype.setMaxListeners=b,a.prototype.getMaxListeners=E,a.prototype.listeners=$,a.prototype.eventNames=_,a.prototype.listenerCount=S,ee}var hasRequiredLib;function requireLib(){return hasRequiredLib||(hasRequiredLib=1,(function(n){var t=lib&&lib.__createBinding||(Object.create?(function(s,i,r,a){a===void 0&&(a=r);var o=Object.getOwnPropertyDescriptor(i,r);(!o||("get"in o?!i.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return i[r]}}),Object.defineProperty(s,a,o)}):(function(s,i,r,a){a===void 0&&(a=r),s[a]=i[r]})),e=lib&&lib.__exportStar||function(s,i){for(var r in s)r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&t(i,s,r)};Object.defineProperty(n,"__esModule",{value:!0}),e(requireTypes(),n),e(requireEe(),n)})(lib)),lib}var libExports=requireLib(),browser={exports:{}},ms,hasRequiredMs;function requireMs(){if(hasRequiredMs)return ms;hasRequiredMs=1;var n=1e3,t=n*60,e=t*60,s=e*24,i=s*7,r=s*365.25;ms=function(u,f){f=f||{};var p=typeof u;if(p==="string"&&u.length>0)return a(u);if(p==="number"&&isFinite(u))return f.long?l(u):o(u);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(u))};function a(u){if(u=String(u),!(u.length>100)){var f=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(u);if(f){var p=parseFloat(f[1]),g=(f[2]||"ms").toLowerCase();switch(g){case"years":case"year":case"yrs":case"yr":case"y":return p*r;case"weeks":case"week":case"w":return p*i;case"days":case"day":case"d":return p*s;case"hours":case"hour":case"hrs":case"hr":case"h":return p*e;case"minutes":case"minute":case"mins":case"min":case"m":return p*t;case"seconds":case"second":case"secs":case"sec":case"s":return p*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return p;default:return}}}}function o(u){var f=Math.abs(u);return f>=s?Math.round(u/s)+"d":f>=e?Math.round(u/e)+"h":f>=t?Math.round(u/t)+"m":f>=n?Math.round(u/n)+"s":u+"ms"}function l(u){var f=Math.abs(u);return f>=s?h(u,f,s,"day"):f>=e?h(u,f,e,"hour"):f>=t?h(u,f,t,"minute"):f>=n?h(u,f,n,"second"):u+" ms"}function h(u,f,p,g){var m=f>=p*1.5;return Math.round(u/p)+" "+g+(m?"s":"")}return ms}var common,hasRequiredCommon;function requireCommon(){if(hasRequiredCommon)return common;hasRequiredCommon=1;function n(t){s.debug=s,s.default=s,s.coerce=h,s.disable=o,s.enable=r,s.enabled=l,s.humanize=requireMs(),s.destroy=u,Object.keys(t).forEach(f=>{s[f]=t[f]}),s.names=[],s.skips=[],s.formatters={};function e(f){let p=0;for(let g=0;g<f.length;g++)p=(p<<5)-p+f.charCodeAt(g),p|=0;return s.colors[Math.abs(p)%s.colors.length]}s.selectColor=e;function s(f){let p,g=null,m,w;function b(...E){if(!b.enabled)return;const $=b,_=Number(new Date),S=_-(p||_);$.diff=S,$.prev=p,$.curr=_,p=_,E[0]=s.coerce(E[0]),typeof E[0]!="string"&&E.unshift("%O");let y=0;E[0]=E[0].replace(/%([a-zA-Z%])/g,(k,R)=>{if(k==="%%")return"%";y++;const T=s.formatters[R];if(typeof T=="function"){const N=E[y];k=T.call($,N),E.splice(y,1),y--}return k}),s.formatArgs.call($,E),($.log||s.log).apply($,E)}return b.namespace=f,b.useColors=s.useColors(),b.color=s.selectColor(f),b.extend=i,b.destroy=s.destroy,Object.defineProperty(b,"enabled",{enumerable:!0,configurable:!1,get:()=>g!==null?g:(m!==s.namespaces&&(m=s.namespaces,w=s.enabled(f)),w),set:E=>{g=E}}),typeof s.init=="function"&&s.init(b),b}function i(f,p){const g=s(this.namespace+(typeof p>"u"?":":p)+f);return g.log=this.log,g}function r(f){s.save(f),s.namespaces=f,s.names=[],s.skips=[];const p=(typeof f=="string"?f:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(const g of p)g[0]==="-"?s.skips.push(g.slice(1)):s.names.push(g)}function a(f,p){let g=0,m=0,w=-1,b=0;for(;g<f.length;)if(m<p.length&&(p[m]===f[g]||p[m]==="*"))p[m]==="*"?(w=m,b=g,m++):(g++,m++);else if(w!==-1)m=w+1,b++,g=b;else return!1;for(;m<p.length&&p[m]==="*";)m++;return m===p.length}function o(){const f=[...s.names,...s.skips.map(p=>"-"+p)].join(",");return s.enable(""),f}function l(f){for(const p of s.skips)if(a(f,p))return!1;for(const p of s.names)if(a(f,p))return!0;return!1}function h(f){return f instanceof Error?f.stack||f.message:f}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return s.enable(s.load()),s}return common=n,common}var hasRequiredBrowser;function requireBrowser(){return hasRequiredBrowser||(hasRequiredBrowser=1,(function(n,t){var e={};t.formatArgs=i,t.save=r,t.load=a,t.useColors=s,t.storage=o(),t.destroy=(()=>{let h=!1;return()=>{h||(h=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function s(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let h;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(h=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(h[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(h){if(h[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+h[0]+(this.useColors?"%c ":" ")+"+"+n.exports.humanize(this.diff),!this.useColors)return;const u="color: "+this.color;h.splice(1,0,u,"color: inherit");let f=0,p=0;h[0].replace(/%[a-zA-Z%]/g,g=>{g!=="%%"&&(f++,g==="%c"&&(p=f))}),h.splice(p,0,u)}t.log=console.debug||console.log||(()=>{});function r(h){try{h?t.storage.setItem("debug",h):t.storage.removeItem("debug")}catch{}}function a(){let h;try{h=t.storage.getItem("debug")||t.storage.getItem("DEBUG")}catch{}return!h&&typeof process<"u"&&"env"in process&&(h=e.DEBUG),h}function o(){try{return localStorage}catch{}}n.exports=requireCommon()(t);const{formatters:l}=n.exports;l.j=function(h){try{return JSON.stringify(h)}catch(u){return"[UnexpectedJSONParseError]: "+u.message}}})(browser,browser.exports)),browser.exports}var browserExports=requireBrowser();const createDebug2=getDefaultExportFromCjs(browserExports);var dist={},LRUCache={},LRUCacheNode={},hasRequiredLRUCacheNode;function requireLRUCacheNode(){if(hasRequiredLRUCacheNode)return LRUCacheNode;hasRequiredLRUCacheNode=1,Object.defineProperty(LRUCacheNode,"__esModule",{value:!0}),LRUCacheNode.LRUCacheNode=void 0;let n=class{constructor(e,s,i){const{entryExpirationTimeInMS:r=null,next:a=null,prev:o=null,onEntryEvicted:l,onEntryMarkedAsMostRecentlyUsed:h,clone:u,cloneFn:f}=i??{};if(typeof r=="number"&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.clone=u??!1,this.cloneFn=f??this.defaultClone,this.key=e,this.internalValue=this.clone?this.cloneFn(s):s,this.created=Date.now(),this.entryExpirationTimeInMS=r,this.next=a,this.prev=o,this.onEntryEvicted=l,this.onEntryMarkedAsMostRecentlyUsed=h}get value(){return this.clone?this.cloneFn(this.internalValue):this.internalValue}get isExpired(){return typeof this.entryExpirationTimeInMS=="number"&&Date.now()-this.created>this.entryExpirationTimeInMS}invokeOnEvicted(){if(this.onEntryEvicted){const{key:e,value:s,isExpired:i}=this;this.onEntryEvicted({key:e,value:s,isExpired:i})}}invokeOnEntryMarkedAsMostRecentlyUsed(){if(this.onEntryMarkedAsMostRecentlyUsed){const{key:e,value:s}=this;this.onEntryMarkedAsMostRecentlyUsed({key:e,value:s})}}defaultClone(e){return typeof e=="boolean"||typeof e=="string"||typeof e=="number"?e:JSON.parse(JSON.stringify(e))}};return LRUCacheNode.LRUCacheNode=n,LRUCacheNode}var hasRequiredLRUCache;function requireLRUCache(){if(hasRequiredLRUCache)return LRUCache;hasRequiredLRUCache=1,Object.defineProperty(LRUCache,"__esModule",{value:!0}),LRUCache.LRUCache=void 0;const n=requireLRUCacheNode();let t=class{constructor(s){this.lookupTable=new Map,this.head=null,this.tail=null;const{maxSize:i=25,entryExpirationTimeInMS:r=null,onEntryEvicted:a,onEntryMarkedAsMostRecentlyUsed:o,cloneFn:l,clone:h}=s??{};if(Number.isNaN(i)||i<=0)throw new Error("maxSize must be greater than 0.");if(typeof r=="number"&&(r<=0||Number.isNaN(r)))throw new Error("entryExpirationTimeInMS must either be null (no expiry) or greater than 0");this.maxSizeInternal=i,this.entryExpirationTimeInMS=r,this.onEntryEvicted=a,this.onEntryMarkedAsMostRecentlyUsed=o,this.clone=h,this.cloneFn=l}get size(){return this.cleanCache(),this.lookupTable.size}get remainingSize(){return this.maxSizeInternal-this.size}get newest(){return this.head?this.head.isExpired?(this.removeNodeFromListAndLookupTable(this.head),this.newest):this.mapNodeToEntry(this.head):null}get oldest(){return this.tail?this.tail.isExpired?(this.removeNodeFromListAndLookupTable(this.tail),this.oldest):this.mapNodeToEntry(this.tail):null}get maxSize(){return this.maxSizeInternal}set maxSize(s){if(Number.isNaN(s)||s<=0)throw new Error("maxSize must be greater than 0.");this.maxSizeInternal=s,this.enforceSizeLimit()}set(s,i,r){const a=this.lookupTable.get(s);a&&this.removeNodeFromListAndLookupTable(a);const o=new n.LRUCacheNode(s,i,{entryExpirationTimeInMS:this.entryExpirationTimeInMS,onEntryEvicted:this.onEntryEvicted,onEntryMarkedAsMostRecentlyUsed:this.onEntryMarkedAsMostRecentlyUsed,clone:this.clone,cloneFn:this.cloneFn,...r});return this.setNodeAsHead(o),this.lookupTable.set(s,o),this.enforceSizeLimit(),this}get(s){const i=this.lookupTable.get(s);return i?i.isExpired?(this.removeNodeFromListAndLookupTable(i),null):(this.setNodeAsHead(i),i.value):null}peek(s){const i=this.lookupTable.get(s);return i?i.isExpired?(this.removeNodeFromListAndLookupTable(i),null):i.value:null}delete(s){const i=this.lookupTable.get(s);return i?this.removeNodeFromListAndLookupTable(i):!1}has(s){const i=this.lookupTable.get(s);return i?i.isExpired?(this.removeNodeFromListAndLookupTable(i),!1):!0:!1}clear(){this.head=null,this.tail=null,this.lookupTable.clear()}find(s){let i=this.head;for(;i;){if(i.isExpired){const a=i.next;this.removeNodeFromListAndLookupTable(i),i=a;continue}const r=this.mapNodeToEntry(i);if(s(r))return this.setNodeAsHead(i),r;i=i.next}return null}forEach(s){let i=this.head,r=0;for(;i;){if(i.isExpired){const a=i.next;this.removeNodeFromListAndLookupTable(i),i=a;continue}s(i.value,i.key,r),i=i.next,r++}}*values(){let s=this.head;for(;s;){if(s.isExpired){const i=s.next;this.removeNodeFromListAndLookupTable(s),s=i;continue}yield s.value,s=s.next}}*keys(){let s=this.head;for(;s;){if(s.isExpired){const i=s.next;this.removeNodeFromListAndLookupTable(s),s=i;continue}yield s.key,s=s.next}}*entries(){let s=this.head;for(;s;){if(s.isExpired){const i=s.next;this.removeNodeFromListAndLookupTable(s),s=i;continue}yield this.mapNodeToEntry(s),s=s.next}}*[Symbol.iterator](){let s=this.head;for(;s;){if(s.isExpired){const i=s.next;this.removeNodeFromListAndLookupTable(s),s=i;continue}yield this.mapNodeToEntry(s),s=s.next}}enforceSizeLimit(){let s=this.tail;for(;s!==null&&this.size>this.maxSizeInternal;){const i=s.prev;this.removeNodeFromListAndLookupTable(s),s=i}}mapNodeToEntry({key:s,value:i}){return{key:s,value:i}}setNodeAsHead(s){this.removeNodeFromList(s),this.head?(s.next=this.head,this.head.prev=s,this.head=s):(this.head=s,this.tail=s),s.invokeOnEntryMarkedAsMostRecentlyUsed()}removeNodeFromList(s){s.prev!==null&&(s.prev.next=s.next),s.next!==null&&(s.next.prev=s.prev),this.head===s&&(this.head=s.next),this.tail===s&&(this.tail=s.prev),s.next=null,s.prev=null}removeNodeFromListAndLookupTable(s){return s.invokeOnEvicted(),this.removeNodeFromList(s),this.lookupTable.delete(s.key)}cleanCache(){if(!this.entryExpirationTimeInMS)return;const s=[];for(const i of this.lookupTable.values())i.isExpired&&s.push(i);s.forEach(i=>this.removeNodeFromListAndLookupTable(i))}};return LRUCache.LRUCache=t,LRUCache}var hasRequiredDist;function requireDist(){return hasRequiredDist||(hasRequiredDist=1,(function(n){var t=dist&&dist.__createBinding||(Object.create?(function(s,i,r,a){a===void 0&&(a=r);var o=Object.getOwnPropertyDescriptor(i,r);(!o||("get"in o?!i.__esModule:o.writable||o.configurable))&&(o={enumerable:!0,get:function(){return i[r]}}),Object.defineProperty(s,a,o)}):(function(s,i,r,a){a===void 0&&(a=r),s[a]=i[r]})),e=dist&&dist.__exportStar||function(s,i){for(var r in s)r!=="default"&&!Object.prototype.hasOwnProperty.call(i,r)&&t(i,s,r)};Object.defineProperty(n,"__esModule",{value:!0}),e(requireLRUCache(),n)})(dist)),dist}var distExports=requireDist(),bolt11,hasRequiredBolt11;function requireBolt11(){if(hasRequiredBolt11)return bolt11;hasRequiredBolt11=1;const{bech32:n,hex:t,utf8:e}=requireLib$1(),s={bech32:"bc",pubKeyHash:0,scriptHash:5,validWitnessVersions:[0]},i={bech32:"tb",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},r={bech32:"tbs",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},a={bech32:"bcrt",pubKeyHash:111,scriptHash:196,validWitnessVersions:[0]},o={bech32:"sb",pubKeyHash:63,scriptHash:123,validWitnessVersions:[0]},l=["option_data_loss_protect","initial_routing_sync","option_upfront_shutdown_script","gossip_queries","var_onion_optin","gossip_queries_ex","option_static_remotekey","payment_secret","basic_mpp","option_support_large_channel"],h={m:BigInt(1e3),u:BigInt(1e6),n:BigInt(1e9),p:BigInt(1e12)},u=BigInt("2100000000000000000"),f=BigInt(1e11),p={payment_hash:1,payment_secret:16,description:13,payee:19,description_hash:23,expiry:6,min_final_cltv_expiry:24,fallback_address:9,route_hint:3,feature_bits:5,metadata:27},g={};for(let y=0,v=Object.keys(p);y<v.length;y++){const k=v[y],R=p[v[y]].toString();g[R]=k}const m={1:y=>t.encode(n.fromWordsUnsafe(y)),16:y=>t.encode(n.fromWordsUnsafe(y)),13:y=>e.encode(n.fromWordsUnsafe(y)),19:y=>t.encode(n.fromWordsUnsafe(y)),23:y=>t.encode(n.fromWordsUnsafe(y)),27:y=>t.encode(n.fromWordsUnsafe(y)),6:b,24:b,3:E,5:$};function w(y){return v=>({tagCode:parseInt(y),words:n.encode("unknown",v,Number.MAX_SAFE_INTEGER)})}function b(y){return y.reverse().reduce((v,k,R)=>v+k*Math.pow(32,R),0)}function E(y){const v=[];let k,R,T,N,A,D=n.fromWordsUnsafe(y);for(;D.length>0;)k=t.encode(D.slice(0,33)),R=t.encode(D.slice(33,41)),T=parseInt(t.encode(D.slice(41,45)),16),N=parseInt(t.encode(D.slice(45,49)),16),A=parseInt(t.encode(D.slice(49,51)),16),D=D.slice(51),v.push({pubkey:k,short_channel_id:R,fee_base_msat:T,fee_proportional_millionths:N,cltv_expiry_delta:A});return v}function $(y){const v=y.slice().reverse().map(T=>[!!(T&1),!!(T&2),!!(T&4),!!(T&8),!!(T&16)]).reduce((T,N)=>T.concat(N),[]);for(;v.length<l.length*2;)v.push(!1);const k={};l.forEach((T,N)=>{let A;v[N*2]?A="required":v[N*2+1]?A="supported":A="unsupported",k[T]=A});const R=v.slice(l.length*2);return k.extra_bits={start_bit:l.length*2,bits:R,has_required:R.reduce((T,N,A)=>A%2!==0?T||!1:T||N,!1)},k}function _(y,v){let k,R;if(y.slice(-1).match(/^[munp]$/))k=y.slice(-1),R=y.slice(0,-1);else{if(y.slice(-1).match(/^[^munp0-9]$/))throw new Error("Not a valid multiplier for the amount");R=y}if(!R.match(/^\d+$/))throw new Error("Not a valid human readable amount");const T=BigInt(R),N=k?T*f/h[k]:T*f;if(k==="p"&&T%BigInt(10)!==BigInt(0)||N>u)throw new Error("Amount is outside of valid range");return v?N.toString():N}function S(y,v){if(typeof y!="string")throw new Error("Lightning Payment Request must be string");if(y.slice(0,2).toLowerCase()!=="ln")throw new Error("Not a proper lightning payment request");const k=[],R=n.decode(y,Number.MAX_SAFE_INTEGER);y=y.toLowerCase();const T=R.prefix;let N=R.words,A=y.slice(T.length+1),D=N.slice(-104);N=N.slice(0,-104);let C=T.match(/^ln(\S+?)(\d*)([a-zA-Z]?)$/);if(C&&!C[2]&&(C=T.match(/^ln(\S+)$/)),!C)throw new Error("Not a proper lightning payment request");k.push({name:"lightning_network",letters:"ln"});const I=C[1];let x;if(v){if(v.bech32===void 0||v.pubKeyHash===void 0||v.scriptHash===void 0||!Array.isArray(v.validWitnessVersions))throw new Error("Invalid network");x=v}else switch(I){case s.bech32:x=s;break;case i.bech32:x=i;break;case r.bech32:x=r;break;case a.bech32:x=a;break;case o.bech32:x=o;break}if(!x||x.bech32!==I)throw new Error("Unknown coin bech32 prefix");k.push({name:"coin_network",letters:I,value:x});const re=C[2];let _e;if(re){const P=C[3];_e=_(re+P,!0),k.push({name:"amount",letters:C[2]+C[3],value:_e})}else _e=null;k.push({name:"separator",letters:"1"});const Me=b(N.slice(0,7));N=N.slice(7),k.push({name:"timestamp",letters:A.slice(0,7),value:Me}),A=A.slice(7);let Ne,$e,ke,Ce;for(;N.length>0;){const P=N[0].toString();Ne=g[P]||"unknown_tag",$e=m[P]||w(P),N=N.slice(1),ke=b(N.slice(0,2)),N=N.slice(2),Ce=N.slice(0,ke),N=N.slice(ke),k.push({name:Ne,tag:A[0],letters:A.slice(0,3+ke),value:$e(Ce)}),A=A.slice(3+ke)}k.push({name:"signature",letters:A.slice(0,104),value:t.encode(n.fromWordsUnsafe(D))}),A=A.slice(104),k.push({name:"checksum",letters:A});let Ae={paymentRequest:y,sections:k,get expiry(){let P=k.find(we=>we.name==="expiry");if(P)return De("timestamp")+P.value},get route_hints(){return k.filter(P=>P.name==="route_hint").map(P=>P.value)}};for(let P in p)P!=="route_hint"&&Object.defineProperty(Ae,P,{get(){return De(P)}});return Ae;function De(P){let we=k.find(Le=>Le.name===P);return we?we.value:void 0}}return bolt11={decode:S,hrpToMillisat:_},bolt11}requireBolt11();var __defProp$1=Object.defineProperty,__getOwnPropDesc$1=Object.getOwnPropertyDescriptor,__getOwnPropNames$1=Object.getOwnPropertyNames,__hasOwnProp$1=Object.prototype.hasOwnProperty,__copyProps$1=(n,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of __getOwnPropNames$1(t))!__hasOwnProp$1.call(n,i)&&i!==e&&__defProp$1(n,i,{get:()=>t[i],enumerable:!(s=__getOwnPropDesc$1(t,i))||s.enumerable});return n},__reExport$1=(n,t,e)=>(__copyProps$1(n,t,"default"),e);function getRelaysForSync$1(n,t,e="write"){if(!n.outboxTracker)return;const s=n.outboxTracker.data.get(t);if(s)return e==="write"?s.writeRelays:s.readRelays}async function getWriteRelaysFor$1(n,t,e="write"){if(n.outboxTracker)return n.outboxTracker.data.has(t)||await n.outboxTracker.trackUsers([t]),getRelaysForSync$1(n,t,e)}function getTopRelaysForAuthors$1(n,t){const e=new Map;return t.forEach(i=>{const r=getRelaysForSync$1(n,i);r&&r.forEach(a=>{const o=e.get(a)||0;e.set(a,o+1)})}),Array.from(e.entries()).sort((i,r)=>r[1]-i[1]).map(i=>i[0])}function getAllRelaysForAllPubkeys$1(n,t,e="read"){const s=new Map,i=new Set;return t.forEach(r=>{const a=getRelaysForSync$1(n,r,e);a&&a.size>0?(a.forEach(o=>{(s.get(o)||new Set).add(r)}),s.set(r,a)):i.add(r)}),{pubkeysToRelays:s,authorsMissingRelays:i}}function chooseRelayCombinationForPubkeys$1(n,t,e,{count:s,preferredRelays:i}={}){s??(s=2),i??(i=new Set);const r=n.pool,a=r.connectedRelays();a.forEach(p=>{i==null||i.add(p.url)});const o=new Map,{pubkeysToRelays:l,authorsMissingRelays:h}=getAllRelaysForAllPubkeys$1(n,t,e),u=getTopRelaysForAuthors$1(n,t),f=(p,g)=>{const m=o.get(g)||[];m.push(p),o.set(g,m)};for(const[p,g]of l.entries()){let m=s;const w=new Set;for(const b of a)g.has(b.url)&&(f(p,b.url),w.add(b.url),m--);for(const b of g)w.has(b)||o.has(b)&&(f(p,b),w.add(b),m--);if(!(m<=0))for(const b of u){if(m<=0)break;w.has(b)||g.has(b)&&(f(p,b),w.add(b),m--)}}for(const p of h)r.permanentAndConnectedRelays().forEach(g=>{const m=o.get(g.url)||[];m.push(p),o.set(g.url,m)});return o}function getRelaysForFilterWithAuthors(n,t,e=2){return chooseRelayCombinationForPubkeys$1(n,t,"write",{count:e})}function tryNormalizeRelayUrl(n){try{return normalizeRelayUrl$1(n)}catch{return}}function normalizeRelayUrl$1(n){let t=normalizeUrl$1(n,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return t.endsWith("/")||(t+="/"),t}function normalize(n){const t=new Set;for(const e of n)try{t.add(normalizeRelayUrl$1(e))}catch{}return Array.from(t)}var DATA_URL_DEFAULT_MIME_TYPE$1="text/plain",DATA_URL_DEFAULT_CHARSET$1="us-ascii",testParameter$1=(n,t)=>t.some(e=>e instanceof RegExp?e.test(n):e===n),supportedProtocols$1=new Set(["https:","http:","file:"]),hasCustomProtocol$1=n=>{try{const{protocol:t}=new URL(n);return t.endsWith(":")&&!t.includes(".")&&!supportedProtocols$1.has(t)}catch{return!1}},normalizeDataURL$1=(n,{stripHash:t})=>{var f,p,g,m;const e=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(n);if(!e)throw new Error(`Invalid URL: ${n}`);const s=((f=e.groups)==null?void 0:f.type)??"",i=((p=e.groups)==null?void 0:p.data)??"";let r=((g=e.groups)==null?void 0:g.hash)??"";const a=s.split(";");r=t?"":r;let o=!1;a[a.length-1]==="base64"&&(a.pop(),o=!0);const l=((m=a.shift())==null?void 0:m.toLowerCase())??"",u=[...a.map(w=>{let[b,E=""]=w.split("=").map($=>$.trim());return b==="charset"&&(E=E.toLowerCase(),E===DATA_URL_DEFAULT_CHARSET$1)?"":`${b}${E?`=${E}`:""}`}).filter(Boolean)];return o&&u.push("base64"),(u.length>0||l&&l!==DATA_URL_DEFAULT_MIME_TYPE$1)&&u.unshift(l),`data:${u.join(";")},${o?i.trim():i}${r?`#${r}`:""}`};function normalizeUrl$1(n,t={}){if(t={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...t},typeof t.defaultProtocol=="string"&&!t.defaultProtocol.endsWith(":")&&(t.defaultProtocol=`${t.defaultProtocol}:`),n=n.trim(),/^data:/i.test(n))return normalizeDataURL$1(n,t);if(hasCustomProtocol$1(n))return n;const e=n.startsWith("//");!e&&/^\.*\//.test(n)||(n=n.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,t.defaultProtocol));const i=new URL(n);if(i.hostname=i.hostname.toLowerCase(),t.forceHttp&&t.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(t.forceHttp&&i.protocol==="https:"&&(i.protocol="http:"),t.forceHttps&&i.protocol==="http:"&&(i.protocol="https:"),t.stripAuthentication&&(i.username="",i.password=""),t.stripHash?i.hash="":t.stripTextFragment&&(i.hash=i.hash.replace(/#?:~:text.*?$/i,"")),i.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let o=0,l="";for(;;){const u=a.exec(i.pathname);if(!u)break;const f=u[0],p=u.index,g=i.pathname.slice(o,p);l+=g.replace(/\/{2,}/g,"/"),l+=f,o=p+f.length}const h=i.pathname.slice(o,i.pathname.length);l+=h.replace(/\/{2,}/g,"/"),i.pathname=l}if(i.pathname)try{i.pathname=decodeURI(i.pathname)}catch{}if(t.removeDirectoryIndex===!0&&(t.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(t.removeDirectoryIndex)&&t.removeDirectoryIndex.length>0){let a=i.pathname.split("/");const o=a[a.length-1];testParameter$1(o,t.removeDirectoryIndex)&&(a=a.slice(0,-1),i.pathname=`${a.slice(1).join("/")}/`)}if(i.hostname&&(i.hostname=i.hostname.replace(/\.$/,""),t.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(i.hostname)&&(i.hostname=i.hostname.replace(/^www\./,""))),Array.isArray(t.removeQueryParameters))for(const a of[...i.searchParams.keys()])testParameter$1(a,t.removeQueryParameters)&&i.searchParams.delete(a);if(!Array.isArray(t.keepQueryParameters)&&t.removeQueryParameters===!0&&(i.search=""),Array.isArray(t.keepQueryParameters)&&t.keepQueryParameters.length>0)for(const a of[...i.searchParams.keys()])testParameter$1(a,t.keepQueryParameters)||i.searchParams.delete(a);if(t.sortQueryParameters){i.searchParams.sort();try{i.search=decodeURIComponent(i.search)}catch{}}t.removeTrailingSlash&&(i.pathname=i.pathname.replace(/\/$/,"")),t.removeExplicitPort&&i.port&&(i.port="");const r=n;return n=i.toString(),!t.removeSingleSlash&&i.pathname==="/"&&!r.endsWith("/")&&i.hash===""&&(n=n.replace(/\/$/,"")),(t.removeTrailingSlash||i.pathname==="/")&&i.hash===""&&t.removeSingleSlash&&(n=n.replace(/\/$/,"")),e&&!t.normalizeProtocol&&(n=n.replace(/^http:\/\//,"//")),t.stripProtocol&&(n=n.replace(/^(?:https?:)?\/\//,"")),n}var NDKRelayKeepalive$1=class{constructor(t=3e4,e){c(this,"lastActivity",Date.now());c(this,"timer");c(this,"timeout");c(this,"isRunning",!1);this.onSilenceDetected=e,this.timeout=t}recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const t=Date.now()-this.lastActivity;if(t>=this.timeout)this.onSilenceDetected();else{const e=this.timeout-t;this.timer=setTimeout(()=>{this.onSilenceDetected()},e)}},this.timeout)}};async function probeRelayConnection$1(n){const t=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(e=>{let s=!1;const i=setTimeout(()=>{s||(s=!0,n.send(["CLOSE",t]),e(!1))},5e3),r=()=>{s||(s=!0,clearTimeout(i),n.send(["CLOSE",t]),e(!0))};n.once("message",r),n.send(["REQ",t,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS$1=5,FLAPPING_THRESHOLD_MS$1=1e3,NDKRelayConnectivity$1=class{constructor(t,e){c(this,"ndkRelay");c(this,"ws");c(this,"_status");c(this,"timeoutMs");c(this,"connectedAt");c(this,"_connectionStats",{attempts:0,success:0,durations:[]});c(this,"debug");c(this,"netDebug");c(this,"connectTimeout");c(this,"reconnectTimeout");c(this,"ndk");c(this,"openSubs",new Map);c(this,"openCountRequests",new Map);c(this,"openEventPublishes",new Map);c(this,"pendingAuthPublishes",new Map);c(this,"serial",0);c(this,"baseEoseTimeout",4400);c(this,"keepalive");c(this,"wsStateMonitor");c(this,"sleepDetector");c(this,"lastSleepCheck",Date.now());c(this,"lastMessageSent",Date.now());c(this,"wasIdle",!1);c(this,"updateConnectionStats",{connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}});this.ndkRelay=t,this._status=1;const s=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${s}`),this.ndk=e,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive$1(12e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection$1({send:e=>this.send(JSON.stringify(e)),once:(e,s)=>{var r;const i=a=>{var o;try{const l=JSON.parse(a.data);(l[0]==="EOSE"||l[0]==="EVENT"||l[0]==="NOTICE")&&(s(),(o=this.ws)==null||o.removeEventListener("message",i))}catch{}};(r=this.ws)==null||r.addEventListener("message",i)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const t=Date.now(),e=t-this.lastSleepCheck;e>15e3&&(this.debug(`Detected possible sleep/wake (${e}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=t},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection$1({send:t=>this.send(JSON.stringify(t)),once:(t,e)=>{var i;const s=r=>{var a;try{const o=JSON.parse(r.data);(o[0]==="EOSE"||o[0]==="EVENT"||o[0]==="NOTICE")&&(e(),(a=this.ws)==null||a.removeEventListener("message",s))}catch{}};(i=this.ws)==null||i.addEventListener("message",s)}}).then(t=>{t||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(t,e=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),t??(t=this.timeoutMs),!this.timeoutMs&&t&&(this.timeoutMs=t),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(e),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(s){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,s),this._status=1,e?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2880*60*1e3),s}}disconnect(){var t,e;this._status=0,(t=this.keepalive)==null||t.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{(e=this.ws)==null||e.close()}catch(s){this.debug("Failed to disconnect",s),this._status=1}}onConnectionError(t){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),t&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){var t,e;(t=this.netDebug)==null||t.call(this,"connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,(e=this.keepalive)==null||e.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){var t,e;(t=this.netDebug)==null||t.call(this,"disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),(e=this.keepalive)==null||e.stop(),this.clearPendingPublishes(new Error(`Relay ${this.ndkRelay.url} disconnected`)),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(t){var e,s;(e=this.netDebug)==null||e.call(this,t.data,this.ndkRelay,"recv"),(s=this.keepalive)==null||s.recordActivity();try{const i=JSON.parse(t.data),[r,a,...o]=i,l=this.ndkRelay.getProtocolHandler(r);if(l){l(this.ndkRelay,i);return}switch(r){case"EVENT":{const h=this.openSubs.get(a),u=i[2];if(!h){this.debug(`Received event for unknown subscription ${a}`);return}h.onevent(u);return}case"COUNT":{const h=i[2],u=this.openCountRequests.get(a);u&&(u.resolve(h.count),this.openCountRequests.delete(a));return}case"EOSE":{const h=this.openSubs.get(a);if(!h)return;h.oneose(a);return}case"OK":{const h=i[2],u=i[3],f=this.openEventPublishes.get(a),p=f==null?void 0:f.pop();if(!f||!p){this.debug("Received OK for unknown event publish",a);return}h?(p.resolve(u),this.pendingAuthPublishes.delete(a)):u&&(u.toLowerCase().includes("auth-required")||u.toLowerCase().includes("not authorized")||u.toLowerCase().includes("blocked: not authorized"))?this.pendingAuthPublishes.get(a)?(this.debug("Publish failed due to auth-required, will retry after auth",a),f.push(p),this.openEventPublishes.set(a,f)):p.reject(new Error(u)):(p.reject(new Error(u)),this.pendingAuthPublishes.delete(a)),f.length===0?this.openEventPublishes.delete(a):!h&&!(u!=null&&u.toLowerCase().includes("auth-required")||u!=null&&u.toLowerCase().includes("not authorized")||u!=null&&u.toLowerCase().includes("blocked: not authorized"))&&this.openEventPublishes.set(a,f);return}case"CLOSED":{const h=this.openSubs.get(a);if(!h)return;h.onclosed(i[2]);return}case"NOTICE":this.onNotice(i[1]);return;case"AUTH":{this.onAuthRequested(i[1]);return}}}catch(i){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${i.message}`,i==null?void 0:i.stack);return}}async onAuthRequested(t){var s,i,r;const e=this.ndkRelay.authPolicy??((s=this.ndk)==null?void 0:s.relayAuthDefaultPolicy);if(this.debug("Relay requested authentication",{havePolicy:!!e}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,e){if(this._status>=5){this._status=7;let a;try{a=await e(this.ndkRelay,t)}catch(o){this.debug("Authentication policy threw an error",o),a=!1}if(this.debug("Authentication policy returned",!!a),a instanceof NDKEvent$1||a===!0){a instanceof NDKEvent$1&&await this.auth(a);const o=async()=>{if(this._status>=5&&this._status<8){const l=new NDKEvent$1(this.ndk);l.kind=22242,l.tags=[["relay",this.ndkRelay.url],["challenge",t]],await l.sign(),this.auth(l).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful"),this.retryPendingAuthPublishes()}).catch(h=>{this._status=6,this.ndkRelay.emit("auth:failed",h),this.debug("Authentication failed",h),this.rejectPendingAuthPublishes(h)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};a===!0&&((i=this.ndk)!=null&&i.signer?o().catch(l=>{console.error("Error authenticating",l)}):(this.debug("No signer available for authentication localhost"),(r=this.ndk)==null||r.once("signer:ready",o))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",t)}onError(t){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,t)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const t=this._connectionStats.durations;if(t.length%3!==0)return!1;const s=t.reduce((o,l)=>o+l,0)/t.length,i=t.map(o=>(o-s)**2).reduce((o,l)=>o+l,0)/t.length;return Math.sqrt(i)<FLAPPING_THRESHOLD_MS$1}async onNotice(t){this.ndkRelay.emit("notice",t)}handleReconnection(t=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let e;if(this.wasIdle){const s=[0,1e3,2e3,5e3,1e4,3e4];e=s[Math.min(t,s.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${t}, delay ${e}ms`)}else this.connectedAt?e=Math.max(0,6e4-(Date.now()-this.connectedAt)):(e=Math.min(1e3*2**t,3e4),this.debug(`Using standard backoff, attempt ${t}, delay ${e}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(s=>{t<MAX_RECONNECT_ATTEMPTS$1?this.handleReconnection(t+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},e),this.ndkRelay.emit("delayed-connect",e),this.debug("Reconnecting in",e),this._connectionStats.nextReconnectAt=Date.now()+e}async send(t){var s,i,r,a,o;Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&((s=this.ws)==null?void 0:s.readyState)===WebSocket.OPEN?((i=this.ws)==null||i.send(t),(r=this.netDebug)==null||r.call(this,t,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${t}`,this._status),this._status>=5&&((a=this.ws)==null?void 0:a.readyState)!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${(o=this.ws)==null?void 0:o.readyState}`),this.handleStaleConnection()))}async auth(t){const e=new Promise((s,i)=>{const r=this.openEventPublishes.get(t.id)??[];r.push({resolve:s,reject:i}),this.openEventPublishes.set(t.id,r)});return this.send(`["AUTH",${JSON.stringify(t.rawEvent())}]`),e}clearPendingPublishes(t){this.rejectPendingAuthPublishes(t);for(const[e,s]of this.openEventPublishes.entries()){for(;s.length>0;){const i=s.shift();i&&i.reject(t)}this.openEventPublishes.delete(e)}}retryPendingAuthPublishes(){if(this.pendingAuthPublishes.size!==0){this.debug(`Retrying ${this.pendingAuthPublishes.size} pending publishes after auth`);for(const[t,e]of this.pendingAuthPublishes.entries())this.debug(`Retrying publish for event ${t}`),this.send(`["EVENT",${JSON.stringify(e)}]`);this.pendingAuthPublishes.clear()}}rejectPendingAuthPublishes(t){if(this.pendingAuthPublishes.size!==0){this.debug(`Rejecting ${this.pendingAuthPublishes.size} pending publishes due to auth failure`);for(const[e]of this.pendingAuthPublishes.entries()){const s=this.openEventPublishes.get(e);if(s&&s.length>0){const i=s.pop();i&&i.reject(new Error(`Authentication failed: ${t.message}`)),s.length===0&&this.openEventPublishes.delete(e)}}this.pendingAuthPublishes.clear()}}async publish(t){const e=new Promise((s,i)=>{const r=this.openEventPublishes.get(t.id)??[];r.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${t.id} twice`),r.push({resolve:s,reject:i}),this.openEventPublishes.set(t.id,r)});return this.pendingAuthPublishes.set(t.id,t),this.send(`["EVENT",${JSON.stringify(t)}]`),e}async count(t,e){this.serial++;const s=(e==null?void 0:e.id)||`count:${this.serial}`,i=new Promise((r,a)=>{this.openCountRequests.set(s,{resolve:r,reject:a})});return this.send(`["COUNT","${s}",${JSON.stringify(t).substring(1)}`),i}close(t,e){this.send(`["CLOSE","${t}"]`);const s=this.openSubs.get(t);this.openSubs.delete(t),s&&s.onclose(e)}req(t){`${this.send(`["REQ","${t.subId}",${JSON.stringify(t.executeFilters).substring(1)}`)}`,this.openSubs.set(t.subId,t)}get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){var t;return this._status>=5&&((t=this.ws)==null?void 0:t.readyState)===WebSocket.OPEN}};async function fetchRelayInformation(n){const t=n.replace(/^wss:\/\//,"https://").replace(/^ws:\/\//,"http://"),e=await fetch(t,{headers:{Accept:"application/nostr+json"}});if(!e.ok)throw new Error(`Failed to fetch relay information: ${e.status} ${e.statusText}`);return await e.json()}var NDKRelayPublisher$1=class{constructor(t){c(this,"ndkRelay");c(this,"debug");this.ndkRelay=t,this.debug=t.debug.extend("publisher")}async publish(t,e=2500){let s;const i=()=>new Promise((f,p)=>{try{this.publishEvent(t).then(g=>{this.ndkRelay.emit("published",t),t.emit("relay:published",this.ndkRelay),f(!0)}).catch(p)}catch(g){p(g)}}),r=new Promise((f,p)=>{s=setTimeout(()=>{s=void 0,p(new Error(`Timeout: ${e}ms`))},e)}),a=()=>{i().then(f=>o(f)).catch(f=>l(f))};let o,l;const h=f=>{throw this.ndkRelay.debug("Publish failed",f,t.id),this.ndkRelay.emit("publish:failed",t,f),t.emit("relay:publish:failed",this.ndkRelay,f),f},u=()=>{s&&clearTimeout(s),this.ndkRelay.removeListener("connect",a)};return this.ndkRelay.status>=5?Promise.race([i(),r]).catch(h).finally(u):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((f,p)=>{o=f,l=p,this.ndkRelay.on("connect",a)}),r]).catch(h).finally(u))}async publishEvent(t){return this.ndkRelay.connectivity.publish(t.rawEvent())}};function filterFingerprint$1(n,t){const e=[];for(const i of n){const r=Object.entries(i||{}).map(([a,o])=>["since","until"].includes(a)?`${a}:${o}`:a).sort().join("-");e.push(r)}let s=t?"+":"";return s+=e.join("|"),s}function mergeFilters$1(n){const t=[],e={};return n.filter(s=>!!s.limit).forEach(s=>t.push(s)),n=n.filter(s=>!s.limit),n.length===0?t:(n.forEach(s=>{Object.entries(s).forEach(([i,r])=>{Array.isArray(r)?e[i]===void 0?e[i]=[...r]:e[i]=Array.from(new Set([...e[i],...r])):e[i]=r})}),[...t,e])}var MAX_ITEMS=3;function formatArray(n,t){const s=(t?n.slice(0,MAX_ITEMS).map(t):n.slice(0,MAX_ITEMS)).join(",");return n.length>MAX_ITEMS?`${s}+${n.length-MAX_ITEMS}`:s}function formatFilters(n){return n.map(t=>{var s,i,r;const e=[];(s=t.ids)!=null&&s.length&&e.push(`ids:[${formatArray(t.ids,a=>String(a).slice(0,8))}]`),(i=t.kinds)!=null&&i.length&&e.push(`kinds:[${formatArray(t.kinds)}]`),(r=t.authors)!=null&&r.length&&e.push(`authors:[${formatArray(t.authors,a=>String(a).slice(0,8))}]`),t.since&&e.push(`since:${t.since}`),t.until&&e.push(`until:${t.until}`),t.limit&&e.push(`limit:${t.limit}`),t.search&&e.push(`search:"${String(t.search).slice(0,20)}"`);for(const[a,o]of Object.entries(t))a.startsWith("#")&&Array.isArray(o)&&o.length>0&&e.push(`${a}:[${formatArray(o,l=>String(l).slice(0,8))}]`);return`{${e.join(" ")}}`}).join(", ")}var NDKRelaySubscription$1=class{constructor(t,e,s){c(this,"fingerprint");c(this,"items",new Map);c(this,"topSubManager");c(this,"debug");c(this,"status",0);c(this,"onClose");c(this,"relay");c(this,"eosed",!1);c(this,"executionTimer");c(this,"fireTime");c(this,"delayType");c(this,"executeFilters");c(this,"id",Math.random().toString(36).substring(7));c(this,"_subId");c(this,"subIdParts",new Set);c(this,"executeOnRelayReady",()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size,filters:formatFilters(this.compileFilters())}),this.status=1,this.execute()}});c(this,"reExecuteAfterAuth",(()=>{const t=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:t}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",t,this.subId)}).bind(this));this.relay=t,this.topSubManager=s,this.debug=t.debug.extend(`sub[${this.id}]`),this.fingerprint=e||Math.random().toString(36).substring(7)}get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}addSubIdPart(t){this.subIdParts.add(t)}addItem(t,e){if(this.debug("Adding item",{filters:formatFilters(e),internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,itemsSize:this.items.size}),!this.items.has(t.internalId))switch(t.on("close",this.removeItem.bind(this,t)),this.items.set(t.internalId,{subscription:t,filters:e}),this.status!==3&&t.subId&&(!this._subId||this._subId.length<25)&&(this.status===0||this.status===1)&&this.addSubIdPart(t.subId),this.status){case 0:this.evaluateExecutionPlan(t);break;case 3:break;case 1:this.evaluateExecutionPlan(t);break;case 4:throw this.debug("Subscription is closed, cannot add new items",{filters:formatFilters(e),subId:t.subId,internalId:t.internalId}),new Error("Cannot add new items to a closed subscription")}}removeItem(t){if(this.items.delete(t.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const t=this.status;if(this.status=4,t===3)try{this.relay.close(this.subId)}catch(e){this.debug("Error closing subscription",e,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:t,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(t){if(!t.isGroupable()){this.status=1,this.execute();return}if(t.filters.find(i=>!!i.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const e=t.groupableDelay,s=t.groupableDelayType;if(!e)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(e,s);else{const i=this.delayType,r=this.fireTime-Date.now();if(i==="at-least"&&s==="at-least")r<e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if(i==="at-least"&&s==="at-most")r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if(i==="at-most"&&s==="at-most")r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else if(i==="at-most"&&s==="at-least")r>e&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(e,s));else throw new Error(`Unknown delay type combination ${i} ${s}`)}}schedule(t,e){this.status=1;const s=Date.now();this.fireTime=s+t,this.delayType=e;const i=setTimeout(this.execute.bind(this),t);e==="at-least"&&(this.executionTimer=i)}finalizeSubId(){if(this.subIdParts.size>0){let e=Array.from(this.subIdParts).map(s=>s.substring(0,10)).join("-");e.length>20&&(e=e.substring(0,20)),this._subId=e}else this._subId=this.fingerprint.slice(0,15);this._subId+=`-${Math.random().toString(36).substring(2,7)}`}execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(t){this.topSubManager.dispatchEvent(t,this.relay)}oneose(t){if(this.eosed=!0,t!==this.subId){this.debug("Received EOSE for an abandoned subscription",t,this.subId),this.relay.close(t);return}this.items.size===0&&this.close();for(const{subscription:e}of this.items.values())e.eoseReceived(this.relay),e.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:formatFilters(e.filters),internalId:e.internalId,status:this.status,fingerprint:this.fingerprint,itemsSize:this.items.size}),this.removeItem(e))}onclose(t){this.status=4}onclosed(t){if(t)for(const{subscription:e}of this.items.values())e.closedReceived(this.relay,t)}compileFilters(){const t=[],e=Array.from(this.items.values()).map(i=>i.filters);if(!e[0])return this.debug(" No filters to merge",{itemsSize:this.items.size}),[];const s=e[0].length;for(let i=0;i<s;i++){const r=e.map(o=>o[i]),a=mergeFilters$1(r);t.push(...a)}return t}},NDKRelaySubscriptionManager$1=class{constructor(t,e){c(this,"relay");c(this,"subscriptions");c(this,"generalSubManager");this.relay=t,this.subscriptions=new Map,this.generalSubManager=e}addSubscription(t,e){let s;if(!t.isGroupable())s=this.createSubscription(t,e);else{const i=filterFingerprint$1(e,t.closeOnEose);i&&(s=(this.subscriptions.get(i)||[]).find(a=>a.status<3)),s??(s=this.createSubscription(t,e,i))}s.addItem(t,e)}createSubscription(t,e,s){const i=new NDKRelaySubscription$1(this.relay,s||null,this.generalSubManager);i.onClose=this.onRelaySubscriptionClose.bind(this);const r=this.subscriptions.get(i.fingerprint)??[];return this.subscriptions.set(i.fingerprint,[...r,i]),i}onRelaySubscriptionClose(t){let e=this.subscriptions.get(t.fingerprint)??[];e?e.length===1?this.subscriptions.delete(t.fingerprint):(e=e.filter(s=>s.id!==t.id),this.subscriptions.set(t.fingerprint,e)):console.warn("Unexpectedly did not find a subscription with fingerprint",t.fingerprint)}},ce,NDKRelay$1=(ce=class extends libExports.EventEmitter{constructor(e,s,i){super();c(this,"url");c(this,"scores");c(this,"connectivity");c(this,"subs");c(this,"publisher");c(this,"authPolicy");c(this,"protocolHandlers",new Map);c(this,"_relayInfo");c(this,"lowestValidationRatio");c(this,"targetValidationRatio");c(this,"validationRatioFn");c(this,"validatedEventCount",0);c(this,"nonValidatedEventCount",0);c(this,"trusted",!1);c(this,"complaining",!1);c(this,"debug");c(this,"req");c(this,"close");this.url=normalizeRelayUrl$1(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity$1(this,i),this.connectivity.netDebug=i==null?void 0:i.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager$1(this,i.subManager),this.publisher=new NDKRelayPublisher$1(this),this.authPolicy=s,this.targetValidationRatio=i==null?void 0:i.initialValidationRatio,this.lowestValidationRatio=i==null?void 0:i.lowestValidationRatio,this.validationRatioFn=((i==null?void 0:i.validationRatioFn)??ce.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),i||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,s=!0){return this.connectivity.connect(e,s)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,s){this.subs.addSubscription(e,s)}async publish(e,s=2500){return this.publisher.publish(e,s)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}registerProtocolHandler(e,s){this.protocolHandlers.set(e,s)}unregisterProtocolHandler(e){this.protocolHandlers.delete(e)}getProtocolHandler(e){return this.protocolHandlers.get(e)}async fetchInfo(e=!1){var r,a;const i=this.connectivity.ndk;if(!e&&((r=i==null?void 0:i.cacheAdapter)!=null&&r.getRelayStatus)){const o=await i.cacheAdapter.getRelayStatus(this.url);if(o!=null&&o.nip11&&Date.now()-o.nip11.fetchedAt<864e5)return this._relayInfo=o.nip11.data,o.nip11.data}return!e&&this._relayInfo?this._relayInfo:(this._relayInfo=await fetchRelayInformation(this.url),(a=i==null?void 0:i.cacheAdapter)!=null&&a.updateRelayStatus&&await i.cacheAdapter.updateRelayStatus(this.url,{nip11:{data:this._relayInfo,fetchedAt:Date.now()}}),this._relayInfo)}get info(){return this._relayInfo}},c(ce,"defaultValidationRatioUpdateFn",(e,s,i)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let r=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const a=s/100;r=Math.max(e.lowestValidationRatio,e.validationRatio-a)}return r<e.validationRatio?r:e.validationRatio}),ce),NDKPublishError$1=class extends Error{constructor(e,s,i,r){super(e);c(this,"errors");c(this,"publishedToRelays");c(this,"intendedRelaySet");this.errors=s,this.publishedToRelays=i,this.intendedRelaySet=r}get relayErrors(){const e=[];for(const[s,i]of this.errors)e.push(`${s.url}: ${i}`);return e.join(`
`)}},NDKRelaySet$1=class Pe{constructor(t,e,s){c(this,"relays");c(this,"debug");c(this,"ndk");c(this,"pool");this.relays=t,this.ndk=e,this.pool=s??e.pool,this.debug=e.debug.extend("relayset")}addRelay(t){this.relays.add(t)}get relayUrls(){return Array.from(this.relays).map(t=>t.url)}static fromRelayUrls(t,e,s=!0,i){if(i=i??e.pool,!i)throw new Error("No pool provided");const r=new Set;for(const a of t){const o=i.relays.get(normalizeRelayUrl$1(a));if(o)o.status<5&&s&&o.connect(),r.add(o);else{const l=new NDKRelay$1(normalizeRelayUrl$1(a),e==null?void 0:e.relayAuthDefaultPolicy,e);i.useTemporaryRelay(l,void 0,`requested from fromRelayUrls ${t}`),r.add(l)}}return new Pe(new Set(r),e,i)}async publish(t,e,s=1){var l;const i=new Set,r=new Map,a=t.isEphemeral();t.publishStatus="pending";const o=h=>{i.add(h)};t.on("relay:published",o);try{const h=Array.from(this.relays).map(u=>new Promise(f=>{const p=e?setTimeout(()=>{i.has(u)||(r.set(u,new Error(`Publish timeout after ${e}ms`)),f(!1))},e):null;u.publish(t,e).then(g=>{p&&clearTimeout(p),g?(i.add(u),f(!0)):f(!1)}).catch(g=>{p&&clearTimeout(p),a||r.set(u,g),f(!1)})}));if(await Promise.all(h),i.size<s){if(!a){const u=new NDKPublishError$1("Not enough relays received the event ("+i.size+" published, "+s+" required)",r,i,this);throw t.publishStatus="error",t.publishError=u,(l=this.ndk)==null||l.emit("event:publish-failed",t,u,this.relayUrls),u}}else t.publishStatus="success",t.emit("published",{relaySet:this,publishedToRelays:i});return i}finally{t.off("relay:published",o)}}get size(){return this.relays.size}},d$2=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent$1(n,t,e){var o,l;const s=new Set,i=await getWriteRelaysFor$1(n,t.pubkey);i&&i.forEach(h=>{var f;const u=(f=n.pool)==null?void 0:f.getRelay(h);u&&s.add(u)});let r=t.tags.filter(h=>["a","e"].includes(h[0])).map(h=>h[2]).filter(h=>h==null?void 0:h.startsWith("wss://")).filter(h=>{try{return new URL(h),!0}catch{return!1}}).map(h=>normalizeRelayUrl$1(h));r=Array.from(new Set(r)).slice(0,5),r.forEach(h=>{var f;const u=(f=n.pool)==null?void 0:f.getRelay(h,!0,!0);u&&(d$2("Adding relay hint %s",h),s.add(u))});const a=t.getMatchingTags("p").map(h=>h[1]);if(a.length<5?Array.from(chooseRelayCombinationForPubkeys$1(n,a,"read",{preferredRelays:new Set(i)}).keys()).forEach(u=>{var p;const f=(p=n.pool)==null?void 0:p.getRelay(u,!1,!0);f&&(d$2("Adding p-tagged relay %s",u),s.add(f))}):d$2("Too many p-tags to consider %d",a.length),(o=n.pool)==null||o.permanentAndConnectedRelays().forEach(h=>s.add(h)),e&&s.size<e){const h=(l=n.explicitRelayUrls)==null?void 0:l.filter(u=>!Array.from(s).some(f=>f.url===u)).slice(0,e-s.size);h==null||h.forEach(u=>{var p;const f=(p=n.pool)==null?void 0:p.getRelay(u,!1,!0);f&&(d$2("Adding explicit relay %s",u),s.add(f))})}return new NDKRelaySet$1(s,n)}function calculateRelaySetsFromFilter(n,t,e,s){const i=new Map,r=new Set;if(t.forEach(a=>{a.authors&&a.authors.forEach(o=>r.add(o))}),r.size>0){const a=getRelaysForFilterWithAuthors(n,Array.from(r),s);for(const o of a.keys())i.set(o,[]);for(const o of t)if(o.authors)for(const[l,h]of a.entries()){const u=o.authors.filter(f=>h.includes(f));i.set(l,[...i.get(l),{...o,authors:u}])}else for(const l of a.keys())i.set(l,[...i.get(l),o])}else n.explicitRelayUrls&&n.explicitRelayUrls.forEach(a=>{i.set(a,t)});return i.size===0&&e.permanentAndConnectedRelays().slice(0,5).forEach(a=>{i.set(a.url,t)}),i}function calculateRelaySetsFromFilters(n,t,e,s){return calculateRelaySetsFromFilter(n,t,e,s)}function isValidHex64(n){if(typeof n!="string"||n.length!==64)return!1;for(let t=0;t<64;t++){const e=n.charCodeAt(t);if(!(e>=48&&e<=57||e>=97&&e<=102||e>=65&&e<=70))return!1}return!0}function isValidPubkey(n){return isValidHex64(n)}function isValidNip05(n){if(typeof n!="string")return!1;for(let t=0;t<n.length;t++)if(n.charCodeAt(t)===46)return!0;return!1}function mergeTags$1(n,t){const e=new Map,s=a=>a.join(","),i=(a,o)=>a.every((l,h)=>l===o[h]),r=a=>{for(const[o,l]of e)if(i(l,a)||i(a,l)){a.length>=l.length&&e.set(o,a);return}e.set(s(a),a)};return n.concat(t).forEach(r),Array.from(e.values())}var hashtagRegex$1=new RegExp(`(?<=\\s|^)(#[^\\s!@#$%^&*()=+./,[{\\]};:'"?><]+)`,"g");function generateHashtags$1(n){const t=n.match(hashtagRegex$1),e=new Set,s=new Set;if(t)for(const i of t)e.has(i.slice(1))||(s.add(i.slice(1)),e.add(i.slice(1)));return Array.from(s)}async function generateContentTags$1(n,t=[],e,s){var o,l;if(e!=null&&e.skipContentTagging)return{content:n,tags:t};const i=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,r=[],a=h=>{t.find(u=>["q",h[0]].includes(u[0])&&u[1]===h[1])||t.push(h)};if(n=n.replace(i,h=>{var u;try{const f=h.split(/(@|nostr:)/)[2],{type:p,data:g}=nip19_exports$2.decode(f);let m;if(e!=null&&e.filters){const w=!e.filters.includeTypes||e.filters.includeTypes.includes(p),b=(u=e.filters.excludeTypes)==null?void 0:u.includes(p);if(!w||b)return h}switch(p){case"npub":(e==null?void 0:e.pTags)!==!1&&(m=["p",g]);break;case"nprofile":(e==null?void 0:e.pTags)!==!1&&(m=["p",g.pubkey]);break;case"note":r.push(new Promise(async w=>{const b=await maybeGetEventRelayUrl$1(f);a(["q",g,b]),w()}));break;case"nevent":r.push(new Promise(async w=>{const{id:b,author:E}=g;let{relays:$}=g;(!$||$.length===0)&&($=[await maybeGetEventRelayUrl$1(f)]),a(["q",b,$[0]]),E&&(e==null?void 0:e.pTags)!==!1&&(e==null?void 0:e.pTagOnQTags)!==!1&&a(["p",E]),w()}));break;case"naddr":r.push(new Promise(async w=>{const b=[g.kind,g.pubkey,g.identifier].join(":");let E=g.relays??[];E.length===0&&(E=[await maybeGetEventRelayUrl$1(f)]),a(["q",b,E[0]]),(e==null?void 0:e.pTags)!==!1&&(e==null?void 0:e.pTagOnQTags)!==!1&&(e==null?void 0:e.pTagOnATags)!==!1&&a(["p",g.pubkey]),w()}));break;default:return h}return m&&a(m),`nostr:${f}`}catch{return h}}),await Promise.all(r),!((l=(o=e==null?void 0:e.filters)==null?void 0:o.excludeTypes)!=null&&l.includes("hashtag"))){const h=generateHashtags$1(n).map(u=>["t",u]);t=mergeTags$1(t,h)}if((e==null?void 0:e.pTags)!==!1&&(e!=null&&e.copyPTagsFromTarget)&&s){const h=s.getMatchingTags("p");for(const u of h)!u[1]||!isValidPubkey(u[1])||t.find(f=>f[0]==="p"&&f[1]===u[1])||t.push(u)}return{content:n,tags:t}}async function maybeGetEventRelayUrl$1(n){return""}async function encrypt$1(n,t,e="nip44"){let s;if(!this.ndk)throw new Error("No NDK instance found!");let i=t;if(i||(this.ndk.assertSigner(),i=this.ndk.signer),!i)throw new Error("no NDK signer");const r=n||(()=>{const a=this.getMatchingTags("p");if(a.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:a[0][1]})})();if(e==="nip44"&&await isEncryptionEnabled$1(i,"nip44")&&(s=await i.encrypt(r,this.content,"nip44")),(!s||e==="nip04")&&await isEncryptionEnabled$1(i,"nip04")&&(s=await i.encrypt(r,this.content,"nip04")),!s)throw new Error("Failed to encrypt event.");this.content=s}async function decrypt$1(n,t,e){var o,l,h,u;if((l=(o=this.ndk)==null?void 0:o.cacheAdapter)!=null&&l.getDecryptedEvent){const f=await this.ndk.cacheAdapter.getDecryptedEvent(this.id);if(f){this.content=f.content;return}}let s;if(!this.ndk)throw new Error("No NDK instance found!");let i=t;if(i||(this.ndk.assertSigner(),i=this.ndk.signer),!i)throw new Error("no NDK signer");const r=n||this.author;if(!r)throw new Error("No sender provided and no author available");const a=e||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((a==="nip04"||this.kind===4)&&await isEncryptionEnabled$1(i,"nip04")&&this.content.search("\\?iv=")&&(s=await i.decrypt(r,this.content,"nip04")),!s&&a==="nip44"&&await isEncryptionEnabled$1(i,"nip44")&&(s=await i.decrypt(r,this.content,"nip44")),!s)throw new Error("Failed to decrypt event.");this.content=s,(u=(h=this.ndk)==null?void 0:h.cacheAdapter)!=null&&u.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this.id,this)}async function isEncryptionEnabled$1(n,t){return n.encryptionEnabled?t?!!await n.encryptionEnabled(t):!0:!1}function eventHasETagMarkers$1(n){for(const t of n.tags)if(t[0]==="e"&&(t[3]??"").length>0)return!0;return!1}function getRootTag$1(n,t){t??(t=n.tagType());const e=n.tags.find(isTagRootTag$1);if(!e){if(eventHasETagMarkers$1(n))return;const s=n.getMatchingTags(t);if(s.length<3)return s[0]}return e}var nip22RootTags$1=new Set(["A","E","I"]),nip22ReplyTags$1=new Set(["a","e","i"]);function getReplyTag$1(n,t){if(n.kind===1111){let i;for(const r of n.tags)if(nip22RootTags$1.has(r[0]))i=r;else if(nip22ReplyTags$1.has(r[0])){i=r;break}return i}t??(t=n.tagType());let e=!1,s;for(const i of n.tags)if(i[0]===t){if((i[3]??"").length>0&&(e=!0),e&&i[3]==="reply")return i;e&&i[3]==="root"&&(s=i),e||(s=i)}return s}function isTagRootTag$1(n){return n[0]==="E"||n[3]==="root"}async function fetchTaggedEvent$1(n,t){if(!this.ndk)throw new Error("NDK instance not found");const e=this.getMatchingTags(n,t);if(e.length===0)return;const[s,i,r]=e[0],a=r!==""?this.ndk.pool.getRelay(r):void 0;return await this.ndk.fetchEvent(i,{},a)}async function fetchRootEvent$1(n){if(!this.ndk)throw new Error("NDK instance not found");const t=getRootTag$1(this);if(t)return this.ndk.fetchEventFromTag(t,this,n)}async function fetchReplyEvent$1(n){if(!this.ndk)throw new Error("NDK instance not found");const t=getReplyTag$1(this);if(t)return this.ndk.fetchEventFromTag(t,this,n)}function isReplaceable$1(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral$1(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable$1(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT$1=2;function encode$1(n=DEFAULT_RELAY_COUNT$1){let t=[];return this.onRelays.length>0?t=this.onRelays.map(e=>e.url):this.relay&&(t=[this.relay.url]),t.length>n&&(t=t.slice(0,n)),this.isParamReplaceable()?nip19_exports$2.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:t}):t.length>0?nip19_exports$2.neventEncode({id:this.tagId(),relays:t,author:this.pubkey}):nip19_exports$2.noteEncode(this.tagId())}async function repost$1(n=!0,t){if(!t&&n){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),t=this.ndk.signer}const e=new NDKEvent$1(this.ndk,{kind:getKind$1(this)});return this.isProtected||(e.content=JSON.stringify(this.rawEvent())),e.tag(this),this.kind!==1&&e.tags.push(["k",`${this.kind}`]),t&&await e.sign(t),n&&await e.publish(),e}function getKind$1(n){return n.kind===1?6:16}function getEventDetails(n){return"inspect"in n&&typeof n.inspect=="string"?n.inspect:JSON.stringify(n)}function validateForSerialization(n){if(typeof n.kind!="number")throw new Error(`Can't serialize event with invalid properties: kind (must be number, got ${typeof n.kind}). Event: ${getEventDetails(n)}`);if(typeof n.content!="string")throw new Error(`Can't serialize event with invalid properties: content (must be string, got ${typeof n.content}). Event: ${getEventDetails(n)}`);if(typeof n.created_at!="number")throw new Error(`Can't serialize event with invalid properties: created_at (must be number, got ${typeof n.created_at}). Event: ${getEventDetails(n)}`);if(typeof n.pubkey!="string")throw new Error(`Can't serialize event with invalid properties: pubkey (must be string, got ${typeof n.pubkey}). Event: ${getEventDetails(n)}`);if(!Array.isArray(n.tags))throw new Error(`Can't serialize event with invalid properties: tags (must be array, got ${typeof n.tags}). Event: ${getEventDetails(n)}`);for(let t=0;t<n.tags.length;t++){const e=n.tags[t];if(!Array.isArray(e))throw new Error(`Can't serialize event with invalid properties: tags[${t}] (must be array, got ${typeof e}). Event: ${getEventDetails(n)}`);for(let s=0;s<e.length;s++)if(typeof e[s]!="string")throw new Error(`Can't serialize event with invalid properties: tags[${t}][${s}] (must be string, got ${typeof e[s]}). Event: ${getEventDetails(n)}`)}}function serialize$1(n=!1,t=!1){validateForSerialization(this);const e=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return n&&e.push(this.sig),t&&e.push(this.id),JSON.stringify(e)}function deserialize$1(n){const t=JSON.parse(n),e={pubkey:t[1],created_at:t[2],kind:t[3],tags:t[4],content:t[5]};if(t.length>=7){const s=t[6],i=t[7];s&&s.length===128?(e.sig=s,i&&i.length===64&&(e.id=i)):s&&s.length===64&&(e.id=s,i&&i.length===128&&(e.sig=i))}return e}var worker,processingQueue$1={};function signatureVerificationInit(n){worker=n,worker.onmessage=t=>{if(!Array.isArray(t.data)||t.data.length!==2){console.error("[NDK]  Signature verification worker received incompatible message format.",`

 Expected format: [eventId, boolean]`,`
 Received:`,t.data,`

 This likely means:`,`
  1. You have a STALE worker.js file that needs updating`,`
  2. Version mismatch between @nostr-dev-kit/ndk and deployed worker`,`
  3. Wrong worker is being used for signature verification`,`

 Solution: Update your worker files:`,`
  cp node_modules/@nostr-dev-kit/ndk/dist/workers/sig-verification.js public/`,`
  cp node_modules/@nostr-dev-kit/cache-sqlite-wasm/dist/worker.js public/`,`

 Or use Vite/bundler imports instead of static files:`,`
  import SigWorker from "@nostr-dev-kit/ndk/workers/sig-verification?worker"`);return}const[e,s]=t.data,i=processingQueue$1[e];if(!i){console.error("No record found for event",e);return}delete processingQueue$1[e];for(const r of i.resolves)r(s)}}async function verifySignatureAsync$1(n,t,e){const s=n.ndk,i=Date.now();let r;return s.signatureVerificationFunction?r=await s.signatureVerificationFunction(n):r=await new Promise(a=>{const o=n.serialize();let l=!1;processingQueue$1[n.id]||(processingQueue$1[n.id]={event:n,resolves:[],relay:e},l=!0),processingQueue$1[n.id].resolves.push(a),l&&(worker==null||worker.postMessage({serialized:o,id:n.id,sig:n.sig,pubkey:n.pubkey}))}),s.signatureVerificationTimeMs+=Date.now()-i,r}var PUBKEY_REGEX$1=/^[a-f0-9]{64}$/;function validate$1(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX$1)||!Array.isArray(this.tags))return!1;for(let n=0;n<this.tags.length;n++){const t=this.tags[n];if(!Array.isArray(t))return!1;for(let e=0;e<t.length;e++)if(typeof t[e]=="object")return!1}return!0}var verifiedSignatures$1=new distExports.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature$1(n){var e;if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const t=verifiedSignatures$1.get(this.id);if(t!==null)return this.signatureVerified=!!t,this.signatureVerified;try{if((e=this.ndk)!=null&&e.asyncSigVerification){const s=this.relay;verifySignatureAsync$1(this,n,s).then(i=>{var r,a;n&&(this.signatureVerified=i,i&&verifiedSignatures$1.set(this.id,this.sig)),i?s&&s.addValidatedEvent():(s?(r=this.ndk)==null||r.reportInvalidSignature(this,s):(a=this.ndk)==null||a.reportInvalidSignature(this),verifiedSignatures$1.set(this.id,!1))}).catch(i=>{console.error("signature verification error",this.id,i)})}else{const s=sha256(new TextEncoder().encode(this.serialize())),i=schnorr.verify(this.sig,s,this.pubkey);return i?verifiedSignatures$1.set(this.id,this.sig):verifiedSignatures$1.set(this.id,!1),this.signatureVerified=i,i}}catch{return this.signatureVerified=!1,!1}}function getEventHash$1(){return getEventHashFromSerializedEvent$1(this.serialize())}function getEventHashFromSerializedEvent$1(n){const t=sha256(new TextEncoder().encode(n));return bytesToHex(t)}var skipClientTagOnKinds$1=new Set([0,4,1059,13,3,9734,5]),NDKEvent$1=class ae extends libExports.EventEmitter{constructor(e,s){var i;super();c(this,"ndk");c(this,"created_at");c(this,"content","");c(this,"tags",[]);c(this,"kind");c(this,"id","");c(this,"sig");c(this,"pubkey","");c(this,"signatureVerified");c(this,"_author");c(this,"relay");c(this,"publishStatus","success");c(this,"publishError");c(this,"serialize",serialize$1.bind(this));c(this,"getEventHash",getEventHash$1.bind(this));c(this,"validate",validate$1.bind(this));c(this,"verifySignature",verifySignature$1.bind(this));c(this,"isReplaceable",isReplaceable$1.bind(this));c(this,"isEphemeral",isEphemeral$1.bind(this));c(this,"isDvm",()=>this.kind&&this.kind>=5e3&&this.kind<=7e3);c(this,"isParamReplaceable",isParamReplaceable$1.bind(this));c(this,"encode",encode$1.bind(this));c(this,"encrypt",encrypt$1.bind(this));c(this,"decrypt",decrypt$1.bind(this));c(this,"fetchTaggedEvent",fetchTaggedEvent$1.bind(this));c(this,"fetchRootEvent",fetchRootEvent$1.bind(this));c(this,"fetchReplyEvent",fetchReplyEvent$1.bind(this));c(this,"repost",repost$1.bind(this));this.ndk=e,this.created_at=s==null?void 0:s.created_at,this.content=(s==null?void 0:s.content)||"",this.tags=(s==null?void 0:s.tags)||[],this.id=(s==null?void 0:s.id)||"",this.sig=s==null?void 0:s.sig,this.pubkey=(s==null?void 0:s.pubkey)||"",this.kind=s==null?void 0:s.kind,s instanceof ae&&(this.relay&&(this.relay=s.relay,(i=this.ndk)==null||i.subManager.seenEvent(s.id,this.relay)),this.publishStatus=s.publishStatus,this.publishError=s.publishError)}get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}static deserialize(e,s){return new ae(e,deserialize$1(s))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){var s;this.pubkey=e.pubkey,this._author=e,(s=this._author).ndk??(s.ndk=this.ndk)}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,s,i){const r=["i"],a=["k"];switch(s){case"url":{const o=new URL(e);o.hash="",r.push(o.toString()),a.push(`${o.protocol}//${o.host}`);break}case"hashtag":r.push(`#${e.toLowerCase()}`),a.push("#");break;case"geohash":r.push(`geo:${e.toLowerCase()}`),a.push("geo");break;case"isbn":r.push(`isbn:${e.replace(/-/g,"")}`),a.push("isbn");break;case"podcast:guid":r.push(`podcast:guid:${e}`),a.push("podcast:guid");break;case"podcast:item:guid":r.push(`podcast:item:guid:${e}`),a.push("podcast:item:guid");break;case"podcast:publisher:guid":r.push(`podcast:publisher:guid:${e}`),a.push("podcast:publisher:guid");break;case"isan":r.push(`isan:${e.split("-").slice(0,4).join("-")}`),a.push("isan");break;case"doi":r.push(`doi:${e.toLowerCase()}`),a.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${s}`)}i&&r.push(i),this.tags.push(r),this.tags.push(a)}tag(e,s,i,r,a){let o=[];if(e.fetchProfile!==void 0){if(r??(r="p"),r==="p"&&(a==null?void 0:a.pTags)===!1)return;const h=[r,e.pubkey];s&&h.push("",s),o.push(h)}else if(e instanceof ae){const h=e;if(i??(i=(h==null?void 0:h.pubkey)===this.pubkey),o=h.referenceTags(s,i,r,a),(a==null?void 0:a.pTags)!==!1)for(const u of h.getMatchingTags("p"))!u[1]||!isValidPubkey(u[1])||u[1]!==this.pubkey&&(this.tags.find(f=>f[0]==="p"&&f[1]===u[1])||this.tags.push(["p",u[1]]))}else if(Array.isArray(e))o=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags$1(this.tags,o)}async toNostrEvent(e,s){var a,o;if(!e&&this.pubkey===""){const l=await((o=(a=this.ndk)==null?void 0:a.signer)==null?void 0:o.user());this.pubkey=(l==null?void 0:l.pubkey)||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:i,tags:r}=await this.generateTags(s);this.content=i||"",this.tags=r;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}getMatchingTags(e,s){const i=this.tags.filter(r=>r[0]===e);return s===void 0?i:i.filter(r=>r[3]===s)}hasTag(e,s){return this.tags.some(i=>i[0]===e&&(!s||i[3]===s))}tagValue(e,s){const i=this.getMatchingTags(e,s);if(i.length!==0)return i[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,s){const i=Array.isArray(e)?e:[e];this.tags=this.tags.filter(r=>{const a=i.includes(r[0]),o=s?r[3]===s:!0;return!(a&&o)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,s){var r,a,o,l,h;(o=(a=(r=this.ndk)==null?void 0:r.aiGuardrails)==null?void 0:a.event)==null||o.signing(this),e?this.author=await e.user():((l=this.ndk)==null||l.assertSigner(),e=(h=this.ndk)==null?void 0:h.signer);const i=await this.toNostrEvent(void 0,s);return this.sig=await e.sign(i),this.sig}async publishReplaceable(e,s,i){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,s,i)}async publish(e,s,i,r){var l,h,u,f,p;if(i||(i=1),this.sig||await this.sign(void 0,r),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if((h=(l=this.ndk.aiGuardrails)==null?void 0:l.event)==null||h.publishing(this),(!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent$1(this.ndk,this,i)),this.kind===5&&((u=this.ndk.cacheAdapter)!=null&&u.deleteEventIds)){const g=this.getMatchingTags("e").map(m=>m[1]);this.ndk.cacheAdapter.deleteEventIds(g)}const a=this.rawEvent();if((f=this.ndk.cacheAdapter)!=null&&f.addUnpublishedEvent&&shouldTrackUnpublishedEvent$1(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(g){console.error("Error adding unpublished event to cache",g)}this.kind===5&&((p=this.ndk.cacheAdapter)!=null&&p.deleteEventIds)&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(g=>g[1])),this.ndk.subManager.dispatchEvent(a,void 0,!0);const o=await e.publish(this,s,i);return o.forEach(g=>{var m;return(m=this.ndk)==null?void 0:m.subManager.seenEvent(this.id,g)}),o}async generateTags(e){var a,o,l;let s=[];const i=await generateContentTags$1(this.content,this.tags,e,this),r=i.content;if(s=i.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const u=this.tagValue("title");let p=[...Array(u?6:16)].map(()=>Math.random().toString(36)[2]).join("");u&&u.length>0&&(p=`${u.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${p}`),s.push(["d",p])}if(this.shouldAddClientTag){const h=["client",((a=this.ndk)==null?void 0:a.clientName)??""];(o=this.ndk)!=null&&o.clientNip89&&h.push((l=this.ndk)==null?void 0:l.clientNip89),s.push(h)}else this.shouldStripClientTag&&(s=s.filter(h=>h[0]!=="client"));return{content:r||"",tags:s}}get shouldAddClientTag(){var e,s;return!(!((e=this.ndk)!=null&&e.clientName)&&!((s=this.ndk)!=null&&s.clientNip89)||skipClientTagOnKinds$1.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds$1.has(this.kind)}muted(){var e;return(e=this.ndk)!=null&&e.muteFilter&&this.ndk.muteFilter(this)?"muted":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let s;return this.isParamReplaceable()?s=["a",this.tagAddress()]:s=["e",this.tagId()],this.relay?s.push(this.relay.url):s.push(""),s.push(e??""),this.isParamReplaceable()||s.push(this.pubkey),s}referenceTags(e,s,i,r){let a=[];return this.isParamReplaceable()?a=[[i??"a",this.tagAddress()],[i??"e",this.id]]:a=[[i??"e",this.id]],a=a.map(o=>{var l,h,u;return o[0]==="e"||e?o.push(((l=this.relay)==null?void 0:l.url)??""):(h=this.relay)!=null&&h.url&&o.push((u=this.relay)==null?void 0:u.url),o}),a.forEach(o=>{o[0]==="e"?(o.push(e??""),o.push(this.pubkey)):e&&o.push(e)}),a=[...a,...this.getMatchingTags("h")],!s&&(r==null?void 0:r.pTags)!==!1&&a.push(...this.author.referenceTags()),a}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,s=!0){var r;if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const i=new ae(this.ndk,{kind:5,content:e||""});return i.tag(this,void 0,!0),i.tags.push(["k",(r=this.kind)==null?void 0:r.toString()]),s&&(this.emit("deleted"),await i.publish()),i}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}async react(e,s=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const i=new ae(this.ndk,{kind:7,content:e});return i.tag(this),this.kind!==1&&i.tags.push(["k",`${this.kind}`]),s&&await i.publish(),i}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,s){var r,a,o,l,h,u,f,p;const i=new ae(this.ndk);if((o=(a=(r=this.ndk)==null?void 0:r.aiGuardrails)==null?void 0:a.event)==null||o.creatingReply(i),this.kind===1&&!e)i.kind=1,this.hasTag("e")?i.tags=[...i.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,s)]:i.tag(this,"root",!1,void 0,s);else{i.kind=1111;const g=["A","E","I","P"],m=this.tags.filter(w=>g.includes(w[0]));if(m.length>0){const w=this.tagValue("K");i.tags.push(...m),w&&i.tags.push(["K",w]);let b;if(this.isParamReplaceable()){b=["a",this.tagAddress()];const E=((l=this.relay)==null?void 0:l.url)??"";E&&b.push(E)}else{b=["e",this.tagId()];const E=((h=this.relay)==null?void 0:h.url)??"";b.push(E),b.push(this.pubkey)}i.tags.push(b)}else{let w,b;const E=((u=this.relay)==null?void 0:u.url)??"";this.isParamReplaceable()?(w=["a",this.tagAddress(),E],b=["A",this.tagAddress(),E]):(w=["e",this.tagId(),E,this.pubkey],b=["E",this.tagId(),E,this.pubkey]),i.tags.push(w),i.tags.push(b),i.tags.push(["K",(f=this.kind)==null?void 0:f.toString()]),(s==null?void 0:s.pTags)!==!1&&(s==null?void 0:s.pTagOnATags)!==!1&&i.tags.push(["P",this.pubkey])}i.tags.push(["k",(p=this.kind)==null?void 0:p.toString()]),(s==null?void 0:s.pTags)!==!1&&(i.tags.push(...this.getMatchingTags("p")),i.tags.push(["p",this.pubkey]))}return i}},untrackedUnpublishedEvents$1=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent$1(n){return!untrackedUnpublishedEvents$1.has(n.kind)}var NDKPool$1=class extends libExports.EventEmitter{constructor(e,s,{debug:i,name:r}={}){super();c(this,"_relays",new Map);c(this,"status","idle");c(this,"autoConnectRelays",new Set);c(this,"debug");c(this,"temporaryRelayTimers",new Map);c(this,"flappingRelays",new Set);c(this,"backoffTimes",new Map);c(this,"ndk");c(this,"disconnectionTimes",new Map);c(this,"systemEventDetector");c(this,"_name","unnamed");this.debug=i??s.debug.extend("pool"),r&&(this._name=r),this.ndk=s,this.relayUrls=e,this.ndk.pools&&this.ndk.pools.push(this)}get relays(){return this._relays}set relayUrls(e){this._relays.clear();for(const s of e){const i=new NDKRelay$1(s,void 0,this.ndk);i.connectivity.netDebug=this.ndk.netDebug,this.addRelay(i)}}get name(){return this._name}set name(e){this._name=e,this.debug=this.debug.extend(e)}useTemporaryRelay(e,s=3e4,i){const r=this.relays.has(e.url);r||(this.addRelay(e),this.debug("Adding temporary relay %s for filters %o",e.url,i));const a=this.temporaryRelayTimers.get(e.url);if(a&&clearTimeout(a),!r||a){const o=setTimeout(()=>{var l;(l=this.ndk.explicitRelayUrls)!=null&&l.includes(e.url)||this.removeRelay(e.url)},s);this.temporaryRelayTimers.set(e.url,o)}}addRelay(e,s=!0){var w;const i=this.relays.has(e.url),r=e.url.includes("/npub1");let a=!0;const o=e.url;if(i)return;if(this.ndk.relayConnectionFilter&&!this.ndk.relayConnectionFilter(o)){this.debug(`Refusing to add relay ${o}: blocked by relayConnectionFilter`);return}if(r){this.debug(`Refusing to add relay ${o}: is a filter relay`);return}if((w=this.ndk.cacheAdapter)!=null&&w.getRelayStatus){const b=this.ndk.cacheAdapter.getRelayStatus(o),E=b instanceof Promise?void 0:b;if(E!=null&&E.dontConnectBefore){if(E.dontConnectBefore>Date.now()){const $=E.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${o}: delayed connect for ${$}ms`),setTimeout(()=>{this.addRelay(e,s)},$);return}a=!1}}const l=b=>this.emit("notice",e,b),h=()=>this.handleRelayConnect(o),u=()=>this.handleRelayReady(e),f=()=>{this.recordDisconnection(e),this.emit("relay:disconnect",e)},p=()=>this.handleFlapping(e),g=b=>this.emit("relay:auth",e,b),m=()=>this.emit("relay:authed",e);e.off("notice",l),e.off("connect",h),e.off("ready",u),e.off("disconnect",f),e.off("flapping",p),e.off("auth",g),e.off("authed",m),e.on("notice",l),e.on("connect",h),e.on("ready",u),e.on("disconnect",f),e.on("flapping",p),e.on("auth",g),e.on("authed",m),e.on("delayed-connect",b=>{var E;(E=this.ndk.cacheAdapter)!=null&&E.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(e.url,{dontConnectBefore:Date.now()+b})}),this._relays.set(o,e),s&&this.autoConnectRelays.add(o),s&&this.status==="active"&&(this.emit("relay:connecting",e),e.connect(void 0,a).catch(b=>{this.debug(`Failed to connect to relay ${o}`,b)}))}removeRelay(e){const s=this.relays.get(e);if(s)return s.disconnect(),this.relays.delete(e),this.autoConnectRelays.delete(e),this.emit("relay:disconnect",s),!0;const i=this.temporaryRelayTimers.get(e);return i&&(clearTimeout(i),this.temporaryRelayTimers.delete(e)),!1}isRelayConnected(e){const s=normalizeRelayUrl$1(e),i=this.relays.get(s);return i?i.status===5:!1}getRelay(e,s=!0,i=!1,r){let a=this.relays.get(normalizeRelayUrl$1(e));return a||(a=new NDKRelay$1(e,void 0,this.ndk),a.connectivity.netDebug=this.ndk.netDebug,i?this.useTemporaryRelay(a,3e4,r):this.addRelay(a,s)),a}handleRelayConnect(e){const s=this.relays.get(e);if(!s){console.error("NDK BUG: relay not found in pool",{relayUrl:e});return}this.emit("relay:connect",s),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(e){this.emit("relay:ready",e)}async connect(e){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${e?`, timeout ${e}ms`:""}...`);const s=Array.from(this.autoConnectRelays.keys()).map(o=>this.relays.get(o)).filter(o=>!!o);for(const o of s)o.status!==5&&o.status!==4&&(this.emit("relay:connecting",o),o.connect().catch(l=>{this.debug(`Failed to connect to relay ${o.url}: ${l??"No reason specified"}`)}));const i=()=>s.every(o=>o.status===5),r=new Promise(o=>{if(i()){o();return}const l=[];for(const h of s){const u=()=>{if(i()){for(let f=0;f<s.length;f++)s[f].off("connect",l[f]);o()}};l.push(u),h.on("connect",u)}}),a=typeof e=="number"?new Promise(o=>setTimeout(o,e)):new Promise(()=>{});await Promise.race([r,a])}checkOnFlappingRelays(){const e=this.flappingRelays.size,s=this.relays.size;if(e/s>=.8)for(const i of this.flappingRelays)this.backoffTimes.set(i,0)}recordDisconnection(e){const s=Date.now();this.disconnectionTimes.set(e.url,s);for(const[i,r]of this.disconnectionTimes.entries())s-r>1e4&&this.disconnectionTimes.delete(i);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const e=Date.now(),s=[];for(const i of this.disconnectionTimes.values())e-i<5e3&&s.push(i);s.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${s.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){if(this.systemEventDetector){this.debug("System-wide reconnection already in progress, skipping");return}this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const e of this.relays.values())e.connectivity&&(e.connectivity.resetReconnectionState(),e.status!==5&&e.status!==4&&e.connect().catch(s=>{this.debug(`Failed to reconnect relay ${e.url} after system event: ${s}`)}));this.disconnectionTimes.clear()}handleFlapping(e){this.debug(`Relay ${e.url} is flapping`);let s=this.backoffTimes.get(e.url)||5e3;s=s*2,this.backoffTimes.set(e.url,s),this.debug(`Backoff time for ${e.url} is ${s}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${e.url}`),this.emit("relay:connecting",e),e.connect(),this.checkOnFlappingRelays()},s),e.disconnect(),this.emit("flapping",e)}size(){return this.relays.size}stats(){const e={total:0,connected:0,disconnected:0,connecting:0};for(const s of this.relays.values())e.total++,s.status===5?e.connected++:s.status===1?e.disconnected++:s.status===4&&e.connecting++;return e}connectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(e=>e.status>=5&&!this.temporaryRelayTimers.has(e.url))}urls(){return Array.from(this.relays.keys())}},he,NDKDVMJobFeedback=(he=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=7e3)}static async from(t){const e=new he(t.ndk,t.rawEvent());return e.encrypted&&await e.dvmDecrypt(),e}get status(){return this.tagValue("status")}set status(t){this.removeTag("status"),t!==void 0&&this.tags.push(["status",t])}get encrypted(){return!!this.getMatchingTags("encrypted")[0]}async dvmDecrypt(){await this.decrypt();const t=JSON.parse(this.content);this.tags.push(...t)}},c(he,"kinds",[7e3]),he),M,NDKCashuMintList$1=(M=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"_p2pk");this.kind??(this.kind=10019)}static from(e){return new M(e.ndk,e)}set relays(e){this.tags=this.tags.filter(s=>s[0]!=="relay");for(const s of e)this.tags.push(["relay",s])}get relays(){const e=[];for(const s of this.tags)s[0]==="relay"&&e.push(s[1]);return e}set mints(e){this.tags=this.tags.filter(s=>s[0]!=="mint");for(const s of e)this.tags.push(["mint",s])}get mints(){const e=[];for(const s of this.tags)s[0]==="mint"&&e.push(s[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet$1.fromRelayUrls(this.relays,this.ndk)}},c(M,"kind",10019),c(M,"kinds",[10019]),M),L,NDKArticle=(L=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=30023)}static from(t){return new L(t.ndk,t)}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get image(){return this.tagValue("image")}set image(t){this.removeTag("image"),t&&this.tags.push(["image",t])}get summary(){return this.tagValue("summary")}set summary(t){this.removeTag("summary"),t&&this.tags.push(["summary",t])}get published_at(){const t=this.tagValue("published_at");if(t){let e=Number.parseInt(t);return e>1e12&&(e=Math.floor(e/1e3)),e}}set published_at(t){this.removeTag("published_at"),t!==void 0&&this.tags.push(["published_at",t.toString()])}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}get url(){return this.tagValue("url")}set url(t){t?this.tags.push(["url",t]):this.removeTag("url")}},c(L,"kind",30023),c(L,"kinds",[30023]),L),le,NDKBlossomList=(le=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=10063)}static from(t){return new le(t.ndk,t.rawEvent())}get servers(){return this.tags.filter(t=>t[0]==="server").map(t=>t[1])}set servers(t){this.tags=this.tags.filter(e=>e[0]!=="server");for(const e of t)this.tags.push(["server",e])}get default(){const t=this.servers;return t.length>0?t[0]:void 0}set default(t){if(!t)return;const s=this.servers.filter(i=>i!==t);this.servers=[t,...s]}addServer(t){if(!t)return;const e=this.servers;e.includes(t)||(this.servers=[...e,t])}removeServer(t){if(!t)return;const e=this.servers;this.servers=e.filter(s=>s!==t)}},c(le,"kinds",[10063]),le),O,NDKFedimintMint=(O=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=38173)}static async from(t){return new O(t.ndk,t)}get identifier(){return this.tagValue("d")}set identifier(t){this.removeTag("d"),t&&this.tags.push(["d",t])}get inviteCodes(){return this.getMatchingTags("u").map(t=>t[1])}set inviteCodes(t){this.removeTag("u");for(const e of t)this.tags.push(["u",e])}get modules(){return this.getMatchingTags("modules").map(t=>t[1])}set modules(t){this.removeTag("modules");for(const e of t)this.tags.push(["modules",e])}get network(){return this.tagValue("n")}set network(t){this.removeTag("n"),t&&this.tags.push(["n",t])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(t){t?this.content=JSON.stringify(t):this.content=""}},c(O,"kind",38173),c(O,"kinds",[38173]),O),V,NDKCashuMintAnnouncement=(V=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=38172)}static async from(t){return new V(t.ndk,t)}get identifier(){return this.tagValue("d")}set identifier(t){this.removeTag("d"),t&&this.tags.push(["d",t])}get url(){return this.tagValue("u")}set url(t){this.removeTag("u"),t&&this.tags.push(["u",t])}get nuts(){return this.getMatchingTags("nuts").map(t=>t[1])}set nuts(t){this.removeTag("nuts");for(const e of t)this.tags.push(["nuts",e])}get network(){return this.tagValue("n")}set network(t){this.removeTag("n"),t&&this.tags.push(["n",t])}get metadata(){if(this.content)try{return JSON.parse(this.content)}catch{return}}set metadata(t){t?this.content=JSON.stringify(t):this.content=""}},c(V,"kind",38172),c(V,"kinds",[38172]),V),z,NDKMintRecommendation=(z=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=38e3)}static async from(t){return new z(t.ndk,t)}get recommendedKind(){const t=this.tagValue("k");return t?Number(t):void 0}set recommendedKind(t){this.removeTag("k"),t&&this.tags.push(["k",t.toString()])}get identifier(){return this.tagValue("d")}set identifier(t){this.removeTag("d"),t&&this.tags.push(["d",t])}get urls(){return this.getMatchingTags("u").map(t=>t[1])}set urls(t){this.removeTag("u");for(const e of t)this.tags.push(["u",e])}get mintEventPointers(){return this.getMatchingTags("a").map(t=>({kind:Number(t[1].split(":")[0]),identifier:t[1].split(":")[2],relay:t[2]}))}addMintEventPointer(t,e,s,i){const r=["a",`${t}:${e}:${s}`];i&&r.push(i),this.tags.push(r)}get review(){return this.content}set review(t){this.content=t}},c(z,"kind",38e3),c(z,"kinds",[38e3]),z),ue,NDKClassified=(ue=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=30402)}static from(t){return new ue(t.ndk,t)}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get summary(){return this.tagValue("summary")}set summary(t){this.removeTag("summary"),t&&this.tags.push(["summary",t])}get published_at(){const t=this.tagValue("published_at");if(t)return Number.parseInt(t)}set published_at(t){this.removeTag("published_at"),t!==void 0&&this.tags.push(["published_at",t.toString()])}get location(){return this.tagValue("location")}set location(t){this.removeTag("location"),t&&this.tags.push(["location",t])}get price(){const t=this.tags.find(e=>e[0]==="price");if(t)return{amount:Number.parseFloat(t[1]),currency:t[2],frequency:t[3]}}set price(t){if(typeof t=="string"&&(t={amount:Number.parseFloat(t)}),t!=null&&t.amount){const e=["price",t.amount.toString()];t.currency&&e.push(t.currency),t.frequency&&e.push(t.frequency),this.tags.push(e)}else this.removeTag("price")}async generateTags(){return super.generateTags(),this.published_at||(this.published_at=this.created_at),super.generateTags()}},c(ue,"kinds",[30402]),ue),W,NDKDraft=(W=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"_event");c(this,"counterparty");this.kind??(this.kind=31234)}static from(e){return new W(e.ndk,e)}set identifier(e){this.removeTag("d"),this.tags.push(["d",e])}get identifier(){return this.dTag}set event(e){e instanceof NDKEvent$1?this._event=e:this._event=new NDKEvent$1(void 0,e),this.prepareEvent()}set checkpoint(e){e?(this.tags.push(e.tagReference()),this.kind=1234):(this.removeTag("a"),this.kind=31234)}get isCheckpoint(){return this.kind===1234}get isProposal(){const e=this.tagValue("p");return!!e&&e!==this.pubkey}async getEvent(e){var s;if(this._event)return this._event;if(e??(e=(s=this.ndk)==null?void 0:s.signer),!e)throw new Error("No signer available");if(this.content&&this.content.length>0)try{const i=e.pubkey,a=[this.tagValue("p"),this.pubkey].filter(Boolean).find(h=>h!==i);let o;o=new NDKUser$1({pubkey:a??i}),await this.decrypt(o,e);const l=JSON.parse(this.content);return this._event=await wrapEvent(new NDKEvent$1(this.ndk,l)),this._event}catch(i){console.error(i);return}else return null}prepareEvent(){if(!this._event)throw new Error("No event has been provided");this.removeTag("k"),this._event.kind&&this.tags.push(["k",this._event.kind.toString()]),this.content=JSON.stringify(this._event.rawEvent())}async save({signer:e,publish:s,relaySet:i}){var a;if(e??(e=(a=this.ndk)==null?void 0:a.signer),!e)throw new Error("No signer available");const r=this.counterparty||await e.user();if(await this.encrypt(r,e),this.counterparty){const o=this.counterparty.pubkey;this.removeTag("p"),this.tags.push(["p",o])}if(s!==!1)return this.publishReplaceable(i)}},c(W,"kind",31234),c(W,"kinds",[31234,1234]),W);function mapImetaTag(n){const t={};if(n.length===2){const s=n[1].split(" ");for(let i=0;i<s.length;i+=2){const r=s[i],a=s[i+1];r==="fallback"?(t.fallback||(t.fallback=[]),t.fallback.push(a)):t[r]=a}return t}const e=n.slice(1);for(const s of e){const i=s.split(" "),r=i[0],a=i.slice(1).join(" ");r==="fallback"?(t.fallback||(t.fallback=[]),t.fallback.push(a)):t[r]=a}return t}function imetaTagToTag(n){const t=["imeta"];for(const[e,s]of Object.entries(n))if(Array.isArray(s))for(const i of s)t.push(`${e} ${i}`);else s&&t.push(`${e} ${s}`);return t}var H,NDKFollowPack=(H=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=39089)}static from(t){return new H(t.ndk,t)}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get image(){const t=this.tags.find(e=>e[0]==="imeta");if(t){const e=mapImetaTag(t);if(e.url)return e.url}return this.tagValue("image")}set image(t){this.tags=this.tags.filter(e=>e[0]!=="imeta"&&e[0]!=="image"),typeof t=="string"?t!==void 0&&this.tags.push(["image",t]):t&&typeof t=="object"&&(this.tags.push(imetaTagToTag(t)),t.url&&this.tags.push(["image",t.url]))}get pubkeys(){return Array.from(new Set(this.tags.filter(t=>t[0]==="p"&&t[1]&&isValidPubkey(t[1])).map(t=>t[1])))}set pubkeys(t){this.tags=this.tags.filter(e=>e[0]!=="p");for(const e of t)this.tags.push(["p",e])}get description(){return this.tagValue("description")}set description(t){this.removeTag("description"),t&&this.tags.push(["description",t])}},c(H,"kind",39089),c(H,"kinds",[39089,39092]),H),q,NDKHighlight=(q=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"_article");this.kind??(this.kind=9802)}static from(e){return new q(e.ndk,e)}get url(){return this.tagValue("r")}set context(e){e===void 0?this.tags=this.tags.filter(([s,i])=>s!=="context"):(this.tags=this.tags.filter(([s,i])=>s!=="context"),this.tags.push(["context",e]))}get context(){var e;return((e=this.tags.find(([s,i])=>s==="context"))==null?void 0:e[1])??void 0}get article(){return this._article}set article(e){this._article=e,typeof e=="string"?this.tags.push(["r",e]):this.tag(e)}getArticleTag(){return this.getMatchingTags("a")[0]||this.getMatchingTags("e")[0]||this.getMatchingTags("r")[0]}async getArticle(){var i;if(this._article!==void 0)return this._article;let e;const s=this.getArticleTag();if(s){switch(s[0]){case"a":{const[r,a,o]=s[1].split(":");e=nip19_exports$2.naddrEncode({kind:Number.parseInt(r),pubkey:a,identifier:o});break}case"e":e=nip19_exports$2.noteEncode(s[1]);break;case"r":this._article=s[1];break}if(e){let r=await((i=this.ndk)==null?void 0:i.fetchEvent(e));r&&(r.kind===30023&&(r=NDKArticle.from(r)),this._article=r)}return this._article}}},c(q,"kind",9802),c(q,"kinds",[9802]),q),j,NDKImage=(j=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"_imetas");this.kind??(this.kind=20)}static from(e){return new j(e.ndk,e.rawEvent())}get isValid(){return this.imetas.length>0}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag).filter(e=>!!e.url),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(s=>s[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}},c(j,"kind",20),c(j,"kinds",[20]),j),de,NDKList=(de=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"_encryptedTags");c(this,"encryptedTagsLength");this.kind??(this.kind=30001)}static from(e){return new de(e.ndk,e)}get title(){const e=this.tagValue("title")||this.tagValue("name");return e||(this.kind===3?"Contacts":this.kind===1e4?"Mute":this.kind===10001?"Pinned Notes":this.kind===10002?"Relay Metadata":this.kind===10003?"Bookmarks":this.kind===10004?"Communities":this.kind===10005?"Public Chats":this.kind===10006?"Blocked Relays":this.kind===10007?"Search Relays":this.kind===10050?"Direct Message Receive Relays":this.kind===10015?"Interests":this.kind===10030?"Emojis":this.tagValue("d"))}set title(e){this.removeTag(["title","name"]),e&&this.tags.push(["title",e])}get name(){return this.title}set name(e){this.title=e}get description(){return this.tagValue("description")}set description(e){this.removeTag("description"),e&&this.tags.push(["description",e])}get image(){return this.tagValue("image")}set image(e){this.removeTag("image"),e&&this.tags.push(["image",e])}isEncryptedTagsCacheValid(){return!!(this._encryptedTags&&this.encryptedTagsLength===this.content.length)}async encryptedTags(e=!0){if(e&&this.isEncryptedTagsCacheValid())return this._encryptedTags;if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const s=await this.ndk.signer.user();try{if(this.content.length>0)try{const i=await this.ndk.signer.decrypt(s,this.content),r=JSON.parse(i);return r!=null&&r[0]?(this.encryptedTagsLength=this.content.length,this._encryptedTags=r):(this.encryptedTagsLength=this.content.length,this._encryptedTags=[])}catch{}}catch{}return[]}validateTag(e){return!0}getItems(e){return this.tags.filter(s=>s[0]===e)}get items(){return this.tags.filter(e=>!["d","L","l","title","name","description","published_at","summary","image","thumb","alt","expiration","subject","client"].includes(e[0]))}async addItem(e,s=void 0,i=!1,r="bottom"){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");let a;if(e instanceof NDKEvent$1)a=[e.tagReference(s)];else if(e instanceof NDKUser$1)a=e.referenceTags();else if(e instanceof NDKRelay$1)a=e.referenceTags();else if(Array.isArray(e))a=[e];else throw new Error("Invalid object type");if(s&&a[0].push(s),i){const o=await this.ndk.signer.user(),l=await this.encryptedTags();r==="top"?l.unshift(...a):l.push(...a),this._encryptedTags=l,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(l),await this.encrypt(o)}else r==="top"?this.tags.unshift(...a):this.tags.push(...a);this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItemByValue(e,s=!0){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");const i=this.tags.findIndex(l=>l[1]===e);i>=0&&this.tags.splice(i,1);const r=await this.ndk.signer.user(),a=await this.encryptedTags(),o=a.findIndex(l=>l[1]===e);if(o>=0&&(a.splice(o,1),this._encryptedTags=a,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(a),await this.encrypt(r)),s)return this.publishReplaceable();this.created_at=Math.floor(Date.now()/1e3),this.emit("change")}async removeItem(e,s){if(!this.ndk)throw new Error("NDK instance not set");if(!this.ndk.signer)throw new Error("NDK signer not set");if(s){const i=await this.ndk.signer.user(),r=await this.encryptedTags();r.splice(e,1),this._encryptedTags=r,this.encryptedTagsLength=this.content.length,this.content=JSON.stringify(r),await this.encrypt(i)}else this.tags.splice(e,1);return this.created_at=Math.floor(Date.now()/1e3),this.emit("change"),this}has(e){return this.items.some(s=>s[1]===e)}filterForItems(){const e=new Set,s=new Map,i=[];for(const r of this.items)if(r[0]==="e"&&r[1])e.add(r[1]);else if(r[0]==="a"&&r[1]){const[a,o,l]=r[1].split(":");if(!a||!o)continue;const h=`${a}:${o}`,u=s.get(h)||[];u.push(l||""),s.set(h,u)}if(e.size>0&&i.push({ids:Array.from(e)}),s.size>0)for(const[r,a]of s.entries()){const[o,l]=r.split(":");i.push({kinds:[Number.parseInt(o)],authors:[l],"#d":a})}return i}},c(de,"kinds",[30001,10004,10050,10030,10015,10001,10002,10007,10006,10003]),de),fe,NDKAppHandlerEvent=(fe=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"profile");this.kind??(this.kind=31990)}static from(e){const s=new fe(e.ndk,e.rawEvent());return s.isValid?s:null}get isValid(){const e=new Map,s=r=>[r[0],r[2]].join(":").toLowerCase(),i=["web","android","ios"];for(const r of this.tags)if(i.includes(r[0])){const a=s(r);if(e.has(a)&&e.get(a)!==r[1].toLowerCase())return!1;e.set(a,r[1].toLowerCase())}return!0}async fetchProfile(){if(this.profile===void 0&&this.content.length>0)try{const e=JSON.parse(this.content);if(e!=null&&e.name)return e;this.profile=null}catch{this.profile=null}return new Promise((e,s)=>{const i=this.author;i.fetchProfile().then(()=>{e(i.profile)}).catch(s)})}},c(fe,"kinds",[31990]),fe),K,NDKNutzap=(K=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"debug");c(this,"_proofs",[]);c(this,"sender",this.author);this.kind??(this.kind=9321),this.debug=(e==null?void 0:e.debug.extend("nutzap"))??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const i=this.getMatchingTags("proof");i.length?this._proofs=i.map(r=>JSON.parse(r[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const s=new K(e.ndk,e);if(!(!s._proofs||!s._proofs.length))return s}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(s=>s[0]!=="proof");for(const s of e)this.tags.push(["proof",JSON.stringify(s)])}get proofs(){return this._proofs}get rawP2pk(){var s;const e=this.proofs[0];try{const i=JSON.parse(e.secret);let r;if(typeof i=="string"?(r=JSON.parse(i),this.debug("stringified payload",e.secret)):typeof i=="object"&&(r=i),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof((s=r[1])==null?void 0:s.data)=="string")return r[1].data}catch(i){this.debug("error parsing p2pk pubkey",i,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e!=null&&e.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e!=null&&e.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((s,i)=>s+i.amount,0)}set target(e){this.tags=this.tags.filter(s=>s[0]!=="p"),e instanceof NDKEvent$1&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser$1({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,s=0,i=0;for(const r of this.tags)r[0]==="e"&&e++,r[0]==="p"&&s++,r[0]==="u"&&i++;return s===1&&i===1&&e<=1&&this.proofs.length>0}},c(K,"kind",9321),c(K,"kinds",[K.kind]),K),B,NDKProject=(B=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"_signer");this.kind=31933}static from(e){return new B(e.ndk,e.rawEvent())}set repo(e){this.removeTag("repo"),e&&this.tags.push(["repo",e])}set hashtags(e){this.removeTag("hashtags"),e.filter(s=>s.length>0).length&&this.tags.push(["hashtags",...e])}get hashtags(){const e=this.tags.find(s=>s[0]==="hashtags");return e?e.slice(1):[]}get repo(){return this.tagValue("repo")}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get picture(){return this.tagValue("picture")}set picture(e){this.removeTag("picture"),e&&this.tags.push(["picture",e])}set description(e){this.content=e}get description(){return this.content}get slug(){return this.dTag??"empty-dtag"}async getSigner(){var s,i;if(this._signer)return this._signer;const e=this.tagValue("key");if(!e)this._signer=NDKPrivateKeySigner$1.generate(),await this.encryptAndSaveNsec();else{const r=await((i=(s=this.ndk)==null?void 0:s.signer)==null?void 0:i.decrypt(this.ndk.activeUser,e));if(!r)throw new Error("Failed to decrypt project key or missing signer context.");this._signer=new NDKPrivateKeySigner$1(r)}return this._signer}async getNsec(){return(await this.getSigner()).privateKey}async setNsec(e){this._signer=new NDKPrivateKeySigner$1(e),await this.encryptAndSaveNsec()}async encryptAndSaveNsec(){var i,r;if(!this._signer)throw new Error("Signer is not set.");const e=this._signer.privateKey,s=await((r=(i=this.ndk)==null?void 0:i.signer)==null?void 0:r.encrypt(this.ndk.activeUser,e));s&&(this.removeTag("key"),this.tags.push(["key",s]))}},c(B,"kind",31933),c(B,"kinds",[31933]),B),G,NDKProjectTemplate=(G=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind=30717}static from(t){return new G(t.ndk,t.rawEvent())}get templateId(){return this.dTag??""}set templateId(t){this.dTag=t}get name(){return this.tagValue("title")??""}set name(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get description(){return this.tagValue("description")??""}set description(t){this.removeTag("description"),t&&this.tags.push(["description",t])}get repoUrl(){return this.tagValue("uri")??""}set repoUrl(t){this.removeTag("uri"),t&&this.tags.push(["uri",t])}get image(){return this.tagValue("image")}set image(t){this.removeTag("image"),t&&this.tags.push(["image",t])}get command(){return this.tagValue("command")}set command(t){this.removeTag("command"),t&&this.tags.push(["command",t])}get agentConfig(){const t=this.tagValue("agent");if(t)try{return JSON.parse(t)}catch{return}}set agentConfig(t){this.removeTag("agent"),t&&this.tags.push(["agent",JSON.stringify(t)])}get templateTags(){return this.getMatchingTags("t").map(t=>t[1]).filter(Boolean)}set templateTags(t){this.tags=this.tags.filter(e=>e[0]!=="t"),t.forEach(e=>{e&&this.tags.push(["t",e])})}},c(G,"kind",30717),c(G,"kinds",[30717]),G),READ_MARKER="read",WRITE_MARKER="write",pe,NDKRelayList=(pe=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=10002)}static from(t){return new pe(t.ndk,t.rawEvent())}get readRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]||t[2]&&t[2]===READ_MARKER).map(t=>tryNormalizeRelayUrl(t[1])).filter(t=>!!t)}set readRelayUrls(t){for(const e of t)this.tags.push(["r",e,READ_MARKER])}get writeRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]||t[2]&&t[2]===WRITE_MARKER).map(t=>tryNormalizeRelayUrl(t[1])).filter(t=>!!t)}set writeRelayUrls(t){for(const e of t)this.tags.push(["r",e,WRITE_MARKER])}get bothRelayUrls(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").filter(t=>!t[2]).map(t=>t[1])}set bothRelayUrls(t){for(const e of t)this.tags.push(["r",e])}get relays(){return this.tags.filter(t=>t[0]==="r"||t[0]==="relay").map(t=>t[1])}get relaySet(){if(!this.ndk)throw new Error("NDKRelayList has no NDK instance");return new NDKRelaySet$1(new Set(this.relays.map(t=>{var e;return(e=this.ndk)==null?void 0:e.pool.getRelay(t)}).filter(t=>!!t)),this.ndk)}},c(pe,"kinds",[10002]),pe);function relayListFromKind3(n,t){try{const e=JSON.parse(t.content),s=new NDKRelayList(n),i=new Set,r=new Set;for(let[a,o]of Object.entries(e)){try{a=normalizeRelayUrl$1(a)}catch{continue}if(!o)i.add(a),r.add(a);else{const l=o;l.write&&r.add(a),l.read&&i.add(a)}}return s.readRelayUrls=Array.from(i),s.writeRelayUrls=Array.from(r),s}catch{}}var ge,NDKRepost=(ge=class extends NDKEvent$1{constructor(){super(...arguments);c(this,"_repostedEvents")}static from(e){return new ge(e.ndk,e.rawEvent())}async repostedEvents(e,s){const i=[];if(!this.ndk)throw new Error("NDK instance not set");if(this._repostedEvents!==void 0)return this._repostedEvents;for(const r of this.repostedEventIds()){const a=filterForId(r),o=await this.ndk.fetchEvent(a,s);o&&i.push(e?e.from(o):o)}return i}repostedEventIds(){return this.tags.filter(e=>e[0]==="e"||e[0]==="a").map(e=>e[1])}},c(ge,"kinds",[6,16]),ge);function filterForId(n){if(n.match(/:/)){const[t,e,s]=n.split(":");return{kinds:[Number.parseInt(t)],authors:[e],"#d":[s]}}return{ids:[n]}}var J,NDKSimpleGroupMemberList=(J=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"relaySet");c(this,"memberSet",new Set);this.kind??(this.kind=39002),this.memberSet=new Set(this.members)}static from(e){return new J(e.ndk,e)}get members(){return this.getMatchingTags("p").map(e=>e[1])}hasMember(e){return this.memberSet.has(e)}async publish(e,s,i){return e??(e=this.relaySet),super.publishReplaceable(e,s,i)}},c(J,"kind",39002),c(J,"kinds",[39002]),J),Y,NDKSimpleGroupMetadata=(Y=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=39e3)}static from(t){return new Y(t.ndk,t)}get name(){return this.tagValue("name")}get picture(){return this.tagValue("picture")}get about(){return this.tagValue("about")}get scope(){if(this.getMatchingTags("public").length>0)return"public";if(this.getMatchingTags("public").length>0)return"private"}set scope(t){this.removeTag("public"),this.removeTag("private"),t==="public"?this.tags.push(["public",""]):t==="private"&&this.tags.push(["private",""])}get access(){if(this.getMatchingTags("open").length>0)return"open";if(this.getMatchingTags("closed").length>0)return"closed"}set access(t){this.removeTag("open"),this.removeTag("closed"),t==="open"?this.tags.push(["open",""]):t==="closed"&&this.tags.push(["closed",""])}},c(Y,"kind",39e3),c(Y,"kinds",[39e3]),Y);function strToPosition(n){const[t,e]=n.split(",").map(Number);return{x:t,y:e}}function strToDimension(n){const[t,e]=n.split("x").map(Number);return{width:t,height:e}}var F,NDKStorySticker=(F=class{constructor(t){c(this,"type");c(this,"value");c(this,"position");c(this,"dimension");c(this,"properties");c(this,"hasValidDimensions",()=>typeof this.dimension.width=="number"&&typeof this.dimension.height=="number"&&!Number.isNaN(this.dimension.width)&&!Number.isNaN(this.dimension.height));c(this,"hasValidPosition",()=>typeof this.position.x=="number"&&typeof this.position.y=="number"&&!Number.isNaN(this.position.x)&&!Number.isNaN(this.position.y));if(Array.isArray(t)){const e=t;if(e[0]!=="sticker"||e.length<5)throw new Error("Invalid sticker tag");this.type=e[1],this.value=e[2],this.position=strToPosition(e[3]),this.dimension=strToDimension(e[4]);const s={};for(let i=5;i<e.length;i++){const[r,...a]=e[i].split(" ");s[r]=a.join(" ")}Object.keys(s).length>0&&(this.properties=s)}else this.type=t,this.value=void 0,this.position={x:0,y:0},this.dimension={width:0,height:0}}static fromTag(t){try{return new F(t)}catch{return null}}get style(){var t;return(t=this.properties)==null?void 0:t.style}set style(t){var e;t?this.properties={...this.properties,style:t}:(e=this.properties)==null||delete e.style}get rotation(){var t;return(t=this.properties)!=null&&t.rot?Number.parseFloat(this.properties.rot):void 0}set rotation(t){var e;t!==void 0?this.properties={...this.properties,rot:t.toString()}:(e=this.properties)==null||delete e.rot}get isValid(){return this.hasValidDimensions()&&this.hasValidPosition()}toTag(){if(!this.isValid){const s=[this.hasValidDimensions()?void 0:"dimensions is invalid",this.hasValidPosition()?void 0:"position is invalid"].filter(Boolean);throw new Error(`Invalid sticker: ${s.join(", ")}`)}let t;switch(this.type){case"event":t=this.value.tagId();break;case"pubkey":t=this.value.pubkey;break;default:t=this.value}const e=["sticker",this.type,t,coordinates(this.position),dimension(this.dimension)];if(this.properties)for(const[s,i]of Object.entries(this.properties))e.push(`${s} ${i}`);return e}},c(F,"Text","text"),c(F,"Pubkey","pubkey"),c(F,"Event","event"),c(F,"Prompt","prompt"),c(F,"Countdown","countdown"),F),Q,NDKStory=(Q=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"_imeta");c(this,"_dimensions");if(this.kind??(this.kind=23),s)for(const i of s.tags)switch(i[0]){case"imeta":this._imeta=mapImetaTag(i);break;case"dim":this.dimensions=strToDimension(i[1]);break}}static from(e){return new Q(e.ndk,e)}get isValid(){return!!this.imeta}get imeta(){return this._imeta}set imeta(e){this._imeta=e,this.tags=this.tags.filter(s=>s[0]!=="imeta"),e&&this.tags.push(imetaTagToTag(e))}get dimensions(){const e=this.tagValue("dim");if(e)return strToDimension(e)}set dimensions(e){this.removeTag("dim"),e&&this.tags.push(["dim",`${e.width}x${e.height}`])}get duration(){const e=this.tagValue("dur");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("dur"),e!==void 0&&this.tags.push(["dur",e.toString()])}get stickers(){const e=[];for(const s of this.tags){if(s[0]!=="sticker"||s.length<5)continue;const i=NDKStorySticker.fromTag(s);i&&e.push(i)}return e}addSticker(e){let s;if(e instanceof NDKStorySticker)s=e;else{const i=["sticker",e.type,typeof e.value=="string"?e.value:"",coordinates(e.position),dimension(e.dimension)];if(e.properties)for(const[r,a]of Object.entries(e.properties))i.push(`${r} ${a}`);s=new NDKStorySticker(i),s.value=e.value}s.type==="pubkey"?this.tag(s.value):s.type==="event"&&this.tag(s.value),this.tags.push(s.toTag())}removeSticker(e){const s=this.stickers;if(e<0||e>=s.length)return;let i=0;for(let r=0;r<this.tags.length;r++)if(this.tags[r][0]==="sticker"){if(i===e){this.tags.splice(r,1);break}i++}}},c(Q,"kind",23),c(Q,"kinds",[23]),Q),coordinates=n=>`${n.x},${n.y}`,dimension=n=>`${n.width}x${n.height}`,ye,NDKSubscriptionReceipt=(ye=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"debug");this.kind??(this.kind=7003),this.debug=(e==null?void 0:e.debug.extend("subscription-start"))??createDebug2("ndk:subscription-start")}static from(e){return new ye(e.ndk,e.rawEvent())}get recipient(){var i;const e=(i=this.getMatchingTags("p"))==null?void 0:i[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get subscriber(){var i;const e=(i=this.getMatchingTags("P"))==null?void 0:i[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set subscriber(e){this.removeTag("P"),e&&this.tags.push(["P",e.pubkey])}set subscriptionStart(e){this.debug(`before setting subscription start: ${this.rawEvent}`),this.removeTag("e"),this.tag(e,"subscription",!0),this.debug(`after setting subscription start: ${this.rawEvent}`)}get tierName(){var s;const e=(s=this.getMatchingTags("tier"))==null?void 0:s[0];return e==null?void 0:e[1]}get isValid(){const e=this.validPeriod;if(!e||e.start>e.end)return!1;const s=this.getMatchingTags("p"),i=this.getMatchingTags("P");return!(s.length!==1||i.length!==1)}get validPeriod(){var s;const e=(s=this.getMatchingTags("valid"))==null?void 0:s[0];if(e)try{return{start:new Date(Number.parseInt(e[1])*1e3),end:new Date(Number.parseInt(e[2])*1e3)}}catch{return}}set validPeriod(e){this.removeTag("valid"),e&&this.tags.push(["valid",Math.floor(e.start.getTime()/1e3).toString(),Math.floor(e.end.getTime()/1e3).toString()])}get startPeriod(){var e;return(e=this.validPeriod)==null?void 0:e.start}get endPeriod(){var e;return(e=this.validPeriod)==null?void 0:e.end}isActive(e){e??(e=new Date);const s=this.validPeriod;return!(!s||e<s.start||e>s.end)}},c(ye,"kinds",[7003]),ye),possibleIntervalFrequencies=["daily","weekly","monthly","quarterly","yearly"];function newAmount(n,t,e){return["amount",n.toString(),t,e]}function parseTagToSubscriptionAmount(n){const t=Number.parseInt(n[1]);if(Number.isNaN(t)||t===void 0||t===null||t<=0)return;const e=n[2];if(e===void 0||e==="")return;const s=n[3];if(s!==void 0&&possibleIntervalFrequencies.includes(s))return{amount:t,currency:e,term:s}}var X,NDKSubscriptionTier=(X=class extends NDKArticle{constructor(t,e){const s=(e==null?void 0:e.kind)??37001;super(t,e),this.kind=s}static from(t){return new X(t.ndk,t)}get perks(){return this.getMatchingTags("perk").map(t=>t[1]).filter(t=>t!==void 0)}addPerk(t){this.tags.push(["perk",t])}get amounts(){return this.getMatchingTags("amount").map(t=>parseTagToSubscriptionAmount(t)).filter(t=>t!==void 0)}addAmount(t,e,s){this.tags.push(newAmount(t,e,s))}set relayUrl(t){this.tags.push(["r",t])}get relayUrls(){return this.getMatchingTags("r").map(t=>t[1]).filter(t=>t!==void 0)}get verifierPubkey(){return this.tagValue("p")}set verifierPubkey(t){this.removeTag("p"),t&&this.tags.push(["p",t])}get isValid(){return this.title!==void 0&&this.amounts.length>0}},c(X,"kind",37001),c(X,"kinds",[37001]),X),me,NDKSubscriptionStart=(me=class extends NDKEvent$1{constructor(e,s){super(e,s);c(this,"debug");this.kind??(this.kind=7001),this.debug=(e==null?void 0:e.debug.extend("subscription-start"))??createDebug2("ndk:subscription-start")}static from(e){return new me(e.ndk,e.rawEvent())}get recipient(){var i;const e=(i=this.getMatchingTags("p"))==null?void 0:i[0];return e?new NDKUser$1({pubkey:e[1]}):void 0}set recipient(e){this.removeTag("p"),e&&this.tags.push(["p",e.pubkey])}get amount(){var s;const e=(s=this.getMatchingTags("amount"))==null?void 0:s[0];if(e)return parseTagToSubscriptionAmount(e)}set amount(e){this.removeTag("amount"),e&&this.tags.push(newAmount(e.amount,e.currency,e.term))}get tierId(){var i,r;const e=(i=this.getMatchingTags("e"))==null?void 0:i[0],s=(r=this.getMatchingTags("a"))==null?void 0:r[0];if(!(!e||!s))return e[1]??s[1]}set tier(e){this.removeTag("e"),this.removeTag("a"),this.removeTag("event"),e&&(this.tag(e),this.removeTag("p"),this.tags.push(["p",e.pubkey]),this.tags.push(["event",JSON.stringify(e.rawEvent())]))}async fetchTier(){var r;const e=this.tagValue("event");if(e)try{const a=JSON.parse(e);return new NDKSubscriptionTier(this.ndk,a)}catch{this.debug("Failed to parse event tag")}const s=this.tierId;if(!s)return;const i=await((r=this.ndk)==null?void 0:r.fetchEvent(s));if(i)return NDKSubscriptionTier.from(i)}get isValid(){return this.getMatchingTags("amount").length!==1?(this.debug("Invalid # of amount tag"),!1):this.amount?this.getMatchingTags("p").length!==1?(this.debug("Invalid # of p tag"),!1):this.recipient?!0:(this.debug("Invalid p tag"),!1):(this.debug("Invalid amount tag"),!1)}},c(me,"kinds",[7001]),me),Z,NDKTask=(Z=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind=1934}static from(t){return new Z(t.ndk,t.rawEvent())}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}get title(){return this.tagValue("title")}set project(t){this.removeTag("a"),this.tags.push(t.tagReference())}get projectSlug(){var e;const t=this.getMatchingTags("a")[0];return t?(e=t[1].split(/:/))==null?void 0:e[2]:void 0}},c(Z,"kind",1934),c(Z,"kinds",[1934]),Z),te,NDKThread=(te=class extends NDKEvent$1{constructor(t,e){super(t,e),this.kind??(this.kind=11)}static from(t){return new te(t.ndk,t)}get title(){return this.tagValue("title")}set title(t){this.removeTag("title"),t&&this.tags.push(["title",t])}},c(te,"kind",11),c(te,"kinds",[11]),te),se,NDKVideo=(se=class extends NDKEvent$1{constructor(){super(...arguments);c(this,"_imetas")}static from(e){return new se(e.ndk,e.rawEvent())}get title(){return this.tagValue("title")}set title(e){this.removeTag("title"),e&&this.tags.push(["title",e])}get thumbnail(){var s;let e;return this.imetas&&this.imetas.length>0&&(e=(s=this.imetas[0].image)==null?void 0:s[0]),e??this.tagValue("thumb")}get imetas(){return this._imetas?this._imetas:(this._imetas=this.tags.filter(e=>e[0]==="imeta").map(mapImetaTag),this._imetas)}set imetas(e){this._imetas=e,this.tags=this.tags.filter(s=>s[0]!=="imeta"),this.tags.push(...e.map(imetaTagToTag))}get url(){return this.imetas&&this.imetas.length>0?this.imetas[0].url:this.tagValue("url")}get published_at(){const e=this.tagValue("published_at");if(e)return Number.parseInt(e)}async generateTags(){var e,s;if(super.generateTags(),!this.kind&&(s=(e=this.imetas)==null?void 0:e[0])!=null&&s.dim){const[i,r]=this.imetas[0].dim.split("x"),a=i&&r&&Number.parseInt(i)<Number.parseInt(r);this.duration&&this.duration<120&&a?this.kind=22:this.kind=21}return super.generateTags()}get duration(){const e=this.tagValue("duration");if(e)return Number.parseInt(e)}set duration(e){this.removeTag("duration"),e!==void 0&&this.tags.push(["duration",Math.floor(e).toString()])}},c(se,"kind",21),c(se,"kinds",[34235,34236,22,21]),se),ie,NDKWiki=(ie=class extends NDKArticle{static from(t){return new ie(t.ndk,t.rawEvent())}get isDefered(){return this.hasTag("a","defer")}get deferedId(){return this.tagValue("a","defer")}set defer(t){this.removeTag("a","defer"),this.tag(t,"defer")}},c(ie,"kind",30818),c(ie,"kinds",[30818]),ie),be,NDKWikiMergeRequest=(be=class extends NDKEvent$1{static from(t){return new be(t.ndk,t.rawEvent())}get targetId(){return this.tagValue("a")}set target(t){this.tags=this.tags.filter(e=>{if(e[0]==="a"||e[0]==="e"&&e[3]!=="source")return!0}),this.tag(t)}get sourceId(){return this.tagValue("e","source")}set source(t){this.removeTag("e","source"),this.tag(t,"source",!1,"e")}},c(be,"kinds",[818]),be),registeredEventClasses=new Set;function wrapEvent(n){const t=new Map,s=[...[NDKImage,NDKVideo,NDKCashuMintList$1,NDKArticle,NDKHighlight,NDKDraft,NDKWiki,NDKWikiMergeRequest,NDKNutzap,NDKProject,NDKTask,NDKProjectTemplate,NDKSimpleGroupMemberList,NDKSimpleGroupMetadata,NDKSubscriptionTier,NDKSubscriptionStart,NDKSubscriptionReceipt,NDKList,NDKRelayList,NDKStory,NDKBlossomList,NDKFollowPack,NDKThread,NDKRepost,NDKClassified,NDKAppHandlerEvent,NDKDVMJobFeedback,NDKCashuMintAnnouncement,NDKFedimintMint,NDKMintRecommendation],...registeredEventClasses];for(const r of s)for(const a of r.kinds)t.set(a,r);const i=t.get(n.kind);return i?i.from(n):n}function checkMissingKind(n,t){(n.kind===void 0||n.kind===null)&&t("event-missing-kind",`Cannot sign event without 'kind'.

 Event data:
    content: ${n.content?`"${n.content.substring(0,50)}${n.content.length>50?"...":""}"`:"(empty)"}
    tags: ${n.tags.length} tag${n.tags.length!==1?"s":""}
    kind: ${n.kind} 

Set event.kind before signing.`,"Example: event.kind = 1; // for text note",!1)}function checkContentIsObject(n,t){if(typeof n.content=="object"){const e=JSON.stringify(n.content,null,2).substring(0,200);t("event-content-is-object",`Event content is an object. Content must be a string.

 Your content (${typeof n.content}):
${e}${JSON.stringify(n.content).length>200?"...":""}

 event.content = { ... }  // WRONG
 event.content = JSON.stringify({ ... })  // CORRECT`,"Use JSON.stringify() for structured data: event.content = JSON.stringify(data)",!1)}}function checkCreatedAtMilliseconds(n,t){if(n.created_at&&n.created_at>1e10){const e=Math.floor(n.created_at/1e3),s=new Date(n.created_at).toISOString();t("event-created-at-milliseconds",`Event created_at is in milliseconds, not seconds.

 Your value:
    created_at: ${n.created_at} 
    Interpreted as: ${s}
    Should be: ${e} 

Nostr timestamps MUST be in seconds since Unix epoch.`,"Use Math.floor(Date.now() / 1000) instead of Date.now()",!1)}}function checkInvalidPTags(n,t){n.getMatchingTags("p").forEach((s,i)=>{if(s[1]&&!/^[0-9a-f]{64}$/i.test(s[1])){const r=JSON.stringify(s);t("tag-invalid-p-tag",`p-tag[${i}] has invalid pubkey.

 Your tag:
   ${r}

 Invalid value: "${s[1]}"
    Length: ${s[1].length} (expected 64)
    Format: ${s[1].startsWith("npub")?"bech32 (npub)":"unknown"}

p-tags MUST contain 64-character hex pubkeys.`,s[1].startsWith("npub")?`Use ndkUser.pubkey instead of npub:
    event.tags.push(['p', ndkUser.pubkey])
    event.tags.push(['p', 'npub1...'])`:"p-tags must contain valid hex pubkeys (64 characters, 0-9a-f)",!1)}})}function checkInvalidETags(n,t){n.getMatchingTags("e").forEach((s,i)=>{if(s[1]&&!/^[0-9a-f]{64}$/i.test(s[1])){const r=JSON.stringify(s),a=s[1].startsWith("note")||s[1].startsWith("nevent");t("tag-invalid-e-tag",`e-tag[${i}] has invalid event ID.

 Your tag:
   ${r}

 Invalid value: "${s[1]}"
    Length: ${s[1].length} (expected 64)
    Format: ${a?"bech32 (note/nevent)":"unknown"}

e-tags MUST contain 64-character hex event IDs.`,a?`Use event.id instead of bech32:
    event.tags.push(['e', referencedEvent.id])
    event.tags.push(['e', 'note1...'])`:"e-tags must contain valid hex event IDs (64 characters, 0-9a-f)",!1)}})}function checkManualReplyMarkers(n,t,e){if(n.kind!==1||e.has(n))return;const s=n.tags.filter(i=>i[0]==="e"&&(i[3]==="reply"||i[3]==="root"));if(s.length>0){const i=s.map((r,a)=>`   ${a+1}. ${JSON.stringify(r)}`).join(`
`);t("event-manual-reply-markers",`Event has ${s.length} e-tag(s) with manual reply/root markers.

 Your tags with markers:
${i}

  Manual reply markers detected! This will cause incorrect threading.`,`Reply events MUST be created using .reply():

    CORRECT:
   const replyEvent = originalEvent.reply();
   replyEvent.content = 'good point!';
   await replyEvent.publish();

    WRONG:
   event.tags.push(['e', eventId, '', 'reply']);

NDK handles all reply threading automatically - never add reply/root markers manually.`)}}function checkHashtagsWithPrefix(n,t){n.getMatchingTags("t").forEach((s,i)=>{if(s[1]&&s[1].startsWith("#")){const r=JSON.stringify(s);t("tag-hashtag-with-prefix",`t-tag[${i}] contains hashtag with # prefix.

 Your tag:
   ${r}

 Invalid value: "${s[1]}"

Hashtag tags should NOT include the # symbol.`,`Remove the # prefix from hashtag tags:
    event.tags.push(['t', 'nostr'])
    event.tags.push(['t', '#nostr'])`,!1)}})}function checkReplaceableWithOldTimestamp(n,t){if(n.kind===void 0||n.kind===null||!n.created_at||!n.isReplaceable())return;const e=Math.floor(Date.now()/1e3),s=e-n.created_at;if(s>10){const r=Math.floor(s/60),a=r>0?`${r} minute${r!==1?"s":""}`:`${s} seconds`;t("event-replaceable-old-timestamp",`Publishing a replaceable event with an old created_at timestamp.

 Event details:
    kind: ${n.kind} (replaceable)
    created_at: ${n.created_at}
    age: ${a} old
    current time: ${e}

  This is wrong and will be rejected by relays.`,`For replaceable events, use publishReplaceable():

    CORRECT:
   await event.publishReplaceable();
   // Automatically updates created_at to now

    WRONG:
   await event.publish();
   // Uses old created_at`)}}function signing(n,t,e,s){checkMissingKind(n,t),checkContentIsObject(n,t),checkCreatedAtMilliseconds(n,t),checkInvalidPTags(n,t),checkInvalidETags(n,t),checkHashtagsWithPrefix(n,t),checkManualReplyMarkers(n,e,s)}function publishing(n,t){checkReplaceableWithOldTimestamp(n,t)}function isNip33Pattern(n){const t=Array.isArray(n)?n:[n];if(t.length!==1)return!1;const e=t[0];return e.kinds&&Array.isArray(e.kinds)&&e.kinds.length===1&&e.authors&&Array.isArray(e.authors)&&e.authors.length===1&&e["#d"]&&Array.isArray(e["#d"])&&e["#d"].length===1}function isReplaceableEventFilter(n){const t=Array.isArray(n)?n:[n];return t.length===0?!1:t.every(e=>!e.kinds||!Array.isArray(e.kinds)||e.kinds.length===0||!e.authors||!Array.isArray(e.authors)||e.authors.length===0?!1:e.kinds.every(i=>i===0||i===3||i>=1e4&&i<=19999))}function formatFilter(n){return JSON.stringify(n,null,2).split(`
`).map((e,s)=>s===0?e:`   ${e}`).join(`
`)}function fetchingEvents(n,t,e,s,i){if(i(),(t==null?void 0:t.cacheUsage)==="ONLY_CACHE")return;const r=Array.isArray(n)?n:[n],a=r.map(formatFilter).join(`

   ---

   `);if(isNip33Pattern(n))r[0],e("fetch-events-usage",`For fetching a NIP-33 addressable event, use fetchEvent() with the naddr directly.

 Your filter:
   `+a+`

   BAD:  const decoded = nip19.decode(naddr);
           const events = await ndk.fetchEvents({
             kinds: [decoded.data.kind],
             authors: [decoded.data.pubkey],
             "#d": [decoded.data.identifier]
           });
           const event = Array.from(events)[0];

   GOOD: const event = await ndk.fetchEvent(naddr);
   GOOD: const event = await ndk.fetchEvent('naddr1...');

fetchEvent() handles naddr decoding automatically and returns the event directly.`);else{if(isReplaceableEventFilter(n))return;{if(!s())return;let o="";const l=r.some(f=>f.limit!==void 0),h=new Set(r.flatMap(f=>f.kinds||[])).size,u=new Set(r.flatMap(f=>f.authors||[])).size;if(l){const f=Math.max(...r.map(p=>p.limit||0));o+=`
    Limit: ${f} event${f!==1?"s":""}`}h>0&&(o+=`
    Kinds: ${h} type${h!==1?"s":""}`),u>0&&(o+=`
    Authors: ${u} author${u!==1?"s":""}`),e("fetch-events-usage",`fetchEvents() is a BLOCKING operation that waits for EOSE.
In most cases, you should use subscribe() instead.

 Your filter`+(r.length>1?"s":"")+`:
   `+a+(o?`

 Filter analysis:`+o:"")+`

   BAD:  const events = await ndk.fetchEvents(filter);
   GOOD: ndk.subscribe(filter, { onEvent: (e) => ... });

Only use fetchEvents() when you MUST block until data arrives.`,"For one-time queries, use fetchEvent() instead of fetchEvents() when expecting a single result.")}}}var GuardrailCheckId={NDK_NO_CACHE:"ndk-no-cache",FILTER_BECH32_IN_ARRAY:"filter-bech32-in-array",FILTER_INVALID_HEX:"filter-invalid-hex",FILTER_ONLY_LIMIT:"filter-only-limit",FILTER_EMPTY:"filter-empty",FILTER_SINCE_AFTER_UNTIL:"filter-since-after-until",FILTER_INVALID_A_TAG:"filter-invalid-a-tag",FILTER_HASHTAG_WITH_PREFIX:"filter-hashtag-with-prefix"};function checkCachePresence(n,t){t(GuardrailCheckId.NDK_NO_CACHE)&&setTimeout(()=>{if(!n.cacheAdapter){const i=`
 AI_GUARDRAILS WARNING: NDK initialized without a cache adapter. Apps perform significantly better with caching.

 ${typeof window<"u"?"Consider using @nostr-dev-kit/ndk-cache-dexie or @nostr-dev-kit/ndk-cache-sqlite-wasm":"Consider using @nostr-dev-kit/ndk-cache-redis or @nostr-dev-kit/ndk-cache-sqlite"}

 To disable this check:
   ndk.aiGuardrails.skip('${GuardrailCheckId.NDK_NO_CACHE}')
   or set: ndk.aiGuardrails = { skip: new Set(['${GuardrailCheckId.NDK_NO_CACHE}']) }`;console.warn(i)}},2500)}var AIGuardrails=class{constructor(n=!1){c(this,"enabled",!1);c(this,"skipSet",new Set);c(this,"extensions",new Map);c(this,"_nextCallDisabled",null);c(this,"_replyEvents",new WeakSet);c(this,"_fetchEventsCount",0);c(this,"_subscribeCount",0);c(this,"ndk",{fetchingEvents:(n,t)=>{this.enabled&&fetchingEvents(n,t,this.warn.bind(this),this.shouldWarnAboutFetchEventsRatio.bind(this),this.incrementFetchEventsCount.bind(this))}});c(this,"event",{signing:n=>{this.enabled&&signing(n,this.error.bind(this),this.warn.bind(this),this._replyEvents)},publishing:n=>{this.enabled&&publishing(n,this.warn.bind(this))},received:(n,t)=>{this.enabled},creatingReply:n=>{this.enabled&&this._replyEvents.add(n)}});c(this,"subscription",{created:(n,t)=>{this.enabled&&this.incrementSubscribeCount()}});c(this,"relay",{connected:n=>{this.enabled}});this.setMode(n)}register(n,t){this.extensions.has(n)&&console.warn(`AIGuardrails: Extension '${n}' already registered, overwriting`);const e={};for(const[s,i]of Object.entries(t))typeof i=="function"&&(e[s]=(...r)=>{this.enabled&&i(...r,this.shouldCheck.bind(this),this.error.bind(this),this.warn.bind(this))});this.extensions.set(n,e),this[n]=e}setMode(n){typeof n=="boolean"?(this.enabled=n,this.skipSet.clear()):n&&typeof n=="object"&&(this.enabled=!0,this.skipSet=n.skip||new Set)}isEnabled(){return this.enabled}shouldCheck(n){return!(!this.enabled||this.skipSet.has(n)||this._nextCallDisabled==="all"||this._nextCallDisabled&&this._nextCallDisabled.has(n))}skip(n){this.skipSet.add(n)}enable(n){this.skipSet.delete(n)}getSkipped(){return Array.from(this.skipSet)}captureAndClearNextCallDisabled(){const n=this._nextCallDisabled;return this._nextCallDisabled=null,n}incrementFetchEventsCount(){this._fetchEventsCount++}incrementSubscribeCount(){this._subscribeCount++}shouldWarnAboutFetchEventsRatio(){const n=this._fetchEventsCount+this._subscribeCount;return n<=6?!1:this._fetchEventsCount/n>.5}error(n,t,e,s=!0){if(!this.shouldCheck(n))return;const i=this.formatMessage(n,"ERROR",t,e,s);throw console.error(i),new Error(i)}warn(n,t,e){if(!this.shouldCheck(n))return;const s=this.formatMessage(n,"WARNING",t,e,!0);throw console.error(s),new Error(s)}formatMessage(n,t,e,s,i=!0){let r=`
 AI_GUARDRAILS ${t}: ${e}`;return s&&(r+=`

 ${s}`),i&&(r+=`

 To disable this check:
   ndk.guardrailOff('${n}').yourMethod()  // For one call`,r+=`
   ndk.aiGuardrails.skip('${n}')  // Permanently`,r+=`
   or set: ndk.aiGuardrails = { skip: new Set(['${n}']) }`),r}ndkInstantiated(n){this.enabled&&checkCachePresence(n,this.shouldCheck.bind(this))}};function processFilters(n,t="validate",e,s){if(t==="ignore")return n;const i=[],r=n.map((a,o)=>(s!=null&&s.aiGuardrails.isEnabled()&&runAIGuardrailsForFilter(a,o,s),processFilter(a,t,o,i,e)));if(t==="validate"&&i.length>0)throw new Error(`Invalid filter(s) detected:
${i.join(`
`)}`);return r}function processFilter(n,t,e,s,i){const r=t==="validate",a=r?n:{...n};if(n.ids){const o=[];n.ids.forEach((l,h)=>{l===void 0?r?s.push(`Filter[${e}].ids[${h}] is undefined`):i==null||i(`Fixed: Removed undefined value at ids[${h}]`):typeof l!="string"?r?s.push(`Filter[${e}].ids[${h}] is not a string (got ${typeof l})`):i==null||i(`Fixed: Removed non-string value at ids[${h}] (was ${typeof l})`):isValidHex64(l)?o.push(l):r?s.push(`Filter[${e}].ids[${h}] is not a valid 64-char hex string: "${l}"`):i==null||i(`Fixed: Removed invalid hex string at ids[${h}]`)}),r||(a.ids=o.length>0?o:void 0)}if(n.authors){const o=[];n.authors.forEach((l,h)=>{l===void 0?r?s.push(`Filter[${e}].authors[${h}] is undefined`):i==null||i(`Fixed: Removed undefined value at authors[${h}]`):typeof l!="string"?r?s.push(`Filter[${e}].authors[${h}] is not a string (got ${typeof l})`):i==null||i(`Fixed: Removed non-string value at authors[${h}] (was ${typeof l})`):isValidHex64(l)?o.push(l):r?s.push(`Filter[${e}].authors[${h}] is not a valid 64-char hex pubkey: "${l}"`):i==null||i(`Fixed: Removed invalid hex pubkey at authors[${h}]`)}),r||(a.authors=o.length>0?o:void 0)}if(n.kinds){const o=[];n.kinds.forEach((l,h)=>{l===void 0?r?s.push(`Filter[${e}].kinds[${h}] is undefined`):i==null||i(`Fixed: Removed undefined value at kinds[${h}]`):typeof l!="number"?r?s.push(`Filter[${e}].kinds[${h}] is not a number (got ${typeof l})`):i==null||i(`Fixed: Removed non-number value at kinds[${h}] (was ${typeof l})`):Number.isInteger(l)?l<0||l>65535?r?s.push(`Filter[${e}].kinds[${h}] is out of valid range (0-65535): ${l}`):i==null||i(`Fixed: Removed out-of-range kind at kinds[${h}]: ${l}`):o.push(l):r?s.push(`Filter[${e}].kinds[${h}] is not an integer: ${l}`):i==null||i(`Fixed: Removed non-integer value at kinds[${h}]: ${l}`)}),r||(a.kinds=o.length>0?o:void 0)}for(const o in n)if(o.startsWith("#")&&o.length===2){const l=n[o];if(Array.isArray(l)){const h=[];l.forEach((u,f)=>{u===void 0?r?s.push(`Filter[${e}].${o}[${f}] is undefined`):i==null||i(`Fixed: Removed undefined value at ${o}[${f}]`):typeof u!="string"?r?s.push(`Filter[${e}].${o}[${f}] is not a string (got ${typeof u})`):i==null||i(`Fixed: Removed non-string value at ${o}[${f}] (was ${typeof u})`):(o==="#e"||o==="#p")&&!isValidHex64(u)?r?s.push(`Filter[${e}].${o}[${f}] is not a valid 64-char hex string: "${u}"`):i==null||i(`Fixed: Removed invalid hex string at ${o}[${f}]`):h.push(u)}),r||(a[o]=h.length>0?h:void 0)}}return r||Object.keys(a).forEach(o=>{a[o]===void 0&&delete a[o]}),a}function runAIGuardrailsForFilter(n,t,e){const s=e.aiGuardrails,i=JSON.stringify(n,null,2);if(Object.keys(n).length===1&&n.limit!==void 0&&s.error(GuardrailCheckId.FILTER_ONLY_LIMIT,`Filter[${t}] contains only 'limit' without any filtering criteria.

 Your filter:
${i}

  This will fetch random events from relays without any criteria.`,`Add filtering criteria:
    { kinds: [1], limit: 10 }
    { authors: [pubkey], limit: 10 }
    { limit: 10 }`),Object.keys(n).length===0&&s.error(GuardrailCheckId.FILTER_EMPTY,`Filter[${t}] is empty.

 Your filter:
${i}

  This will request ALL events from relays, which is never what you want.`,"Add filtering criteria like 'kinds', 'authors', or tags.",!1),n.since!==void 0&&n.until!==void 0&&n.since>n.until){const a=new Date(n.since*1e3).toISOString(),o=new Date(n.until*1e3).toISOString();s.error(GuardrailCheckId.FILTER_SINCE_AFTER_UNTIL,`Filter[${t}] has 'since' AFTER 'until'.

 Your filter:
${i}

 since: ${n.since} (${a})
 until: ${n.until} (${o})

No events can match this time range!`,"'since' must be BEFORE 'until'. Both are Unix timestamps in seconds.",!1)}const r=/^n(addr|event|ote|pub|profile)1/;n.ids&&n.ids.forEach((a,o)=>{typeof a=="string"&&(r.test(a)?s.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${t}].ids[${o}] contains bech32: "${a}". IDs must be hex, not bech32.`,'Use filterFromId() to decode bech32 first: import { filterFromId } from "@nostr-dev-kit/ndk"',!1):isValidHex64(a)||s.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${t}].ids[${o}] is not a valid 64-char hex string: "${a}"`,`Event IDs must be 64-character hexadecimal strings. Invalid IDs often come from corrupted data in user-generated lists. Always validate hex strings before using them in filters:

   const validIds = ids.filter(id => /^[0-9a-f]{64}$/i.test(id));`,!1))}),n.authors&&n.authors.forEach((a,o)=>{typeof a=="string"&&(r.test(a)?s.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${t}].authors[${o}] contains bech32: "${a}". Authors must be hex pubkeys, not npub.`,"Use ndkUser.pubkey instead. Example: { authors: [ndkUser.pubkey] }",!1):isValidHex64(a)||s.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${t}].authors[${o}] is not a valid 64-char hex pubkey: "${a}"`,`Kind:3 follow lists can contain invalid entries like labels ("Follow List"), partial strings ("highlig"), or other corrupted data. You MUST validate all pubkeys before using them in filters.

   Example:
   const validPubkeys = pubkeys.filter(p => /^[0-9a-f]{64}$/i.test(p));
   ndk.subscribe({ authors: validPubkeys, kinds: [1] });`,!1))});for(const a in n)if(a.startsWith("#")&&a.length===2){const o=n[a];Array.isArray(o)&&o.forEach((l,h)=>{typeof l=="string"&&(a==="#e"||a==="#p")&&(r.test(l)?s.error(GuardrailCheckId.FILTER_BECH32_IN_ARRAY,`Filter[${t}].${a}[${h}] contains bech32: "${l}". Tag values must be decoded.`,"Use filterFromId() or nip19.decode() to get the hex value first.",!1):isValidHex64(l)||s.error(GuardrailCheckId.FILTER_INVALID_HEX,`Filter[${t}].${a}[${h}] is not a valid 64-char hex string: "${l}"`,`${a==="#e"?"Event IDs":"Public keys"} in tag filters must be 64-character hexadecimal strings. Kind:3 follow lists and other user-generated content can contain invalid data. Always filter before using:

   const validValues = values.filter(v => /^[0-9a-f]{64}$/i.test(v));`,!1))})}if(n["#a"]){const a=n["#a"];a==null||a.forEach((o,l)=>{if(typeof o=="string")if(!/^\d+:[0-9a-f]{64}:.*$/.test(o))s.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${t}].#a[${l}] has invalid format: "${o}". Must be "kind:pubkey:d-tag".`,'Example: "30023:fa984bd7dbb282f07e16e7ae87b26a2a7b9b90b7246a44771f0cf5ae58018f52:my-article"',!1);else{const h=Number.parseInt(o.split(":")[0],10);(h<3e4||h>39999)&&s.error(GuardrailCheckId.FILTER_INVALID_A_TAG,`Filter[${t}].#a[${l}] uses non-addressable kind ${h}: "${o}". #a filters are only for addressable events (kinds 30000-39999).`,`Addressable events include:
    30000-30039: Parameterized Replaceable Events (profiles, settings, etc.)
    30040-39999: Other addressable events

For regular events (kind ${h}), use:
    #e filter for specific event IDs
    kinds + authors filters for event queries`,!1)}})}if(n["#t"]){const a=n["#t"];a==null||a.forEach((o,l)=>{typeof o=="string"&&o.startsWith("#")&&s.error(GuardrailCheckId.FILTER_HASHTAG_WITH_PREFIX,`Filter[${t}].#t[${l}] contains hashtag with # prefix: "${o}". Hashtag values should NOT include the # symbol.`,`Remove the # prefix from hashtag filters:
    { "#t": ["nostr"] }
    { "#t": ["#nostr"] }`,!1)})}}function queryFullyFilled(n){return!!(filterIncludesIds(n.filter)&&resultHasAllRequestedIds(n))}function filterIncludesIds(n){return!!n.ids}function resultHasAllRequestedIds(n){const t=n.filter.ids;return!!t&&t.length===n.eventFirstSeen.size}function filterFromId(n){let t;if(n.match(NIP33_A_REGEX)){const[e,s,i]=n.split(":"),r={authors:[s],kinds:[Number.parseInt(e)]};return i&&(r["#d"]=[i]),r}if(n.match(BECH32_REGEX))try{switch(t=nip19_exports$2.decode(n),t.type){case"nevent":{const e={ids:[t.data.id]};return t.data.author&&(e.authors=[t.data.author]),t.data.kind&&(e.kinds=[t.data.kind]),e}case"note":return{ids:[t.data]};case"naddr":{const e={authors:[t.data.pubkey],kinds:[t.data.kind]};return t.data.identifier&&(e["#d"]=[t.data.identifier]),e}}}catch(e){console.error("Error decoding",n,e)}return{ids:[n]}}function isNip33AValue(n){return n.match(NIP33_A_REGEX)!==null}var NIP33_A_REGEX=/^(\d+):([0-9A-Fa-f]+)(?::(.*))?$/,BECH32_REGEX=/^n(event|ote|profile|pub|addr)1[\d\w]+$/;function relaysFromBech32(n,t){try{const e=nip19_exports$2.decode(n);if(["naddr","nevent"].includes(e==null?void 0:e.type)){const s=e.data;if(s!=null&&s.relays)return s.relays.map(i=>new NDKRelay$1(i,t.relayAuthDefaultPolicy,t))}}catch{}return[]}var NDKSubscriptionCacheUsage=(n=>(n.ONLY_CACHE="ONLY_CACHE",n.CACHE_FIRST="CACHE_FIRST",n.PARALLEL="PARALLEL",n.ONLY_RELAY="ONLY_RELAY",n))(NDKSubscriptionCacheUsage||{}),defaultOpts={closeOnEose:!1,cacheUsage:"CACHE_FIRST",dontSaveToCache:!1,groupable:!0,groupableDelay:100,groupableDelayType:"at-most",cacheUnconstrainFilter:["limit","since","until"],includeMuted:!1},NDKSubscription=class extends libExports.EventEmitter{constructor(t,e,s,i){super();c(this,"subId");c(this,"filters");c(this,"opts");c(this,"pool");c(this,"skipVerification",!1);c(this,"skipValidation",!1);c(this,"exclusiveRelay",!1);c(this,"relayFilters");c(this,"relaySet");c(this,"ndk");c(this,"debug");c(this,"eventFirstSeen",new Map);c(this,"eosesSeen",new Set);c(this,"lastEventReceivedAt");c(this,"mostRecentCacheEventTimestamp");c(this,"internalId");c(this,"closeOnEose");c(this,"poolMonitor");c(this,"skipOptimisticPublishEvent",!1);c(this,"cacheUnconstrainFilter");c(this,"onStopped");c(this,"eoseTimeout");c(this,"eosed",!1);this.ndk=t,this.opts={...defaultOpts,...s||{}},this.pool=this.opts.pool||t.pool;const r=Array.isArray(e)?e:[e],a=t.filterValidationMode==="validate"?"validate":t.filterValidationMode==="fix"?"fix":"ignore";if(this.filters=processFilters(r,a,t.debug,t),this.filters.length===0)throw new Error("Subscription must have at least one filter");this.subId=i||this.opts.subId,this.internalId=Math.random().toString(36).substring(7),this.debug=t.debug.extend(`subscription[${this.opts.subId??this.internalId}]`),this.opts.relaySet?this.relaySet=this.opts.relaySet:this.opts.relayUrls&&(this.relaySet=NDKRelaySet$1.fromRelayUrls(this.opts.relayUrls,this.ndk)),this.skipVerification=this.opts.skipVerification||!1,this.skipValidation=this.opts.skipValidation||!1,this.closeOnEose=this.opts.closeOnEose||!1,this.skipOptimisticPublishEvent=this.opts.skipOptimisticPublishEvent||!1,this.cacheUnconstrainFilter=this.opts.cacheUnconstrainFilter,this.exclusiveRelay=this.opts.exclusiveRelay||!1,this.opts.onEvent&&this.on("event",this.opts.onEvent),this.opts.onEose&&this.on("eose",this.opts.onEose),this.opts.onClose&&this.on("close",this.opts.onClose)}relaysMissingEose(){var e;return this.relayFilters?Array.from((e=this.relayFilters)==null?void 0:e.keys()).filter(s=>!this.eosesSeen.has(this.pool.getRelay(s,!1,!1))):[]}get filter(){return this.filters[0]}get groupableDelay(){var t;if(this.isGroupable())return(t=this.opts)==null?void 0:t.groupableDelay}get groupableDelayType(){var t;return((t=this.opts)==null?void 0:t.groupableDelayType)||"at-most"}isGroupable(){var t;return((t=this.opts)==null?void 0:t.groupable)||!1}shouldQueryCache(){var e;return this.opts.addSinceFromCache?!0:((e=this.opts)==null?void 0:e.cacheUsage)==="ONLY_RELAY"?!1:(this.filters.some(s=>{var i;return(i=s.kinds)==null?void 0:i.some(r=>kindIsEphemeral(r))}),!0)}shouldQueryRelays(){var t;return((t=this.opts)==null?void 0:t.cacheUsage)!=="ONLY_CACHE"}shouldWaitForCache(){var t;return this.opts.addSinceFromCache?!0:!!this.opts.closeOnEose&&!!((t=this.ndk.cacheAdapter)!=null&&t.locking)&&this.opts.cacheUsage!=="PARALLEL"}start(t=!0){let e;const s=r=>{for(const a of r)a.created_at&&(!this.mostRecentCacheEventTimestamp||a.created_at>this.mostRecentCacheEventTimestamp)&&(this.mostRecentCacheEventTimestamp=a.created_at),this.eventReceived(a,void 0,!0,!1);t||(e=r)},i=()=>{this.shouldQueryRelays()?(this.startWithRelays(),this.startPoolMonitor()):this.emit("eose",this)};return this.shouldQueryCache()?(e=this.startWithCache(),e instanceof Promise?this.shouldWaitForCache()?(e.then(r=>{if(s(r),queryFullyFilled(this)){this.emit("eose",this);return}i()}),null):(e.then(r=>{s(r),this.shouldQueryRelays()||this.emit("eose",this)}),this.shouldQueryRelays()&&i(),null):(s(e),queryFullyFilled(this)?this.emit("eose",this):i(),e)):(i(),null)}startPoolMonitor(){this.debug.extend("pool-monitor"),this.poolMonitor=t=>{var s,i;if((s=this.relayFilters)!=null&&s.has(t.url))return;calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor).get(t.url)&&((i=this.relayFilters)==null||i.set(t.url,this.filters),t.subscribe(this,this.filters))},this.pool.on("relay:connect",this.poolMonitor)}stop(){var t;this.emit("close",this),this.poolMonitor&&this.pool.off("relay:connect",this.poolMonitor),(t=this.onStopped)==null||t.call(this)}hasAuthorsFilter(){return this.filters.some(t=>{var e;return(e=t.authors)==null?void 0:e.length})}startWithCache(){var t;return(t=this.ndk.cacheAdapter)!=null&&t.query?this.ndk.cacheAdapter.query(this):[]}startWithRelays(){let t=this.filters;if(this.opts.addSinceFromCache&&this.mostRecentCacheEventTimestamp){const e=this.mostRecentCacheEventTimestamp+1;t=t.map(s=>({...s,since:Math.max(s.since||0,e)}))}if(!this.relaySet||this.relaySet.relays.size===0)this.relayFilters=calculateRelaySetsFromFilters(this.ndk,t,this.pool,this.opts.relayGoalPerAuthor);else{this.relayFilters=new Map;for(const e of this.relaySet.relays)this.relayFilters.set(e.url,t)}for(const[e,s]of this.relayFilters)this.pool.getRelay(e,!0,!0,s).subscribe(this,s)}refreshRelayConnections(){var e,s;if(this.relaySet&&this.relaySet.relays.size>0)return;const t=calculateRelaySetsFromFilters(this.ndk,this.filters,this.pool,this.opts.relayGoalPerAuthor);for(const[i,r]of t)(e=this.relayFilters)!=null&&e.has(i)||((s=this.relayFilters)==null||s.set(i,r),this.pool.getRelay(i,!0,!0,r).subscribe(this,r))}eventReceived(t,e,s=!1,i=!1){var l,h,u;const r=t.id,a=this.eventFirstSeen.has(r);let o;if(t instanceof NDKEvent$1&&(o=t),a){const f=Date.now()-(this.eventFirstSeen.get(r)||0);if(this.emit("event:dup",t,e,f,this,s,i),(h=this.opts)!=null&&h.onEventDup&&this.opts.onEventDup(t,e,f,this,s,i),!s&&!i&&e&&((u=this.ndk.cacheAdapter)!=null&&u.setEventDup)&&!this.opts.dontSaveToCache&&(o??(o=t instanceof NDKEvent$1?t:new NDKEvent$1(this.ndk,t)),this.ndk.cacheAdapter.setEventDup(o,e)),e){const p=verifiedSignatures$1.get(r);if(p&&typeof p=="string")if(t.sig===p)e.addValidatedEvent();else{const g=t instanceof NDKEvent$1?t:new NDKEvent$1(this.ndk,t);this.ndk.reportInvalidSignature(g,e)}}}else{if(o??(o=new NDKEvent$1(this.ndk,t)),o.ndk=this.ndk,o.relay=e,!s&&!i){if(!this.skipValidation&&!o.isValid){this.debug("Event failed validation %s from relay %s",r,e==null?void 0:e.url);return}if(e)if(e.shouldValidateEvent()&&!this.skipVerification)if(o.relay=e,this.ndk.asyncSigVerification)o.verifySignature(!0);else{if(!o.verifySignature(!0)){this.debug("Event failed signature validation",t),this.ndk.reportInvalidSignature(o,e);return}e.addValidatedEvent()}else e.addNonValidatedEvent();this.ndk.cacheAdapter&&!this.opts.dontSaveToCache&&this.ndk.cacheAdapter.setEvent(o,this.filters,e)}if(!this.opts.includeMuted&&this.ndk.muteFilter&&this.ndk.muteFilter(o)){this.debug("Event muted, skipping");return}(!i||this.skipOptimisticPublishEvent!==!0)&&(this.emitEvent(((l=this.opts)==null?void 0:l.wrap)??!1,o,e,s,i),this.eventFirstSeen.set(r,Date.now()))}this.lastEventReceivedAt=Date.now()}emitEvent(t,e,s,i,r){const a=t?wrapEvent(e):e;a instanceof Promise?a.then(o=>this.emitEvent(!1,o,s,i,r)):a&&this.emit("event",a,s,this,i,r)}closedReceived(t,e){this.emit("closed",t,e)}eoseReceived(t){var a;this.debug("EOSE received from %s",t.url),this.eosesSeen.add(t);let e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0;const s=this.eosesSeen.size===((a=this.relayFilters)==null?void 0:a.size),i=queryFullyFilled(this),r=o=>{var l;this.debug("Performing EOSE: %s %d",o,this.eosed),!this.eosed&&(this.eoseTimeout&&clearTimeout(this.eoseTimeout),this.emit("eose",this),this.eosed=!0,(l=this.opts)!=null&&l.closeOnEose&&this.stop())};if(i||s)r("query filled or seen all");else if(this.relayFilters){let o=1e3;const l=new Set(this.pool.connectedRelays().map(f=>f.url)),h=Array.from(this.relayFilters.keys()).filter(f=>l.has(f));if(h.length===0){this.debug("No connected relays, waiting for all relays to connect",Array.from(this.relayFilters.keys()).join(", "));return}const u=this.eosesSeen.size/h.length;if(this.debug("Percentage of relays that have sent EOSE",{subId:this.subId,percentageOfRelaysThatHaveSentEose:u,seen:this.eosesSeen.size,total:h.length}),this.eosesSeen.size>=2&&u>=.5){if(o=o*(1-u),o===0){r("time to wait was 0");return}this.eoseTimeout&&clearTimeout(this.eoseTimeout);const f=()=>{e=this.lastEventReceivedAt?Date.now()-this.lastEventReceivedAt:void 0,e!==void 0&&e<20?this.eoseTimeout=setTimeout(f,o):r(`send eose timeout: ${o}`)};this.eoseTimeout=setTimeout(f,o)}}}},kindIsEphemeral=n=>n>=2e4&&n<3e4;async function follows$1(n,t,e=3){var i,r;if(!this.ndk)throw new Error("NDK not set");const s=await this.ndk.fetchEvent({kinds:[e],authors:[this.pubkey]},n||{groupable:!1});if(s){const a=new Set;return s.tags.forEach(o=>{o[0]==="p"&&o[1]&&isValidPubkey(o[1])&&a.add(o[1])}),t&&((r=(i=this.ndk)==null?void 0:i.outboxTracker)==null||r.trackUsers(Array.from(a))),[...a].reduce((o,l)=>{const h=new NDKUser$1({pubkey:l});return h.ndk=this.ndk,o.add(h),o},new Set)}return new Set}var NIP05_REGEX$1=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For$1(n,t,e=fetch,s={}){return await n.queuesNip05.add({id:t,func:async()=>{var l,h,u;if((l=n.cacheAdapter)!=null&&l.loadNip05){const f=await n.cacheAdapter.loadNip05(t);if(f!=="missing"){if(f){const p=new NDKUser$1({pubkey:f.pubkey,relayUrls:f.relays,nip46Urls:f.nip46});return p.ndk=n,p}if(s.cache!=="no-cache")return null}}const i=t.match(NIP05_REGEX$1);if(!i)return null;const[r,a="_",o]=i;try{const f=await e(`https://${o}/.well-known/nostr.json?name=${a}`,s),{names:p,relays:g,nip46:m}=parseNIP05Result$1(await f.json()),w=p[a.toLowerCase()];let b=null;return w&&(b={pubkey:w,relays:g==null?void 0:g[w],nip46:m==null?void 0:m[w]}),(h=n==null?void 0:n.cacheAdapter)!=null&&h.saveNip05&&n.cacheAdapter.saveNip05(t,b),b}catch(f){return(u=n==null?void 0:n.cacheAdapter)!=null&&u.saveNip05&&(n==null||n.cacheAdapter.saveNip05(t,null)),console.error("Failed to fetch NIP05 for",t,f),null}}})}function parseNIP05Result$1(n){const t={names:{}};for(const[e,s]of Object.entries(n.names))typeof e=="string"&&typeof s=="string"&&(t.names[e.toLowerCase()]=s);if(n.relays){t.relays={};for(const[e,s]of Object.entries(n.relays))typeof e=="string"&&Array.isArray(s)&&(t.relays[e]=s.filter(i=>typeof i=="string"))}if(n.nip46){t.nip46={};for(const[e,s]of Object.entries(n.nip46))typeof e=="string"&&Array.isArray(s)&&(t.nip46[e]=s.filter(i=>typeof i=="string"))}return t}function profileFromEvent$1(n){const t={};let e;try{e=JSON.parse(n.content)}catch(s){throw new Error(`Failed to parse profile event: ${s}`)}t.profileEvent=JSON.stringify(n.rawEvent());for(const s of Object.keys(e))switch(s){case"name":t.name=e.name;break;case"display_name":t.displayName=e.display_name;break;case"image":case"picture":t.picture=e.picture||e.image,t.image=t.picture;break;case"banner":t.banner=e.banner;break;case"bio":t.bio=e.bio;break;case"nip05":t.nip05=e.nip05;break;case"lud06":t.lud06=e.lud06;break;case"lud16":t.lud16=e.lud16;break;case"about":t.about=e.about;break;case"website":t.website=e.website;break;default:t[s]=e[s];break}return t.created_at=n.created_at,t}function serializeProfile$1(n){const t={};for(const[e,s]of Object.entries(n))switch(e){case"username":case"name":t.name=s;break;case"displayName":t.display_name=s;break;case"image":case"picture":t.picture=s;break;case"bio":case"about":t.about=s;break;default:t[e]=s;break}return JSON.stringify(t)}var NDKUser$1=class xe{constructor(t){c(this,"ndk");c(this,"profile");c(this,"profileEvent");c(this,"_npub");c(this,"_pubkey");c(this,"relayUrls",[]);c(this,"nip46Urls",[]);c(this,"follows",follows$1.bind(this));if(t.npub&&(this._npub=t.npub),t.hexpubkey&&(this._pubkey=t.hexpubkey),t.pubkey&&(this._pubkey=t.pubkey),t.relayUrls&&(this.relayUrls=t.relayUrls),t.nip46Urls&&(this.nip46Urls=t.nip46Urls),t.nprofile)try{const e=nip19_exports$2.decode(t.nprofile);e.type==="nprofile"&&(this._pubkey=e.data.pubkey,e.data.relays&&e.data.relays.length>0&&this.relayUrls.push(...e.data.relays))}catch(e){console.error("Failed to decode nprofile",e)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$2.npubEncode(this.pubkey)}return this._npub}get nprofile(){var e,s;const t=(s=(e=this.profileEvent)==null?void 0:e.onRelays)==null?void 0:s.map(i=>i.url);return nip19_exports$2.nprofileEncode({pubkey:this.pubkey,relays:t})}set npub(t){this._npub=t}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$2.decode(this.npub).data}return this._pubkey}set pubkey(t){this._pubkey=t}filter(){return{"#p":[this.pubkey]}}async getZapInfo(t){if(!this.ndk)throw new Error("No NDK instance found");const e=async a=>{if(!t)return a;let o;const l=new Promise((h,u)=>{o=setTimeout(()=>u(new Error("Timeout")),t)});try{const h=await Promise.race([a,l]);return o&&clearTimeout(o),h}catch(h){if(h instanceof Error&&h.message==="Timeout")try{return await a}catch{return}return}},[s,i]=await Promise.all([e(this.fetchProfile()),e(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),r=new Map;if(i){const a=NDKCashuMintList$1.from(i);a.mints.length>0&&r.set("nip61",{mints:a.mints,relays:a.relays,p2pk:a.p2pk})}if(s){const{lud06:a,lud16:o}=s;r.set("nip57",{lud06:a,lud16:o})}return r}static async fromNip05(t,e,s=!1){if(!e)throw new Error("No NDK instance found");const i={};s&&(i.cache="no-cache");const r=await getNip05For$1(e,t,e==null?void 0:e.httpFetch,i);if(r){const a=new xe({pubkey:r.pubkey,relayUrls:r.relays,nip46Urls:r.nip46});return a.ndk=e,a}}async fetchProfile(t,e=!1){if(!this.ndk)throw new Error("NDK not set");let s=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&(t==null?void 0:t.cacheUsage)!=="ONLY_RELAY"){let i=null;if(this.ndk.cacheAdapter.fetchProfileSync?i=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(i=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),i)return this.profile=i,i}return t??(t={}),t.cacheUsage??(t.cacheUsage="ONLY_RELAY"),t.closeOnEose??(t.closeOnEose=!0),t.groupable??(t.groupable=!0),t.groupableDelay??(t.groupableDelay=250),s||(s=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},t)),s?(this.profile=profileFromEvent$1(s),e&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}async followSet(t,e,s=3){const i=await this.follows(t,e,s);return new Set(Array.from(i).map(r=>r.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(t){const e=[["p",this.pubkey]];return t&&e[0].push("",t),e}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent$1(this.ndk,{kind:0,content:serializeProfile$1(this.profile)}).publish()}async follow(t,e,s=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,s));const i=typeof t=="string"?t:t.pubkey;if(Array.from(e).some(o=>typeof o=="string"?o===i:o.pubkey===i))return!1;e.add(t);const a=new NDKEvent$1(this.ndk,{kind:s});for(const o of e)typeof o=="string"?a.tags.push(["p",o]):a.tag(o);return await a.publish(),!0}async unfollow(t,e,s=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,s));const i=typeof t=="string"?t:t.pubkey,r=new Set;let a=!1;for(const l of e)(typeof l=="string"?l:l.pubkey)!==i?r.add(l):a=!0;if(!a)return!1;const o=new NDKEvent$1(this.ndk,{kind:s});for(const l of r)typeof l=="string"?o.tags.push(["p",l]):o.tag(l);return await o.publish()}async validateNip05(t){if(!this.ndk)throw new Error("No NDK instance found");const e=await getNip05For$1(this.ndk,t);return e===null?null:e.pubkey===this.pubkey}},signerRegistry$1=new Map;function registerSigner$1(n,t){signerRegistry$1.set(n,t)}var NDKPrivateKeySigner$1=class Ee{constructor(t,e){c(this,"_user");c(this,"_privateKey");c(this,"_pubkey");if(typeof t=="string")if(t.startsWith("nsec1")){const{type:s,data:i}=nip19_exports$2.decode(t);if(s==="nsec")this._privateKey=i;else throw new Error("Invalid private key provided.")}else if(t.length===64)this._privateKey=hexToBytes(t);else throw new Error("Invalid private key provided.");else this._privateKey=t;this._pubkey=getPublicKey(this._privateKey),e&&(this._user=e.getUser({pubkey:this._pubkey})),this._user??(this._user=new NDKUser$1({pubkey:this._pubkey}))}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$2.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$2.npubEncode(this._pubkey)}encryptToNcryptsec(t,e=16,s=2){if(!this._privateKey)throw new Error("Private key not available");return encrypt$2(this._privateKey,t,e,s)}static generate(){const t=generateSecretKey();return new Ee(t)}static fromNcryptsec(t,e,s){const i=decrypt$2(t,e);return new Ee(i,s)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(t){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(t,this._privateKey).sig}async encryptionEnabled(t){const e=[];return(!t||t==="nip04")&&e.push("nip04"),(!t||t==="nip44")&&e.push("nip44"),e}async encrypt(t,e,s){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const i=t.pubkey;if(s==="nip44"){const r=nip44_exports.v2.utils.getConversationKey(this._privateKey,i);return await nip44_exports.v2.encrypt(e,r)}return await nip04_exports.encrypt(this._privateKey,i,e)}async decrypt(t,e,s){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const i=t.pubkey;if(s==="nip44"){const r=nip44_exports.v2.utils.getConversationKey(this._privateKey,i);return await nip44_exports.v2.decrypt(e,r)}return await nip04_exports.decrypt(this._privateKey,i,e)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const t={type:"private-key",payload:this.privateKey};return JSON.stringify(t)}static async fromPayload(t,e){const s=JSON.parse(t);if(s.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${s.type}`);if(!s.payload||typeof s.payload!="string")throw new Error("Invalid payload content for private-key signer");return new Ee(s.payload,e)}};registerSigner$1("private-key",NDKPrivateKeySigner$1);function dedup(n,t){return n.created_at>t.created_at?n:t}async function getRelayListForUser(n,t){return(await getRelayListForUsers([n],t)).get(n)}async function getRelayListForUsers(n,t,e=!1,s=1e3,i){var p;const r=t.outboxPool||t.pool,a=new Set;for(const g of r.relays.values())a.add(g);if(i)for(const g of i.values())for(const m of g){const w=r.getRelay(m,!0,!0);w&&a.add(w)}const o=new Map,l=new Map,h=new NDKRelaySet$1(a,t);if((p=t.cacheAdapter)!=null&&p.locking&&!e){const g=await t.fetchEvents({kinds:[3,10002],authors:Array.from(new Set(n))},{cacheUsage:"ONLY_CACHE",subId:"ndk-relay-list-fetch"});for(const m of g)m.kind===10002&&o.set(m.pubkey,NDKRelayList.from(m));for(const m of g)if(m.kind===3){if(o.has(m.pubkey))continue;const w=relayListFromKind3(t,m);w&&l.set(m.pubkey,w)}n=n.filter(m=>!o.has(m)&&!l.has(m))}if(n.length===0)return o;const u=new Map,f=new Map;return new Promise(g=>{let m=!1;(async()=>{const b={closeOnEose:!0,pool:r,groupable:!0,subId:"ndk-relay-list-fetch",addSinceFromCache:!0,relaySet:h};h&&(b.relaySet=h),t.subscribe({kinds:[3,10002],authors:n},b,{onEvent:S=>{if(S.kind===10002){const y=u.get(S.pubkey);if(y&&y.created_at>S.created_at)return;u.set(S.pubkey,S)}else if(S.kind===3){const y=f.get(S.pubkey);if(y&&y.created_at>S.created_at)return;f.set(S.pubkey,S)}},onEose:()=>{if(!m){m=!0,t.debug(`[getRelayListForUsers] EOSE - relayListEvents: ${u.size}, contactListEvents: ${f.size}`);for(const S of u.values())o.set(S.pubkey,NDKRelayList.from(S));for(const S of n){if(o.has(S))continue;const y=f.get(S);if(!y)continue;const v=relayListFromKind3(t,y);v&&o.set(S,v)}t.debug(`[getRelayListForUsers] Returning ${o.size} relay lists for ${n.length} pubkeys`),g(o)}}});const E=Array.from(a).some(S=>S.status<=2),$=Array.from(a).some(S=>S.status===4);let _=s;(E||$)&&(_=s+3e3),t.debug(`[getRelayListForUsers] Setting fallback timeout to ${_}ms (disconnected: ${E}, connecting: ${$})`,{pubkeys:n}),setTimeout(()=>{m||(m=!0,t.debug(`[getRelayListForUsers] Timeout reached, returning ${o.size} relay lists`),g(o))},_)})()})}var OutboxItem=class{constructor(n){c(this,"type");c(this,"relayUrlScores");c(this,"readRelays");c(this,"writeRelays");this.type=n,this.relayUrlScores=new Map,this.readRelays=new Set,this.writeRelays=new Set}},OutboxTracker=class extends libExports.EventEmitter{constructor(t){super();c(this,"data");c(this,"ndk");c(this,"debug");this.ndk=t,this.debug=t.debug.extend("outbox-tracker"),this.data=new distExports.LRUCache({maxSize:1e5,entryExpirationTimeInMS:120*1e3})}async trackUsers(t,e=!1){const s=[];for(let i=0;i<t.length;i+=400){const r=t.slice(i,i+400),a=r.map(l=>getKeyFromItem(l)).filter(l=>!this.data.has(l));if(a.length===0)continue;for(const l of a)this.data.set(l,new OutboxItem("user"));const o=new Map;for(const l of r)l instanceof NDKUser$1&&l.relayUrls.length>0&&o.set(l.pubkey,l.relayUrls);s.push(new Promise(l=>{getRelayListForUsers(a,this.ndk,e,1e3,o).then(h=>{this.debug(`Received relay lists for ${h.size} pubkeys out of ${a.length} requested`);for(const[u,f]of h){let p=this.data.get(u);if(p??(p=new OutboxItem("user")),f){if(p.readRelays=new Set(normalize(f.readRelayUrls)),p.writeRelays=new Set(normalize(f.writeRelayUrls)),this.ndk.relayConnectionFilter){for(const g of p.readRelays)this.ndk.relayConnectionFilter(g)||p.readRelays.delete(g);for(const g of p.writeRelays)this.ndk.relayConnectionFilter(g)||p.writeRelays.delete(g)}this.data.set(u,p),this.emit("user:relay-list-updated",u,p),this.debug(`Adding ${p.readRelays.size} read relays and ${p.writeRelays.size} write relays for ${u}`,f==null?void 0:f.rawEvent())}}}).finally(l)}))}return Promise.all(s)}track(t,e,s=!0){const i=getKeyFromItem(t);e??(e=getTypeFromItem(t));let r=this.data.get(i);return r||(r=new OutboxItem(e),t instanceof NDKUser$1&&this.trackUsers([t])),r}};function getKeyFromItem(n){return n instanceof NDKUser$1?n.pubkey:n}function getTypeFromItem(n){return n instanceof NDKUser$1?"user":"kind"}function correctRelaySet(n,t){const e=t.connectedRelays();if(!Array.from(n.relays).some(i=>e.map(r=>r.url).includes(i.url)))for(const i of e)n.addRelay(i);if(e.length===0)for(const i of t.relays.values())n.addRelay(i);return n}var NDKSubscriptionManager=class{constructor(){c(this,"subscriptions");c(this,"seenEvents",new distExports.LRUCache({maxSize:1e4,entryExpirationTimeInMS:300*1e3}));this.subscriptions=new Map}add(n){this.subscriptions.set(n.internalId,n),n.onStopped,n.onStopped=()=>{this.subscriptions.delete(n.internalId)},n.on("close",()=>{this.subscriptions.delete(n.internalId)})}seenEvent(n,t){const e=this.seenEvents.get(n)||[];e.some(s=>s.url===t.url)||e.push(t),this.seenEvents.set(n,e)}dispatchEvent(n,t,e=!1){t&&this.seenEvent(n.id,t);const s=this.subscriptions.values(),i=[];for(const r of s)matchFilters(r.filters,n)&&i.push(r);for(const r of i){if(r.exclusiveRelay&&r.relaySet){let a=!1;if(e?a=!r.skipOptimisticPublishEvent:t?a=r.relaySet.relays.has(t):a=(this.seenEvents.get(n.id)||[]).some(l=>r.relaySet.relays.has(l)),!a){r.debug.extend("exclusive-relay")("Rejected event %s from %s (relay not in exclusive set)",n.id,(t==null?void 0:t.url)||(e?"optimistic":"cache"));continue}}r.eventReceived(n,t,!1,e)}}},debug6=createDebug2("ndk:active-user");async function getUserRelayList(n){if(!this.autoConnectUserRelays)return;const t=await getRelayListForUser(n.pubkey,this);if(t){for(const e of t.relays){let s=this.pool.relays.get(e);s||(s=new NDKRelay$1(e,this.relayAuthDefaultPolicy,this),this.pool.addRelay(s))}return debug6("Connected to %d user relays",t.relays.length),t}}async function setActiveUser(n){if(!this.autoConnectUserRelays)return;const t=this.outboxPool||this.pool;t.connectedRelays.length>0?await getUserRelayList.call(this,n):t.once("connect",async()=>{await getUserRelayList.call(this,n)})}function getEntity(n){try{const t=nip19_exports$2.decode(n);return t.type==="npub"?npub(this,t.data):t.type==="nprofile"?nprofile(this,t.data):t}catch{return null}}function npub(n,t){return n.getUser({pubkey:t})}function nprofile(n,t){const e=n.getUser({pubkey:t.pubkey});return t.relays&&(e.relayUrls=t.relays),e}function isValidHint(n){if(!n||n==="")return!1;try{return new URL(n),!0}catch{return!1}}async function fetchEventFromTag(n,t,e,s={type:"timeout"}){const i=this.debug.extend("fetch-event-from-tag"),[r,a,o]=n;e={},i("fetching event from tag",n,e,s);const l=getRelaysForSync$1(this,t.pubkey);if(l&&l.size>0){i("fetching event from author relays %o",Array.from(l));const w=NDKRelaySet$1.fromRelayUrls(Array.from(l),this),b=await this.fetchEvent(a,e,w);if(b)return b}else i("no author relays found for %s",t.pubkey,t);const h=calculateRelaySetsFromFilters(this,[{ids:[a]}],this.pool);i("fetching event without relay hint",h);const u=await this.fetchEvent(a,e);if(u)return u;if(o&&o!==""){const w=await this.fetchEvent(a,e,this.pool.getRelay(o,!0,!0,[{ids:[a]}]));if(w)return w}let f;const p=isValidHint(o)?this.pool.getRelay(o,!1,!0,[{ids:[a]}]):void 0,g=new Promise(w=>{this.fetchEvent(a,e,p).then(w)});if(!isValidHint(o)||s.type==="none")return g;const m=new Promise(async w=>{const b=s.relaySet,E=s.timeout??1500,$=new Promise(_=>setTimeout(_,E));if(s.type==="timeout"&&await $,f)w(f);else{i("fallback fetch triggered");const _=await this.fetchEvent(a,e,b);w(_)}});switch(s.type){case"timeout":return Promise.race([g,m]);case"eose":return f=await g,f||m}}var Queue=class{constructor(n,t){c(this,"queue",[]);c(this,"maxConcurrency");c(this,"processing",new Set);c(this,"promises",new Map);this.maxConcurrency=t}add(n){if(this.promises.has(n.id))return this.promises.get(n.id);const t=new Promise((e,s)=>{this.queue.push({...n,func:()=>n.func().then(i=>(e(i),i),i=>{throw s(i),i})}),this.process()});return this.promises.set(n.id,t),t.finally(()=>{this.promises.delete(n.id),this.processing.delete(n.id),this.process()}),t}process(){if(this.processing.size>=this.maxConcurrency||this.queue.length===0)return;const n=this.queue.shift();!n||this.processing.has(n.id)||(this.processing.add(n.id),n.func())}clear(){this.queue=[]}clearProcessing(){this.processing.clear()}clearAll(){this.clear(),this.clearProcessing()}length(){return this.queue.length}},DEFAULT_OUTBOX_RELAYS=["wss://purplepag.es/","wss://nos.lol/"],NDK=class extends libExports.EventEmitter{constructor(t={}){super();c(this,"_explicitRelayUrls");c(this,"pool");c(this,"outboxPool");c(this,"_signer");c(this,"_activeUser");c(this,"cacheAdapter");c(this,"debug");c(this,"devWriteRelaySet");c(this,"outboxTracker");c(this,"muteFilter");c(this,"relayConnectionFilter");c(this,"clientName");c(this,"clientNip89");c(this,"queuesZapConfig");c(this,"queuesNip05");c(this,"asyncSigVerification",!1);c(this,"initialValidationRatio",1);c(this,"lowestValidationRatio",.1);c(this,"validationRatioFn");c(this,"filterValidationMode","validate");c(this,"subManager");c(this,"aiGuardrails");c(this,"_signatureVerificationFunction");c(this,"_signatureVerificationWorker");c(this,"signatureVerificationTimeMs",0);c(this,"publishingFailureHandled",!1);c(this,"pools",[]);c(this,"relayAuthDefaultPolicy");c(this,"httpFetch");c(this,"netDebug");c(this,"autoConnectUserRelays",!0);c(this,"_wallet");c(this,"walletConfig");c(this,"fetchEventFromTag",fetchEventFromTag.bind(this));c(this,"getEntity",getEntity.bind(this));this.debug=t.debug||createDebug2("ndk"),this.netDebug=t.netDebug,this._explicitRelayUrls=t.explicitRelayUrls||[],this.subManager=new NDKSubscriptionManager,this.pool=new NDKPool$1(t.explicitRelayUrls||[],this),this.pool.name="Main",this.pool.on("relay:auth",async(e,s)=>{this.relayAuthDefaultPolicy&&await this.relayAuthDefaultPolicy(e,s)}),this.autoConnectUserRelays=t.autoConnectUserRelays??!0,this.clientName=t.clientName,this.clientNip89=t.clientNip89,this.relayAuthDefaultPolicy=t.relayAuthDefaultPolicy,t.enableOutboxModel!==!1&&(this.outboxPool=new NDKPool$1(t.outboxRelayUrls||DEFAULT_OUTBOX_RELAYS,this,{debug:this.debug.extend("outbox-pool"),name:"Outbox Pool"}),this.outboxTracker=new OutboxTracker(this),this.outboxTracker.on("user:relay-list-updated",(e,s)=>{this.debug(`Outbox relay list updated for ${e}`);for(const i of this.subManager.subscriptions.values())i.filters.some(a=>{var o;return(o=a.authors)==null?void 0:o.includes(e)})&&typeof i.refreshRelayConnections=="function"&&(this.debug(`Refreshing relay connections for subscription ${i.internalId}`),i.refreshRelayConnections())})),this.signer=t.signer,this.cacheAdapter=t.cacheAdapter,this.muteFilter=t.muteFilter,this.relayConnectionFilter=t.relayConnectionFilter,t.devWriteRelayUrls&&(this.devWriteRelaySet=NDKRelaySet$1.fromRelayUrls(t.devWriteRelayUrls,this)),this.queuesZapConfig=new Queue("zaps",3),this.queuesNip05=new Queue("nip05",10),t.signatureVerificationWorker&&(this.signatureVerificationWorker=t.signatureVerificationWorker),t.signatureVerificationFunction&&(this.signatureVerificationFunction=t.signatureVerificationFunction),this.initialValidationRatio=t.initialValidationRatio||1,this.lowestValidationRatio=t.lowestValidationRatio||.1,this.validationRatioFn=t.validationRatioFn||this.defaultValidationRatioFn,this.filterValidationMode=t.filterValidationMode||"validate",this.aiGuardrails=new AIGuardrails(t.aiGuardrails||!1),this.aiGuardrails.ndkInstantiated(this);try{this.httpFetch=fetch}catch{}}set explicitRelayUrls(t){this._explicitRelayUrls=t.map(normalizeRelayUrl$1),this.pool.relayUrls=t}get explicitRelayUrls(){return this._explicitRelayUrls||[]}set signatureVerificationWorker(t){this._signatureVerificationWorker=t,t?(signatureVerificationInit(t),this.asyncSigVerification=!0):this.asyncSigVerification=!1}set signatureVerificationFunction(t){this._signatureVerificationFunction=t,this.asyncSigVerification=!!t}get signatureVerificationFunction(){return this._signatureVerificationFunction}addExplicitRelay(t,e,s=!0){var r;let i;return typeof t=="string"?i=new NDKRelay$1(t,e,this):i=t,this.pool.addRelay(i,s),(r=this.explicitRelayUrls)==null||r.push(i.url),i}toJSON(){return{relayCount:this.pool.relays.size}.toString()}get activeUser(){return this._activeUser}set activeUser(t){var s;const e=((s=this._activeUser)==null?void 0:s.pubkey)!==(t==null?void 0:t.pubkey);this._activeUser=t,e&&this.emit("activeUser:change",t),t&&e&&setActiveUser.call(this,t)}get signer(){return this._signer}set signer(t){this._signer=t,t&&this.emit("signer:ready",t),t==null||t.user().then(e=>{e.ndk=this,this.activeUser=e})}async connect(t){var s,i,r;this._signer&&this.autoConnectUserRelays&&(this.debug("Attempting to connect to user relays specified by signer %o",await((i=(s=this._signer).relays)==null?void 0:i.call(s,this))),this._signer.relays&&(await this._signer.relays(this)).forEach(o=>this.pool.addRelay(o)));const e=[this.pool.connect(t)];return this.outboxPool&&e.push(this.outboxPool.connect(t)),(r=this.cacheAdapter)!=null&&r.initializeAsync&&e.push(this.cacheAdapter.initializeAsync(this)),Promise.allSettled(e).then(()=>{})}reportInvalidSignature(t,e){this.debug(`Invalid signature detected for event ${t.id}${e?` from relay ${e.url}`:""}`),this.emit("event:invalid-sig",t,e)}defaultValidationRatioFn(t,e,s){if(e<10)return this.initialValidationRatio;const i=Math.min(e/100,1),r=this.initialValidationRatio*(1-i)+this.lowestValidationRatio*i;return Math.max(r,this.lowestValidationRatio)}getUser(t){if(typeof t=="string")if(t.startsWith("npub1")){const{type:s,data:i}=nip19_exports$2.decode(t);if(s!=="npub")throw new Error(`Invalid npub: ${t}`);return this.getUser({pubkey:i})}else if(t.startsWith("nprofile1")){const{type:s,data:i}=nip19_exports$2.decode(t);if(s!=="nprofile")throw new Error(`Invalid nprofile: ${t}`);return this.getUser({pubkey:i.pubkey,relayUrls:i.relays})}else return this.getUser({pubkey:t});const e=new NDKUser$1(t);return e.ndk=this,e}async getUserFromNip05(t,e=!1){return NDKUser$1.fromNip05(t,this,e)}async fetchUser(t,e=!1){if(isValidNip05(t))return NDKUser$1.fromNip05(t,this,e);if(t.startsWith("npub1")){const{type:s,data:i}=nip19_exports$2.decode(t);if(s!=="npub")throw new Error(`Invalid npub: ${t}`);const r=new NDKUser$1({pubkey:i});return r.ndk=this,r}else if(t.startsWith("nprofile1")){const{type:s,data:i}=nip19_exports$2.decode(t);if(s!=="nprofile")throw new Error(`Invalid nprofile: ${t}`);const r=new NDKUser$1({pubkey:i.pubkey,relayUrls:i.relays});return r.ndk=this,r}else{const s=new NDKUser$1({pubkey:t});return s.ndk=this,s}}subscribe(t,e,s=!0,i=!0){var f,p,g;let r=e==null?void 0:e.relaySet,a=i;s instanceof NDKRelaySet$1?(console.warn("relaySet is deprecated, use opts.relaySet instead. This will be removed in version v2.14.0"),r=s,a=i):(typeof s=="boolean"||typeof s=="object")&&(a=s);let o;const l={relaySet:r,...e};a&&typeof a=="object"&&(a.onEvent&&(l.onEvent=a.onEvent),a.onEose&&(l.onEose=a.onEose),a.onClose&&(l.onClose=a.onClose),a.onEvents&&(o=a.onEvents));const h=new NDKSubscription(this,t,l);this.subManager.add(h),(p=(f=this.aiGuardrails)==null?void 0:f.subscription)==null||p.created(Array.isArray(t)?t:[t],l);const u=h.pool;if(h.relaySet)for(const m of h.relaySet.relays)u.useTemporaryRelay(m,void 0,h.filters);if(this.outboxPool&&h.hasAuthorsFilter()){const m=h.filters.filter(w=>{var b;return w.authors&&((b=w.authors)==null?void 0:b.length)>0}).flatMap(w=>w.authors);(g=this.outboxTracker)==null||g.trackUsers(m)}return a&&setTimeout(async()=>{var w;(w=this.cacheAdapter)!=null&&w.initializeAsync&&!this.cacheAdapter.ready&&await this.cacheAdapter.initializeAsync(this);const m=h.start(!o);m&&m.length>0&&o&&o(m)},0),h}fetchEventSync(t){if(!this.cacheAdapter)throw new Error("Cache adapter not set");let e;typeof t=="string"?e=[filterFromId(t)]:e=t;const s=new NDKSubscription(this,e),i=this.cacheAdapter.query(s);if(i instanceof Promise)throw new Error("Cache adapter is async");return i.map(r=>(r.ndk=this,r))}async fetchEvent(t,e,s){var a,o;let i,r;if(s instanceof NDKRelay$1?r=new NDKRelaySet$1(new Set([s]),this):s instanceof NDKRelaySet$1&&(r=s),!s&&typeof t=="string"&&!isNip33AValue(t)){const l=relaysFromBech32(t,this);l.length>0&&(r=new NDKRelaySet$1(new Set(l),this),r=correctRelaySet(r,this.pool))}if(typeof t=="string"?i=[filterFromId(t)]:Array.isArray(t)?i=t:i=[t],typeof t!="string"&&((o=(a=this.aiGuardrails)==null?void 0:a.ndk)==null||o.fetchingEvents(i)),i.length===0)throw new Error(`Invalid filter: ${JSON.stringify(t)}`);return new Promise((l,h)=>{let u=null;const f={...e||{},closeOnEose:!0};r&&(f.relaySet=r);const p=setTimeout(()=>{g.stop(),this.aiGuardrails._nextCallDisabled=null,l(u)},1e4),g=this.subscribe(i,f,{onEvent:m=>{m.ndk=this,m.isReplaceable()?(!u||u.created_at<m.created_at)&&(u=m):(clearTimeout(p),this.aiGuardrails._nextCallDisabled=null,l(m))},onEose:()=>{clearTimeout(p),this.aiGuardrails._nextCallDisabled=null,l(u)}})})}async fetchEvents(t,e,s){var i,r;return(r=(i=this.aiGuardrails)==null?void 0:i.ndk)==null||r.fetchingEvents(t,e),new Promise(a=>{const o=new Map,l={...e||{},closeOnEose:!0};s&&(l.relaySet=s);const h=u=>{let f;u instanceof NDKEvent$1?f=u:f=new NDKEvent$1(void 0,u);const p=f.deduplicationKey(),g=o.get(p);g&&(f=dedup(g,f)),f.ndk=this,o.set(p,f)};this.subscribe(t,{...l,onEvent:h,onEose:()=>{this.aiGuardrails._nextCallDisabled=null,a(new Set(o.values()))}})})}assertSigner(){if(!this.signer)throw this.emit("signer:required"),new Error("Signer required")}guardrailOff(t){return t?typeof t=="string"?this.aiGuardrails._nextCallDisabled=new Set([t]):this.aiGuardrails._nextCallDisabled=new Set(t):this.aiGuardrails._nextCallDisabled="all",this}set wallet(t){var e,s;if(!t){this._wallet=void 0,this.walletConfig=void 0;return}this._wallet=t,this.walletConfig??(this.walletConfig={}),this.walletConfig.lnPay=(e=t==null?void 0:t.lnPay)==null?void 0:e.bind(t),this.walletConfig.cashuPay=(s=t==null?void 0:t.cashuPay)==null?void 0:s.bind(t)}get wallet(){return this._wallet}},nip19_exports$1={};__reExport$1(nip19_exports$1,nip19_star);var nip49_exports={};__reExport$1(nip49_exports,nip49_star);function disconnect$1(n,t){return t??(t=createDebug2("ndk:relay:auth-policies:disconnect")),async e=>{t==null||t(`Relay ${e.url} requested authentication, disconnecting`),n.removeRelay(e.url)}}async function signAndAuth$1(n,t,e,s,i,r){try{await n.sign(e),i(n)}catch(a){s==null||s(`Failed to publish auth event to relay ${t.url}`,a),r(n)}}function signIn$1({ndk:n,signer:t,debug:e}={}){return e??(e=createDebug2("ndk:auth-policies:signIn")),async(s,i)=>{e==null||e(`Relay ${s.url} requested authentication, signing in`);const r=new NDKEvent$1(n);return r.kind=22242,r.tags=[["relay",s.url],["challenge",i]],t??(t=n==null?void 0:n.signer),new Promise(async(a,o)=>{t?await signAndAuth$1(r,s,t,e,a,o):n==null||n.once("signer:ready",async l=>{await signAndAuth$1(r,s,l,e,a,o)})})}}var NDKRelayAuthPolicies$1={disconnect:disconnect$1,signIn:signIn$1};async function ndkSignerFromPayload$1(n,t){let e;try{e=JSON.parse(n)}catch(i){console.error("Failed to parse signer payload string",n,i);return}if(!e||typeof e.type!="string"){console.error("Failed to parse signer payload string",n,new Error("Missing type field"));return}const s=signerRegistry$1.get(e.type);if(!s)throw new Error(`Unknown signer type: ${e.type}`);try{return await s.fromPayload(n,t)}catch(i){const r=i instanceof Error?i.message:String(i);throw new Error(`Failed to deserialize signer type ${e.type}: ${r}`)}}var NDKNip07Signer$1=class Ie{constructor(t=1e3,e){c(this,"_userPromise");c(this,"encryptionQueue",[]);c(this,"encryptionProcessing",!1);c(this,"debug");c(this,"waitTimeout");c(this,"_pubkey");c(this,"ndk");c(this,"_user");this.debug=createDebug2("ndk:nip07"),this.waitTimeout=t,this.ndk=e}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){var s;await this.waitForExtension();const t=await((s=window.nostr)==null?void 0:s.getPublicKey());if(!t)throw new Error("User rejected access");this._pubkey=t;let e;return this.ndk?e=this.ndk.getUser({pubkey:t}):e=new NDKUser$1({pubkey:t}),this._user=e,e}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(t){var s;await this.waitForExtension();const e=await((s=window.nostr)==null?void 0:s.signEvent(t));if(!e)throw new Error("Failed to sign event");return e.sig}async relays(t){var i,r;await this.waitForExtension();const e=await((r=(i=window.nostr)==null?void 0:i.getRelays)==null?void 0:r.call(i))||{},s=[];for(const a of Object.keys(e))e[a].read&&e[a].write&&s.push(a);return s.map(a=>new NDKRelay$1(a,t==null?void 0:t.relayAuthDefaultPolicy,t))}async encryptionEnabled(t){var s,i;const e=[];return(!t||t==="nip04")&&((s=window.nostr)!=null&&s.nip04)&&e.push("nip04"),(!t||t==="nip44")&&((i=window.nostr)!=null&&i.nip44)&&e.push("nip44"),e}async encrypt(t,e,s="nip04"){if(!await this.encryptionEnabled(s))throw new Error(`${s}encryption is not available from your browser extension`);await this.waitForExtension();const i=t.pubkey;return this.queueEncryption(s,"encrypt",i,e)}async decrypt(t,e,s="nip04"){if(!await this.encryptionEnabled(s))throw new Error(`${s}encryption is not available from your browser extension`);await this.waitForExtension();const i=t.pubkey;return this.queueEncryption(s,"decrypt",i,e)}async queueEncryption(t,e,s,i){return new Promise((r,a)=>{this.encryptionQueue.push({scheme:t,method:e,counterpartyHexpubkey:s,value:i,resolve:r,reject:a}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(t,e=0){var u,f;if(!t&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const s=t||this.encryptionQueue.shift();if(!s){this.encryptionProcessing=!1;return}const{scheme:i,method:r,counterpartyHexpubkey:a,value:o,resolve:l,reject:h}=s;this.debug("Processing encryption queue item",{method:r,counterpartyHexpubkey:a,value:o});try{const p=await((f=(u=window.nostr)==null?void 0:u[i])==null?void 0:f[r](a,o));if(!p)throw new Error("Failed to encrypt/decrypt");l(p)}catch(p){const g=p instanceof Error?p.message:String(p);if(g.includes("call already executing")&&e<5){this.debug("Retrying encryption queue item",{method:r,counterpartyHexpubkey:a,value:o,retries:e}),setTimeout(()=>{this.processEncryptionQueue(s,e+1)},50*e);return}h(p instanceof Error?p:new Error(g))}this.processEncryptionQueue()}waitForExtension(){return new Promise((t,e)=>{if(window.nostr){t();return}let s;const i=setInterval(()=>{window.nostr&&(clearTimeout(s),clearInterval(i),t())},100);s=setTimeout(()=>{clearInterval(i),e(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(t,e){const s=JSON.parse(t);if(s.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${s.type}`);return new Ie(void 0,e)}};registerSigner$1("nip07",NDKNip07Signer$1);var NDKNostrRpc$1=class extends libExports.EventEmitter{constructor(e,s,i,r){super();c(this,"ndk");c(this,"signer");c(this,"relaySet");c(this,"debug");c(this,"encryptionType","nip04");c(this,"pool");if(this.ndk=e,this.signer=s,r){this.pool=new NDKPool$1(r,e,{debug:i.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet$1(new Set,e,this.pool);for(const a of r){const o=this.pool.getRelay(a,!1,!1);o.authPolicy=NDKRelayAuthPolicies$1.signIn({ndk:e,signer:s,debug:i}),this.relaySet.addRelay(o),o.connect()}}this.debug=i.extend("rpc")}subscribe(e){return new Promise(s=>{const i=this.ndk.subscribe(e,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet,onEvent:async r=>{try{const a=await this.parseEvent(r);a.method?this.emit("request",a):(this.emit(`response-${a.id}`,a),this.emit("response",a))}catch(a){this.debug("error parsing event",a,r.rawEvent())}},onEose:()=>{this.debug("eosed"),s(i)}})})}async parseEvent(e){this.encryptionType==="nip44"&&e.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!e.content.includes("?iv=")&&(this.encryptionType="nip44");const s=this.ndk.getUser({pubkey:e.pubkey});s.ndk=this.ndk;let i;try{i=await this.signer.decrypt(s,e.content,this.encryptionType)}catch{const p=this.encryptionType==="nip04"?"nip44":"nip04";i=await this.signer.decrypt(s,e.content,p),this.encryptionType=p}const r=JSON.parse(i),{id:a,method:o,params:l,result:h,error:u}=r;return o?{id:a,pubkey:e.pubkey,method:o,params:l,event:e}:{id:a,result:h,error:u,event:e}}async sendResponse(e,s,i,r=24133,a){const o={id:e,result:i};a&&(o.error=a);const l=await this.signer.user(),h=this.ndk.getUser({pubkey:s}),u=new NDKEvent$1(this.ndk,{kind:r,content:JSON.stringify(o),tags:[["p",s]],pubkey:l.pubkey});u.content=await this.signer.encrypt(h,u.content,this.encryptionType),await u.sign(this.signer),await u.publish(this.relaySet)}async sendRequest(e,s,i=[],r=24133,a){const o=Math.random().toString(36).substring(7),l=await this.signer.user(),h=this.ndk.getUser({pubkey:e}),u={id:o,method:s,params:i},f=new Promise(()=>{const g=m=>{m.result==="auth_url"?(this.once(`response-${o}`,g),this.emit("authUrl",m.error)):a&&a(m)};this.once(`response-${o}`,g)}),p=new NDKEvent$1(this.ndk,{kind:r,content:JSON.stringify(u),tags:[["p",e]],pubkey:l.pubkey});return p.content=await this.signer.encrypt(h,p.content,this.encryptionType),await p.sign(this.signer),await p.publish(this.relaySet),f}};function nostrConnectGenerateSecret$1(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri$1(n,t,e,s){const i={name:s!=null&&s.name?encodeURIComponent(s.name):"",url:s!=null&&s.url?encodeURIComponent(s.url):"",image:s!=null&&s.image?encodeURIComponent(s.image):"",perms:s!=null&&s.perms?encodeURIComponent(s.perms):""};let r=`nostrconnect://${n}?image=${i.image}&url=${i.url}&name=${i.name}&perms=${i.perms}&secret=${encodeURIComponent(t)}`;return e&&(r+=`&relay=${encodeURIComponent(e)}`),r}var NDKNip46Signer$1=class Re extends libExports.EventEmitter{constructor(e,s,i,r,a){super();c(this,"ndk");c(this,"_user");c(this,"bunkerPubkey");c(this,"userPubkey");c(this,"secret");c(this,"localSigner");c(this,"nip05");c(this,"rpc");c(this,"debug");c(this,"relayUrls");c(this,"subscription");c(this,"nostrConnectUri");c(this,"nostrConnectSecret");this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=r,i?typeof i=="string"?this.localSigner=new NDKPrivateKeySigner$1(i):this.localSigner=i:this.localSigner=NDKPrivateKeySigner$1.generate(),s===!1||(s?s.startsWith("bunker://")?this.bunkerFlowInit(s):this.nip05Init(s):this.nostrconnectFlowInit(a)),this.rpc=new NDKNostrRpc$1(this.ndk,this.localSigner,this.debug,this.relayUrls)}get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}static bunker(e,s,i){return new Re(e,s,i)}static nostrconnect(e,s,i,r){return new Re(e,void 0,i,[s],r)}nostrconnectFlowInit(e){var i;this.nostrConnectSecret=nostrConnectGenerateSecret$1();const s=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri$1(s,this.nostrConnectSecret,(i=this.relayUrls)==null?void 0:i[0],e)}bunkerFlowInit(e){const s=new URL(e),i=s.hostname||s.pathname.replace(/^\/\//,""),r=s.searchParams.get("pubkey"),a=s.searchParams.getAll("relay"),o=s.searchParams.get("secret");this.bunkerPubkey=i,this.userPubkey=r,this.relayUrls=a,this.secret=o}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,s)=>{const i=r=>{r.result===this.nostrConnectSecret&&(this._user=r.event.author,this.userPubkey=r.event.pubkey,this.bunkerPubkey=r.event.pubkey,this.rpc.off("response",i),e(this._user))};this.startListening(),this.rpc.on("response",i)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser$1.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc$1(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,s)=>{const i=[this.userPubkey??""];if(this.secret&&i.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",i,24133,r=>{r.result==="ack"?this.getPublicKey().then(a=>{this.userPubkey=a,this._user=this.ndk.getUser({pubkey:a}),e(this._user)}):s(r.error)})})}stop(){var e;(e=this.subscription)==null||e.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,i=>{e(i.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,s,i="nip04"){return this.encryption(e,s,i,"encrypt")}async decrypt(e,s,i="nip04"){return this.encryption(e,s,i,"decrypt")}async encryption(e,s,i,r){return new Promise((o,l)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${i}_${r}`,[e.pubkey,s],24133,h=>{h.error?l(h.error):o(h.result)})})}async sign(e){return new Promise((i,r)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,a=>{if(a.error)r(a.error);else{const o=JSON.parse(a.result);i(o.sig)}})})}async createAccount(e,s,i){await this.startListening();const r=[];return e&&r.push(e),s&&r.push(s),i&&r.push(i),new Promise((a,o)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",r,24133,l=>{if(l.error)o(l.error);else{const h=l.result;a(h)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,s){if(!s)throw new Error("NDK instance is required to deserialize NIP-46 signer");const i=JSON.parse(e);if(i.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${i.type}`);const r=i.payload;if(!r||typeof r!="object"||!r.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const a=await ndkSignerFromPayload$1(r.localSignerPayload,s);if(!a)throw new Error("Failed to deserialize local signer for NIP-46");if(!(a instanceof NDKPrivateKeySigner$1))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let o;return o=new Re(s,!1,a,r.relayUrls),o.userPubkey=r.userPubkey,o.bunkerPubkey=r.bunkerPubkey,o.relayUrls=r.relayUrls,o.secret=r.secret,r.userPubkey&&(o._user=new NDKUser$1({pubkey:r.userPubkey}),o._user&&(o._user.ndk=s)),o}};registerSigner$1("nip46",NDKNip46Signer$1);createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");var __defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__hasOwnProp=Object.prototype.hasOwnProperty,__copyProps=(n,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of __getOwnPropNames(t))!__hasOwnProp.call(n,i)&&i!==e&&__defProp(n,i,{get:()=>t[i],enumerable:!(s=__getOwnPropDesc(t,i))||s.enumerable});return n},__reExport=(n,t,e)=>(__copyProps(n,t,"default"),e);function getRelaysForSync(n,t,e="write"){if(!n.outboxTracker)return;const s=n.outboxTracker.data.get(t);if(s)return e==="write"?s.writeRelays:s.readRelays}async function getWriteRelaysFor(n,t,e="write"){if(n.outboxTracker)return n.outboxTracker.data.has(t)||await n.outboxTracker.trackUsers([t]),getRelaysForSync(n,t,e)}function getTopRelaysForAuthors(n,t){const e=new Map;return t.forEach(i=>{const r=getRelaysForSync(n,i);r&&r.forEach(a=>{const o=e.get(a)||0;e.set(a,o+1)})}),Array.from(e.entries()).sort((i,r)=>r[1]-i[1]).map(i=>i[0])}function getAllRelaysForAllPubkeys(n,t,e="read"){const s=new Map,i=new Set;return t.forEach(r=>{const a=getRelaysForSync(n,r,e);a&&a.size>0?(a.forEach(o=>{(s.get(o)||new Set).add(r)}),s.set(r,a)):i.add(r)}),{pubkeysToRelays:s,authorsMissingRelays:i}}function chooseRelayCombinationForPubkeys(n,t,e,{count:s,preferredRelays:i}={}){s??(s=2),i??(i=new Set);const r=n.pool,a=r.connectedRelays();a.forEach(p=>{i==null||i.add(p.url)});const o=new Map,{pubkeysToRelays:l,authorsMissingRelays:h}=getAllRelaysForAllPubkeys(n,t,e),u=getTopRelaysForAuthors(n,t),f=(p,g)=>{const m=o.get(g)||[];m.push(p),o.set(g,m)};for(const[p,g]of l.entries()){let m=s;const w=new Set;for(const b of a)g.has(b.url)&&(f(p,b.url),w.add(b.url),m--);for(const b of g)w.has(b)||o.has(b)&&(f(p,b),w.add(b),m--);if(!(m<=0))for(const b of u){if(m<=0)break;w.has(b)||g.has(b)&&(f(p,b),w.add(b),m--)}}for(const p of h)r.permanentAndConnectedRelays().forEach(g=>{const m=o.get(g.url)||[];m.push(p),o.set(g.url,m)});return o}function normalizeRelayUrl(n){let t=normalizeUrl(n,{stripAuthentication:!1,stripWWW:!1,stripHash:!0});return t.endsWith("/")||(t+="/"),t}var DATA_URL_DEFAULT_MIME_TYPE="text/plain",DATA_URL_DEFAULT_CHARSET="us-ascii",testParameter=(n,t)=>t.some(e=>e instanceof RegExp?e.test(n):e===n),supportedProtocols=new Set(["https:","http:","file:"]),hasCustomProtocol=n=>{try{const{protocol:t}=new URL(n);return t.endsWith(":")&&!t.includes(".")&&!supportedProtocols.has(t)}catch{return!1}},normalizeDataURL=(n,{stripHash:t})=>{var f,p,g,m;const e=/^data:(?<type>[^,]*?),(?<data>[^#]*?)(?:#(?<hash>.*))?$/.exec(n);if(!e)throw new Error(`Invalid URL: ${n}`);const s=((f=e.groups)==null?void 0:f.type)??"",i=((p=e.groups)==null?void 0:p.data)??"";let r=((g=e.groups)==null?void 0:g.hash)??"";const a=s.split(";");r=t?"":r;let o=!1;a[a.length-1]==="base64"&&(a.pop(),o=!0);const l=((m=a.shift())==null?void 0:m.toLowerCase())??"",u=[...a.map(w=>{let[b,E=""]=w.split("=").map($=>$.trim());return b==="charset"&&(E=E.toLowerCase(),E===DATA_URL_DEFAULT_CHARSET)?"":`${b}${E?`=${E}`:""}`}).filter(Boolean)];return o&&u.push("base64"),(u.length>0||l&&l!==DATA_URL_DEFAULT_MIME_TYPE)&&u.unshift(l),`data:${u.join(";")},${o?i.trim():i}${r?`#${r}`:""}`};function normalizeUrl(n,t={}){if(t={defaultProtocol:"http",normalizeProtocol:!0,forceHttp:!1,forceHttps:!1,stripAuthentication:!0,stripHash:!1,stripTextFragment:!0,stripWWW:!0,removeQueryParameters:[/^utm_\w+/i],removeTrailingSlash:!0,removeSingleSlash:!0,removeDirectoryIndex:!1,removeExplicitPort:!1,sortQueryParameters:!0,...t},typeof t.defaultProtocol=="string"&&!t.defaultProtocol.endsWith(":")&&(t.defaultProtocol=`${t.defaultProtocol}:`),n=n.trim(),/^data:/i.test(n))return normalizeDataURL(n,t);if(hasCustomProtocol(n))return n;const e=n.startsWith("//");!e&&/^\.*\//.test(n)||(n=n.replace(/^(?!(?:\w+:)?\/\/)|^\/\//,t.defaultProtocol));const i=new URL(n);if(i.hostname=i.hostname.toLowerCase(),t.forceHttp&&t.forceHttps)throw new Error("The `forceHttp` and `forceHttps` options cannot be used together");if(t.forceHttp&&i.protocol==="https:"&&(i.protocol="http:"),t.forceHttps&&i.protocol==="http:"&&(i.protocol="https:"),t.stripAuthentication&&(i.username="",i.password=""),t.stripHash?i.hash="":t.stripTextFragment&&(i.hash=i.hash.replace(/#?:~:text.*?$/i,"")),i.pathname){const a=/\b[a-z][a-z\d+\-.]{1,50}:\/\//g;let o=0,l="";for(;;){const u=a.exec(i.pathname);if(!u)break;const f=u[0],p=u.index,g=i.pathname.slice(o,p);l+=g.replace(/\/{2,}/g,"/"),l+=f,o=p+f.length}const h=i.pathname.slice(o,i.pathname.length);l+=h.replace(/\/{2,}/g,"/"),i.pathname=l}if(i.pathname)try{i.pathname=decodeURI(i.pathname)}catch{}if(t.removeDirectoryIndex===!0&&(t.removeDirectoryIndex=[/^index\.[a-z]+$/]),Array.isArray(t.removeDirectoryIndex)&&t.removeDirectoryIndex.length>0){let a=i.pathname.split("/");const o=a[a.length-1];testParameter(o,t.removeDirectoryIndex)&&(a=a.slice(0,-1),i.pathname=`${a.slice(1).join("/")}/`)}if(i.hostname&&(i.hostname=i.hostname.replace(/\.$/,""),t.stripWWW&&/^www\.(?!www\.)[a-z\-\d]{1,63}\.[a-z.\-\d]{2,63}$/.test(i.hostname)&&(i.hostname=i.hostname.replace(/^www\./,""))),Array.isArray(t.removeQueryParameters))for(const a of[...i.searchParams.keys()])testParameter(a,t.removeQueryParameters)&&i.searchParams.delete(a);if(!Array.isArray(t.keepQueryParameters)&&t.removeQueryParameters===!0&&(i.search=""),Array.isArray(t.keepQueryParameters)&&t.keepQueryParameters.length>0)for(const a of[...i.searchParams.keys()])testParameter(a,t.keepQueryParameters)||i.searchParams.delete(a);if(t.sortQueryParameters){i.searchParams.sort();try{i.search=decodeURIComponent(i.search)}catch{}}t.removeTrailingSlash&&(i.pathname=i.pathname.replace(/\/$/,"")),t.removeExplicitPort&&i.port&&(i.port="");const r=n;return n=i.toString(),!t.removeSingleSlash&&i.pathname==="/"&&!r.endsWith("/")&&i.hash===""&&(n=n.replace(/\/$/,"")),(t.removeTrailingSlash||i.pathname==="/")&&i.hash===""&&t.removeSingleSlash&&(n=n.replace(/\/$/,"")),e&&!t.normalizeProtocol&&(n=n.replace(/^http:\/\//,"//")),t.stripProtocol&&(n=n.replace(/^(?:https?:)?\/\//,"")),n}var NDKRelayKeepalive=class{constructor(n=3e4,t){c(this,"lastActivity",Date.now());c(this,"timer");c(this,"timeout");c(this,"isRunning",!1);this.onSilenceDetected=t,this.timeout=n}recordActivity(){this.lastActivity=Date.now(),this.isRunning&&this.resetTimer()}start(){this.isRunning||(this.isRunning=!0,this.lastActivity=Date.now(),this.resetTimer())}stop(){this.isRunning=!1,this.timer&&(clearTimeout(this.timer),this.timer=void 0)}resetTimer(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{const n=Date.now()-this.lastActivity;if(n>=this.timeout)this.onSilenceDetected();else{const t=this.timeout-n;this.timer=setTimeout(()=>{this.onSilenceDetected()},t)}},this.timeout)}};async function probeRelayConnection(n){const t=`probe-${Math.random().toString(36).substring(7)}`;return new Promise(e=>{let s=!1;const i=setTimeout(()=>{s||(s=!0,n.send(["CLOSE",t]),e(!1))},5e3),r=()=>{s||(s=!0,clearTimeout(i),n.send(["CLOSE",t]),e(!0))};n.once("message",r),n.send(["REQ",t,{kinds:[99999],limit:0}])})}var MAX_RECONNECT_ATTEMPTS=5,FLAPPING_THRESHOLD_MS=1e3,NDKRelayConnectivity=class{constructor(n,t){c(this,"ndkRelay");c(this,"ws");c(this,"_status");c(this,"timeoutMs");c(this,"connectedAt");c(this,"_connectionStats",{attempts:0,success:0,durations:[]});c(this,"debug");c(this,"netDebug");c(this,"connectTimeout");c(this,"reconnectTimeout");c(this,"ndk");c(this,"openSubs",new Map);c(this,"openCountRequests",new Map);c(this,"openEventPublishes",new Map);c(this,"serial",0);c(this,"baseEoseTimeout",4400);c(this,"keepalive");c(this,"wsStateMonitor");c(this,"sleepDetector");c(this,"lastSleepCheck",Date.now());c(this,"lastMessageSent",Date.now());c(this,"wasIdle",!1);c(this,"updateConnectionStats",{connected:()=>{this._connectionStats.success++,this._connectionStats.connectedAt=Date.now()},disconnected:()=>{this._connectionStats.connectedAt&&(this._connectionStats.durations.push(Date.now()-this._connectionStats.connectedAt),this._connectionStats.durations.length>100&&this._connectionStats.durations.shift()),this._connectionStats.connectedAt=void 0},attempt:()=>{this._connectionStats.attempts++,this._connectionStats.connectedAt=Date.now()}});this.ndkRelay=n,this._status=1;const e=Math.floor(Math.random()*1e3);this.debug=this.ndkRelay.debug.extend(`connectivity${e}`),this.ndk=t,this.setupMonitoring()}setupMonitoring(){this.keepalive=new NDKRelayKeepalive(3e4,async()=>{this.debug("Relay silence detected, probing connection"),await probeRelayConnection({send:t=>this.send(JSON.stringify(t)),once:(t,e)=>{var i;const s=r=>{var a;try{const o=JSON.parse(r.data);(o[0]==="EOSE"||o[0]==="EVENT"||o[0]==="NOTICE")&&(e(),(a=this.ws)==null||a.removeEventListener("message",s))}catch{}};(i=this.ws)==null||i.addEventListener("message",s)}})||(this.debug("Probe failed, connection is stale"),this.handleStaleConnection())}),this.wsStateMonitor=setInterval(()=>{this._status===5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN)&&(this.debug("WebSocket died silently, reconnecting"),this.handleStaleConnection())},5e3),this.sleepDetector=setInterval(()=>{const n=Date.now(),t=n-this.lastSleepCheck;t>15e3&&(this.debug(`Detected possible sleep/wake (${t}ms gap)`),this.handlePossibleWake()),this.lastSleepCheck=n},1e4)}handleStaleConnection(){this._status=1,this.wasIdle=!0,this.onDisconnect()}handlePossibleWake(){this.debug("System wake detected, checking all connections"),this.wasIdle=!0,this._status>=5&&(!this.ws||this.ws.readyState!==WebSocket.OPEN?this.handleStaleConnection():probeRelayConnection({send:n=>this.send(JSON.stringify(n)),once:(n,t)=>{var s;const e=i=>{var r;try{const a=JSON.parse(i.data);(a[0]==="EOSE"||a[0]==="EVENT"||a[0]==="NOTICE")&&(t(),(r=this.ws)==null||r.removeEventListener("message",e))}catch{}};(s=this.ws)==null||s.addEventListener("message",e)}}).then(n=>{n||this.handleStaleConnection()}))}resetReconnectionState(){this.wasIdle=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}async connect(n,t=!0){if(this.ws&&this.ws.readyState!==WebSocket.OPEN&&this.ws.readyState!==WebSocket.CONNECTING){this.debug("Cleaning up stale WebSocket connection");try{this.ws.close()}catch{}this.ws=void 0,this._status=1}if(this._status!==2&&this._status!==1||this.reconnectTimeout){this.debug("Relay requested to be connected but was in state %s or it had a reconnect timeout",this._status);return}this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),n??(n=this.timeoutMs),!this.timeoutMs&&n&&(this.timeoutMs=n),this.timeoutMs&&(this.connectTimeout=setTimeout(()=>this.onConnectionError(t),this.timeoutMs));try{this.updateConnectionStats.attempt(),this._status===1?this._status=4:this._status=2,this.ws=new WebSocket(this.ndkRelay.url),this.ws.onopen=this.onConnect.bind(this),this.ws.onclose=this.onDisconnect.bind(this),this.ws.onmessage=this.onMessage.bind(this),this.ws.onerror=this.onError.bind(this)}catch(e){throw this.debug(`Failed to connect to ${this.ndkRelay.url}`,e),this._status=1,t?this.handleReconnection():this.ndkRelay.emit("delayed-connect",2880*60*1e3),e}}disconnect(){var n,t;this._status=0,(n=this.keepalive)==null||n.stop(),this.wsStateMonitor&&(clearInterval(this.wsStateMonitor),this.wsStateMonitor=void 0),this.sleepDetector&&(clearInterval(this.sleepDetector),this.sleepDetector=void 0);try{(t=this.ws)==null||t.close()}catch(e){this.debug("Failed to disconnect",e),this._status=1}}onConnectionError(n){this.debug(`Error connecting to ${this.ndkRelay.url}`,this.timeoutMs),n&&!this.reconnectTimeout&&this.handleReconnection()}onConnect(){var n,t;(n=this.netDebug)==null||n.call(this,"connected",this.ndkRelay),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0),this.connectTimeout&&(clearTimeout(this.connectTimeout),this.connectTimeout=void 0),this.updateConnectionStats.connected(),this._status=5,(t=this.keepalive)==null||t.start(),this.wasIdle=!1,this.ndkRelay.emit("connect"),this.ndkRelay.emit("ready")}onDisconnect(){var n,t;(n=this.netDebug)==null||n.call(this,"disconnected",this.ndkRelay),this.updateConnectionStats.disconnected(),(t=this.keepalive)==null||t.stop(),this._status===5&&this.handleReconnection(),this._status=1,this.ndkRelay.emit("disconnect")}onMessage(n){var t,e;(t=this.netDebug)==null||t.call(this,n.data,this.ndkRelay,"recv"),(e=this.keepalive)==null||e.recordActivity();try{const s=JSON.parse(n.data),[i,r,...a]=s;switch(i){case"EVENT":{const o=this.openSubs.get(r),l=s[2];if(!o){this.debug(`Received event for unknown subscription ${r}`);return}o.onevent(l);return}case"COUNT":{const o=s[2],l=this.openCountRequests.get(r);l&&(l.resolve(o.count),this.openCountRequests.delete(r));return}case"EOSE":{const o=this.openSubs.get(r);if(!o)return;o.oneose(r);return}case"OK":{const o=s[2],l=s[3],h=this.openEventPublishes.get(r),u=h==null?void 0:h.pop();if(!h||!u){this.debug("Received OK for unknown event publish",r);return}o?u.resolve(l):u.reject(new Error(l)),h.length===0?this.openEventPublishes.delete(r):this.openEventPublishes.set(r,h);return}case"CLOSED":{const o=this.openSubs.get(r);if(!o)return;o.onclosed(s[2]);return}case"NOTICE":this.onNotice(s[1]);return;case"AUTH":{this.onAuthRequested(s[1]);return}}}catch(s){this.debug(`Error parsing message from ${this.ndkRelay.url}: ${s.message}`,s==null?void 0:s.stack);return}}async onAuthRequested(n){var e,s,i;const t=this.ndkRelay.authPolicy??((e=this.ndk)==null?void 0:e.relayAuthDefaultPolicy);if(this.debug("Relay requested authentication",{havePolicy:!!t}),this._status===7){this.debug("Already authenticating, ignoring");return}if(this._status=6,t){if(this._status>=5){this._status=7;let r;try{r=await t(this.ndkRelay,n)}catch(a){this.debug("Authentication policy threw an error",a),r=!1}if(this.debug("Authentication policy returned",!!r),r instanceof NDKEvent||r===!0){r instanceof NDKEvent&&await this.auth(r);const a=async()=>{if(this._status>=5&&this._status<8){const o=new NDKEvent(this.ndk);o.kind=22242,o.tags=[["relay",this.ndkRelay.url],["challenge",n]],await o.sign(),this.auth(o).then(()=>{this._status=8,this.ndkRelay.emit("authed"),this.debug("Authentication successful")}).catch(l=>{this._status=6,this.ndkRelay.emit("auth:failed",l),this.debug("Authentication failed",l)})}else this.debug("Authentication failed, it changed status, status is %d",this._status)};r===!0&&((s=this.ndk)!=null&&s.signer?a().catch(o=>{console.error("Error authenticating",o)}):(this.debug("No signer available for authentication localhost"),(i=this.ndk)==null||i.once("signer:ready",a))),this._status=5,this.ndkRelay.emit("authed")}}}else this.ndkRelay.emit("auth",n)}onError(n){this.debug(`WebSocket error on ${this.ndkRelay.url}:`,n)}get status(){return this._status}isAvailable(){return this._status===5}isFlapping(){const n=this._connectionStats.durations;if(n.length%3!==0)return!1;const e=n.reduce((a,o)=>a+o,0)/n.length,s=n.map(a=>(a-e)**2).reduce((a,o)=>a+o,0)/n.length;return Math.sqrt(s)<FLAPPING_THRESHOLD_MS}async onNotice(n){this.ndkRelay.emit("notice",n)}handleReconnection(n=0){if(this.reconnectTimeout)return;if(this.isFlapping()){this.ndkRelay.emit("flapping",this._connectionStats),this._status=3;return}let t;if(this.wasIdle){const e=[0,1e3,2e3,5e3,1e4,3e4];t=e[Math.min(n,e.length-1)],this.debug(`Using aggressive reconnect after idle, attempt ${n}, delay ${t}ms`)}else this.connectedAt?t=Math.max(0,6e4-(Date.now()-this.connectedAt)):(t=Math.min(1e3*Math.pow(2,n),3e4),this.debug(`Using standard backoff, attempt ${n}, delay ${t}ms`));this.reconnectTimeout=setTimeout(()=>{this.reconnectTimeout=void 0,this._status=2,this.connect().catch(e=>{n<MAX_RECONNECT_ATTEMPTS?this.handleReconnection(n+1):(this.debug("Max reconnect attempts reached"),this.wasIdle=!1)})},t),this.ndkRelay.emit("delayed-connect",t),this.debug("Reconnecting in",t),this._connectionStats.nextReconnectAt=Date.now()+t}async send(n){var e,s,i,r,a;Date.now()-this.lastMessageSent>12e4&&(this.wasIdle=!0),this._status>=5&&((e=this.ws)==null?void 0:e.readyState)===WebSocket.OPEN?((s=this.ws)==null||s.send(n),(i=this.netDebug)==null||i.call(this,n,this.ndkRelay,"send"),this.lastMessageSent=Date.now()):(this.debug(`Not connected to ${this.ndkRelay.url} (%d), not sending message ${n}`,this._status),this._status>=5&&((r=this.ws)==null?void 0:r.readyState)!==WebSocket.OPEN&&(this.debug(`Stale connection detected, WebSocket state: ${(a=this.ws)==null?void 0:a.readyState}`),this.handleStaleConnection()))}async auth(n){const t=new Promise((e,s)=>{const i=this.openEventPublishes.get(n.id)??[];i.push({resolve:e,reject:s}),this.openEventPublishes.set(n.id,i)});return this.send(`["AUTH",${JSON.stringify(n.rawEvent())}]`),t}async publish(n){const t=new Promise((e,s)=>{const i=this.openEventPublishes.get(n.id)??[];i.length>0&&console.warn(`Duplicate event publishing detected, you are publishing event ${n.id} twice`),i.push({resolve:e,reject:s}),this.openEventPublishes.set(n.id,i)});return this.send(`["EVENT",${JSON.stringify(n)}]`),t}async count(n,t){this.serial++;const e=(t==null?void 0:t.id)||`count:${this.serial}`,s=new Promise((i,r)=>{this.openCountRequests.set(e,{resolve:i,reject:r})});return this.send(`["COUNT","${e}",${JSON.stringify(n).substring(1)}`),s}close(n,t){this.send(`["CLOSE","${n}"]`);const e=this.openSubs.get(n);this.openSubs.delete(n),e&&e.onclose(t)}req(n){`${this.send(`["REQ","${n.subId}",${JSON.stringify(n.executeFilters).substring(1)}`)}`,this.openSubs.set(n.subId,n)}get connectionStats(){return this._connectionStats}get url(){return this.ndkRelay.url}get connected(){var n;return this._status>=5&&((n=this.ws)==null?void 0:n.readyState)===WebSocket.OPEN}},NDKRelayPublisher=class{constructor(n){c(this,"ndkRelay");c(this,"debug");this.ndkRelay=n,this.debug=n.debug.extend("publisher")}async publish(n,t=2500){let e;const s=()=>new Promise((u,f)=>{try{this.publishEvent(n).then(p=>{this.ndkRelay.emit("published",n),n.emit("relay:published",this.ndkRelay),u(!0)}).catch(f)}catch(p){f(p)}}),i=new Promise((u,f)=>{e=setTimeout(()=>{e=void 0,f(new Error(`Timeout: ${t}ms`))},t)}),r=()=>{s().then(u=>a(u)).catch(u=>o(u))};let a,o;const l=u=>{throw this.ndkRelay.debug("Publish failed",u,n.id),this.ndkRelay.emit("publish:failed",n,u),n.emit("relay:publish:failed",this.ndkRelay,u),u},h=()=>{e&&clearTimeout(e),this.ndkRelay.removeListener("connect",r)};return this.ndkRelay.status>=5?Promise.race([s(),i]).catch(l).finally(h):(this.ndkRelay.status<=1?(console.warn("Relay is disconnected, trying to connect to publish an event",this.ndkRelay.url),this.ndkRelay.connect()):console.warn("Relay not connected, waiting for connection to publish an event",this.ndkRelay.url),Promise.race([new Promise((u,f)=>{a=u,o=f,this.ndkRelay.on("connect",r)}),i]).catch(l).finally(h))}async publishEvent(n){return this.ndkRelay.connectivity.publish(n.rawEvent())}};function filterFingerprint(n,t){const e=[];for(const i of n){const r=Object.entries(i||{}).map(([a,o])=>["since","until"].includes(a)?`${a}:${o}`:a).sort().join("-");e.push(r)}let s=t?"+":"";return s+=e.join("|"),s}function mergeFilters(n){const t=[],e={};return n.filter(s=>!!s.limit).forEach(s=>t.push(s)),n=n.filter(s=>!s.limit),n.length===0?t:(n.forEach(s=>{Object.entries(s).forEach(([i,r])=>{Array.isArray(r)?e[i]===void 0?e[i]=[...r]:e[i]=Array.from(new Set([...e[i],...r])):e[i]=r})}),[...t,e])}var NDKRelaySubscription=class{constructor(n,t,e){c(this,"fingerprint");c(this,"items",new Map);c(this,"topSubManager");c(this,"debug");c(this,"status",0);c(this,"onClose");c(this,"relay");c(this,"eosed",!1);c(this,"executionTimer");c(this,"fireTime");c(this,"delayType");c(this,"executeFilters");c(this,"id",Math.random().toString(36).substring(7));c(this,"_subId");c(this,"subIdParts",new Set);c(this,"executeOnRelayReady",()=>{if(this.status===2){if(this.items.size===0){this.debug("No items to execute; this relay was probably too slow to respond and the caller gave up",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size,id:this.id,subId:this.subId}),this.cleanup();return}this.debug("Executing on relay ready",{status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.status=1,this.execute()}});c(this,"reExecuteAfterAuth",(()=>{const n=this.subId;this.debug("Re-executing after auth",this.items.size),this.eosed?this.relay.close(this.subId):this.debug("We are abandoning an opened subscription, once it EOSE's, the handler will close it",{oldSubId:n}),this._subId=void 0,this.status=1,this.execute(),this.debug("Re-executed after auth %s  %s",n,this.subId)}).bind(this));this.relay=n,this.topSubManager=e,this.debug=n.debug.extend(`sub[${this.id}]`),this.fingerprint=t||Math.random().toString(36).substring(7)}get subId(){return this._subId?this._subId:(this._subId=this.fingerprint.slice(0,15),this._subId)}addSubIdPart(n){this.subIdParts.add(n)}addItem(n,t){if(this.debug("Adding item",{filters:t,internalId:n.internalId,status:this.status,fingerprint:this.fingerprint,id:this.subId,items:this.items,itemsSize:this.items.size}),!this.items.has(n.internalId))switch(n.on("close",this.removeItem.bind(this,n)),this.items.set(n.internalId,{subscription:n,filters:t}),this.status!==3&&n.subId&&(!this._subId||this._subId.length<48)&&(this.status===0||this.status===1)&&this.addSubIdPart(n.subId),this.status){case 0:this.evaluateExecutionPlan(n);break;case 3:break;case 1:this.evaluateExecutionPlan(n);break;case 4:throw this.debug("Subscription is closed, cannot add new items %o (%o)",n,t),new Error("Cannot add new items to a closed subscription")}}removeItem(n){if(this.items.delete(n.internalId),this.items.size===0){if(!this.eosed)return;this.close(),this.cleanup()}}close(){if(this.status===4)return;const n=this.status;if(this.status=4,n===3)try{this.relay.close(this.subId)}catch(t){this.debug("Error closing subscription",t,this)}else this.debug("Subscription wanted to close but it wasn't running, this is probably ok",{subId:this.subId,prevStatus:n,sub:this});this.cleanup()}cleanup(){this.executionTimer&&clearTimeout(this.executionTimer),this.relay.off("ready",this.executeOnRelayReady),this.relay.off("authed",this.reExecuteAfterAuth),this.onClose&&this.onClose(this)}evaluateExecutionPlan(n){if(!n.isGroupable()){this.status=1,this.execute();return}if(n.filters.find(s=>!!s.limit)&&(this.executeFilters=this.compileFilters(),this.executeFilters.length>=10)){this.status=1,this.execute();return}const t=n.groupableDelay,e=n.groupableDelayType;if(!t)throw new Error("Cannot group a subscription without a delay");if(this.status===0)this.schedule(t,e);else{const s=this.delayType,i=this.fireTime-Date.now();if(s==="at-least"&&e==="at-least")i<t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,e));else if(s==="at-least"&&e==="at-most")i>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,e));else if(s==="at-most"&&e==="at-most")i>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,e));else if(s==="at-most"&&e==="at-least")i>t&&(this.executionTimer&&clearTimeout(this.executionTimer),this.schedule(t,e));else throw new Error(`Unknown delay type combination ${s} ${e}`)}}schedule(n,t){this.status=1;const e=Date.now();this.fireTime=e+n,this.delayType=t;const s=setTimeout(this.execute.bind(this),n);t==="at-least"&&(this.executionTimer=s)}finalizeSubId(){this.subIdParts.size>0?this._subId=Array.from(this.subIdParts).join("-"):this._subId=this.fingerprint.slice(0,15),this._subId+=`-${Math.random().toString(36).substring(2,7)}`}execute(){if(this.status===1){if(!this.relay.connected){this.status=2,this.debug("Waiting for relay to be ready",{status:this.status,id:this.subId,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.relay.once("ready",this.executeOnRelayReady);return}this.relay.status<8&&this.relay.once("authed",this.reExecuteAfterAuth),this.status=3,this.finalizeSubId(),this.executeFilters=this.compileFilters(),this.relay.req(this)}}onstart(){}onevent(n){this.topSubManager.dispatchEvent(n,this.relay)}oneose(n){if(this.eosed=!0,n!==this.subId){this.debug("Received EOSE for an abandoned subscription",n,this.subId),this.relay.close(n);return}this.items.size===0&&this.close();for(const{subscription:t}of this.items.values())t.eoseReceived(this.relay),t.closeOnEose&&(this.debug("Removing item because of EOSE",{filters:t.filters,internalId:t.internalId,status:this.status,fingerprint:this.fingerprint,items:this.items,itemsSize:this.items.size}),this.removeItem(t))}onclose(n){this.status=4}onclosed(n){if(n)for(const{subscription:t}of this.items.values())t.closedReceived(this.relay,n)}compileFilters(){const n=[],t=Array.from(this.items.values()).map(s=>s.filters);if(!t[0])return this.debug(" No filters to merge",this.items),console.error("BUG: No filters to merge!",this.items),[];const e=t[0].length;for(let s=0;s<e;s++){const i=t.map(r=>r[s]);n.push(...mergeFilters(i))}return n}},NDKRelaySubscriptionManager=class{constructor(n,t){c(this,"relay");c(this,"subscriptions");c(this,"generalSubManager");this.relay=n,this.subscriptions=new Map,this.generalSubManager=t}addSubscription(n,t){let e;if(!n.isGroupable())e=this.createSubscription(n,t);else{const s=filterFingerprint(t,n.closeOnEose);s&&(e=(this.subscriptions.get(s)||[]).find(r=>r.status<3)),e??(e=this.createSubscription(n,t,s))}e.addItem(n,t)}createSubscription(n,t,e){const s=new NDKRelaySubscription(this.relay,e||null,this.generalSubManager);s.onClose=this.onRelaySubscriptionClose.bind(this);const i=this.subscriptions.get(s.fingerprint)??[];return this.subscriptions.set(s.fingerprint,[...i,s]),s}onRelaySubscriptionClose(n){let t=this.subscriptions.get(n.fingerprint)??[];t?t.length===1?this.subscriptions.delete(n.fingerprint):(t=t.filter(e=>e.id!==n.id),this.subscriptions.set(n.fingerprint,t)):console.warn("Unexpectedly did not find a subscription with fingerprint",n.fingerprint)}},ve,NDKRelay=(ve=class extends libExports.EventEmitter{constructor(e,s,i){super();c(this,"url");c(this,"scores");c(this,"connectivity");c(this,"subs");c(this,"publisher");c(this,"authPolicy");c(this,"lowestValidationRatio");c(this,"targetValidationRatio");c(this,"validationRatioFn");c(this,"validatedEventCount",0);c(this,"nonValidatedEventCount",0);c(this,"trusted",!1);c(this,"complaining",!1);c(this,"debug");c(this,"req");c(this,"close");this.url=normalizeRelayUrl(e),this.scores=new Map,this.debug=createDebug2(`ndk:relay:${e}`),this.connectivity=new NDKRelayConnectivity(this,i),this.connectivity.netDebug=i==null?void 0:i.netDebug,this.req=this.connectivity.req.bind(this.connectivity),this.close=this.connectivity.close.bind(this.connectivity),this.subs=new NDKRelaySubscriptionManager(this,i.subManager),this.publisher=new NDKRelayPublisher(this),this.authPolicy=s,this.targetValidationRatio=i==null?void 0:i.initialValidationRatio,this.lowestValidationRatio=i==null?void 0:i.lowestValidationRatio,this.validationRatioFn=((i==null?void 0:i.validationRatioFn)??ve.defaultValidationRatioUpdateFn).bind(this),this.updateValidationRatio(),i||console.trace("relay created without ndk")}updateValidationRatio(){if(this.validationRatioFn&&this.validatedEventCount>0){const e=this.validationRatioFn(this,this.validatedEventCount,this.nonValidatedEventCount);this.targetValidationRatio=e}setTimeout(()=>{this.updateValidationRatio()},3e4)}get status(){return this.connectivity.status}get connectionStats(){return this.connectivity.connectionStats}async connect(e,s=!0){return this.connectivity.connect(e,s)}disconnect(){this.status!==1&&this.connectivity.disconnect()}subscribe(e,s){this.subs.addSubscription(e,s)}async publish(e,s=2500){return this.publisher.publish(e,s)}referenceTags(){return[["r",this.url]]}addValidatedEvent(){this.validatedEventCount++}addNonValidatedEvent(){this.nonValidatedEventCount++}get validationRatio(){return this.nonValidatedEventCount===0?1:this.validatedEventCount/(this.validatedEventCount+this.nonValidatedEventCount)}shouldValidateEvent(){return this.trusted?!1:this.targetValidationRatio===void 0||this.targetValidationRatio>=1?!0:Math.random()<this.targetValidationRatio}get connected(){return this.connectivity.connected}},c(ve,"defaultValidationRatioUpdateFn",(e,s,i)=>{if(e.lowestValidationRatio===void 0||e.targetValidationRatio===void 0)return 1;let r=e.validationRatio;if(e.validationRatio>e.targetValidationRatio){const a=s/100;r=Math.max(e.lowestValidationRatio,e.validationRatio-a)}return r<e.validationRatio?r:e.validationRatio}),ve),NDKPublishError=class extends Error{constructor(t,e,s,i){super(t);c(this,"errors");c(this,"publishedToRelays");c(this,"intendedRelaySet");this.errors=e,this.publishedToRelays=s,this.intendedRelaySet=i}get relayErrors(){const t=[];for(const[e,s]of this.errors)t.push(`${e.url}: ${s}`);return t.join(`
`)}},NDKRelaySet=class Fe{constructor(t,e,s){c(this,"relays");c(this,"debug");c(this,"ndk");c(this,"pool");this.relays=t,this.ndk=e,this.pool=s??e.pool,this.debug=e.debug.extend("relayset")}addRelay(t){this.relays.add(t)}get relayUrls(){return Array.from(this.relays).map(t=>t.url)}static fromRelayUrls(t,e,s=!0,i){if(i=i??e.pool,!i)throw new Error("No pool provided");const r=new Set;for(const a of t){const o=i.relays.get(normalizeRelayUrl(a));if(o)o.status<5&&s&&o.connect(),r.add(o);else{const l=new NDKRelay(normalizeRelayUrl(a),e==null?void 0:e.relayAuthDefaultPolicy,e);i.useTemporaryRelay(l,void 0,`requested from fromRelayUrls ${t}`),r.add(l)}}return new Fe(new Set(r),e,i)}async publish(t,e,s=1){var l;const i=new Set,r=new Map,a=t.isEphemeral();t.publishStatus="pending";const o=h=>{i.add(h)};t.on("relay:published",o);try{const h=Array.from(this.relays).map(u=>new Promise(f=>{const p=e?setTimeout(()=>{i.has(u)||(r.set(u,new Error(`Publish timeout after ${e}ms`)),f(!1))},e):null;u.publish(t,e).then(g=>{p&&clearTimeout(p),g?(i.add(u),f(!0)):f(!1)}).catch(g=>{p&&clearTimeout(p),a||r.set(u,g),f(!1)})}));if(await Promise.all(h),i.size<s){if(!a){const u=new NDKPublishError("Not enough relays received the event ("+i.size+" published, "+s+" required)",r,i,this);throw t.publishStatus="error",t.publishError=u,(l=this.ndk)==null||l.emit("event:publish-failed",t,u,this.relayUrls),u}}else t.publishStatus="success",t.emit("published",{relaySet:this,publishedToRelays:i});return i}finally{t.off("relay:published",o)}}get size(){return this.relays.size}},d$1=createDebug2("ndk:outbox:calculate");async function calculateRelaySetFromEvent(n,t,e){var o,l;const s=new Set,i=await getWriteRelaysFor(n,t.pubkey);i&&i.forEach(h=>{var f;const u=(f=n.pool)==null?void 0:f.getRelay(h);u&&s.add(u)});let r=t.tags.filter(h=>["a","e"].includes(h[0])).map(h=>h[2]).filter(h=>h==null?void 0:h.startsWith("wss://")).filter(h=>{try{return new URL(h),!0}catch{return!1}}).map(h=>normalizeRelayUrl(h));r=Array.from(new Set(r)).slice(0,5),r.forEach(h=>{var f;const u=(f=n.pool)==null?void 0:f.getRelay(h,!0,!0);u&&(d$1("Adding relay hint %s",h),s.add(u))});const a=t.getMatchingTags("p").map(h=>h[1]);if(a.length<5?Array.from(chooseRelayCombinationForPubkeys(n,a,"read",{preferredRelays:new Set(i)}).keys()).forEach(u=>{var p;const f=(p=n.pool)==null?void 0:p.getRelay(u,!1,!0);f&&(d$1("Adding p-tagged relay %s",u),s.add(f))}):d$1("Too many p-tags to consider %d",a.length),(o=n.pool)==null||o.permanentAndConnectedRelays().forEach(h=>s.add(h)),e&&s.size<e){const h=(l=n.explicitRelayUrls)==null?void 0:l.filter(u=>!Array.from(s).some(f=>f.url===u)).slice(0,e-s.size);h==null||h.forEach(u=>{var p;const f=(p=n.pool)==null?void 0:p.getRelay(u,!1,!0);f&&(d$1("Adding explicit relay %s",u),s.add(f))})}return new NDKRelaySet(s,n)}function mergeTags(n,t){const e=new Map,s=a=>a.join(","),i=(a,o)=>a.every((l,h)=>l===o[h]),r=a=>{for(const[o,l]of e)if(i(l,a)||i(a,l)){a.length>=l.length&&e.set(o,a);return}e.set(s(a),a)};return n.concat(t).forEach(r),Array.from(e.values())}var hashtagRegex=new RegExp(`(?<=\\s|^)(#[^\\s!@#$%^&*()=+./,[{\\]};:'"?><]+)`,"g");function generateHashtags(n){const t=n.match(hashtagRegex),e=new Set,s=new Set;if(t)for(const i of t)e.has(i.slice(1))||(s.add(i.slice(1)),e.add(i.slice(1)));return Array.from(s)}async function generateContentTags(n,t=[],e,s){var o,l;if(e!=null&&e.skipContentTagging)return{content:n,tags:t};const i=/(@|nostr:)(npub|nprofile|note|nevent|naddr)[a-zA-Z0-9]+/g,r=[],a=h=>{t.find(u=>["q",h[0]].includes(u[0])&&u[1]===h[1])||t.push(h)};if(n=n.replace(i,h=>{var u;try{const f=h.split(/(@|nostr:)/)[2],{type:p,data:g}=nip19_exports$2.decode(f);let m;if(e!=null&&e.filters){const w=!e.filters.includeTypes||e.filters.includeTypes.includes(p),b=(u=e.filters.excludeTypes)==null?void 0:u.includes(p);if(!w||b)return h}switch(p){case"npub":(e==null?void 0:e.pTags)!==!1&&(m=["p",g]);break;case"nprofile":(e==null?void 0:e.pTags)!==!1&&(m=["p",g.pubkey]);break;case"note":r.push(new Promise(async w=>{const b=await maybeGetEventRelayUrl(f);a(["q",g,b]),w()}));break;case"nevent":r.push(new Promise(async w=>{const{id:b,author:E}=g;let{relays:$}=g;(!$||$.length===0)&&($=[await maybeGetEventRelayUrl(f)]),a(["q",b,$[0]]),E&&(e==null?void 0:e.pTags)!==!1&&(e==null?void 0:e.pTagOnQTags)!==!1&&a(["p",E]),w()}));break;case"naddr":r.push(new Promise(async w=>{const b=[g.kind,g.pubkey,g.identifier].join(":");let E=g.relays??[];E.length===0&&(E=[await maybeGetEventRelayUrl(f)]),a(["q",b,E[0]]),(e==null?void 0:e.pTags)!==!1&&(e==null?void 0:e.pTagOnQTags)!==!1&&(e==null?void 0:e.pTagOnATags)!==!1&&a(["p",g.pubkey]),w()}));break;default:return h}return m&&a(m),`nostr:${f}`}catch{return h}}),await Promise.all(r),!((l=(o=e==null?void 0:e.filters)==null?void 0:o.excludeTypes)!=null&&l.includes("hashtag"))){const h=generateHashtags(n).map(u=>["t",u]);t=mergeTags(t,h)}if((e==null?void 0:e.pTags)!==!1&&(e!=null&&e.copyPTagsFromTarget)&&s){const h=s.getMatchingTags("p");for(const u of h)t.find(f=>f[0]==="p"&&f[1]===u[1])||t.push(u)}return{content:n,tags:t}}async function maybeGetEventRelayUrl(n){return""}async function encrypt(n,t,e="nip44"){let s;if(!this.ndk)throw new Error("No NDK instance found!");let i=t;if(i||(this.ndk.assertSigner(),i=this.ndk.signer),!i)throw new Error("no NDK signer");const r=n||(()=>{const a=this.getMatchingTags("p");if(a.length!==1)throw new Error("No recipient could be determined and no explicit recipient was provided");return this.ndk.getUser({pubkey:a[0][1]})})();if(e==="nip44"&&await isEncryptionEnabled(i,"nip44")&&(s=await i.encrypt(r,this.content,"nip44")),(!s||e==="nip04")&&await isEncryptionEnabled(i,"nip04")&&(s=await i.encrypt(r,this.content,"nip04")),!s)throw new Error("Failed to encrypt event.");this.content=s}async function decrypt(n,t,e){var o,l,h,u;if((l=(o=this.ndk)==null?void 0:o.cacheAdapter)!=null&&l.getDecryptedEvent){let f=null;if(typeof this.ndk.cacheAdapter.getDecryptedEvent=="function"&&(f=this.ndk.cacheAdapter.getDecryptedEvent(this.id)),f){this.content=f.content;return}}let s;if(!this.ndk)throw new Error("No NDK instance found!");let i=t;if(i||(this.ndk.assertSigner(),i=this.ndk.signer),!i)throw new Error("no NDK signer");const r=n||this.author;if(!r)throw new Error("No sender provided and no author available");const a=e||(this.content.match(/\\?iv=/)?"nip04":"nip44");if((a==="nip04"||this.kind===4)&&await isEncryptionEnabled(i,"nip04")&&this.content.search("\\?iv=")&&(s=await i.decrypt(r,this.content,"nip04")),!s&&a==="nip44"&&await isEncryptionEnabled(i,"nip44")&&(s=await i.decrypt(r,this.content,"nip44")),!s)throw new Error("Failed to decrypt event.");this.content=s,(u=(h=this.ndk)==null?void 0:h.cacheAdapter)!=null&&u.addDecryptedEvent&&this.ndk.cacheAdapter.addDecryptedEvent(this)}async function isEncryptionEnabled(n,t){return n.encryptionEnabled?t?!!await n.encryptionEnabled(t):!0:!1}function eventHasETagMarkers(n){for(const t of n.tags)if(t[0]==="e"&&(t[3]??"").length>0)return!0;return!1}function getRootTag(n,t){t??(t=n.tagType());const e=n.tags.find(isTagRootTag);if(!e){if(eventHasETagMarkers(n))return;const s=n.getMatchingTags(t);if(s.length<3)return s[0]}return e}var nip22RootTags=new Set(["A","E","I"]),nip22ReplyTags=new Set(["a","e","i"]);function getReplyTag(n,t){if(n.kind===1111){let i;for(const r of n.tags)if(nip22RootTags.has(r[0]))i=r;else if(nip22ReplyTags.has(r[0])){i=r;break}return i}t??(t=n.tagType());let e=!1,s;for(const i of n.tags)if(i[0]===t){if((i[3]??"").length>0&&(e=!0),e&&i[3]==="reply")return i;e&&i[3]==="root"&&(s=i),e||(s=i)}return s}function isTagRootTag(n){return n[0]==="E"||n[3]==="root"}async function fetchTaggedEvent(n,t){if(!this.ndk)throw new Error("NDK instance not found");const e=this.getMatchingTags(n,t);if(e.length===0)return;const[s,i,r]=e[0];let a=r!==""?this.ndk.pool.getRelay(r):void 0;return await this.ndk.fetchEvent(i,{},a)}async function fetchRootEvent(n){if(!this.ndk)throw new Error("NDK instance not found");const t=getRootTag(this);if(t)return this.ndk.fetchEventFromTag(t,this,n)}async function fetchReplyEvent(n){if(!this.ndk)throw new Error("NDK instance not found");const t=getReplyTag(this);if(t)return this.ndk.fetchEventFromTag(t,this,n)}function isReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return[0,3].includes(this.kind)||this.kind>=1e4&&this.kind<2e4||this.kind>=3e4&&this.kind<4e4}function isEphemeral(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=2e4&&this.kind<3e4}function isParamReplaceable(){if(this.kind===void 0)throw new Error("Kind not set");return this.kind>=3e4&&this.kind<4e4}var DEFAULT_RELAY_COUNT=2;function encode(n=DEFAULT_RELAY_COUNT){let t=[];return this.onRelays.length>0?t=this.onRelays.map(e=>e.url):this.relay&&(t=[this.relay.url]),t.length>n&&(t=t.slice(0,n)),this.isParamReplaceable()?nip19_exports$2.naddrEncode({kind:this.kind,pubkey:this.pubkey,identifier:this.replaceableDTag(),relays:t}):t.length>0?nip19_exports$2.neventEncode({id:this.tagId(),relays:t,author:this.pubkey}):nip19_exports$2.noteEncode(this.tagId())}async function repost(n=!0,t){if(!t&&n){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),t=this.ndk.signer}const e=new NDKEvent(this.ndk,{kind:getKind(this)});return this.isProtected||(e.content=JSON.stringify(this.rawEvent())),e.tag(this),this.kind!==1&&e.tags.push(["k",`${this.kind}`]),t&&await e.sign(t),n&&await e.publish(),e}function getKind(n){return n.kind===1?6:16}function serialize(n=!1,t=!1){const e=[0,this.pubkey,this.created_at,this.kind,this.tags,this.content];return n&&e.push(this.sig),t&&e.push(this.id),JSON.stringify(e)}function deserialize(n){const t=JSON.parse(n),e={pubkey:t[1],created_at:t[2],kind:t[3],tags:t[4],content:t[5]};if(t.length>=7){const s=t[6],i=t[7];s&&s.length===128?(e.sig=s,i&&i.length===64&&(e.id=i)):s&&s.length===64&&(e.id=s,i&&i.length===128&&(e.sig=i))}return e}var processingQueue={};async function verifySignatureAsync(n,t,e){const s=n.ndk,i=Date.now();let r;return s.signatureVerificationFunction?(console.log("[NDK-CORE] Using custom signature verification function async"),r=await s.signatureVerificationFunction(n),console.log("Custom signature verification result",n.id,{result:r})):(console.log("Using worker-based signature verification async"),r=await new Promise(a=>{n.serialize();let o=!1;processingQueue[n.id]||(processingQueue[n.id]={event:n,resolves:[],relay:e},o=!0),processingQueue[n.id].resolves.push(a)})),s.signatureVerificationTimeMs+=Date.now()-i,r}var PUBKEY_REGEX=/^[a-f0-9]{64}$/;function validate(){if(typeof this.kind!="number"||typeof this.content!="string"||typeof this.created_at!="number"||typeof this.pubkey!="string"||!this.pubkey.match(PUBKEY_REGEX)||!Array.isArray(this.tags))return!1;for(let n=0;n<this.tags.length;n++){const t=this.tags[n];if(!Array.isArray(t))return!1;for(let e=0;e<t.length;e++)if(typeof t[e]=="object")return!1}return!0}var verifiedSignatures=new distExports.LRUCache({maxSize:1e3,entryExpirationTimeInMS:6e4});function verifySignature(n){var e;if(typeof this.signatureVerified=="boolean")return this.signatureVerified;const t=verifiedSignatures.get(this.id);if(t!==null)return this.signatureVerified=!!t,this.signatureVerified;try{if((e=this.ndk)!=null&&e.asyncSigVerification)verifySignatureAsync(this,n,this.relay).then(s=>{var i,r;n&&(this.signatureVerified=s,s&&verifiedSignatures.set(this.id,this.sig)),s||(this.relay?(i=this.ndk)==null||i.reportInvalidSignature(this,this.relay):(r=this.ndk)==null||r.reportInvalidSignature(this),verifiedSignatures.set(this.id,!1))}).catch(s=>{console.error("signature verification error",this.id,s)});else{const s=sha256(new TextEncoder().encode(this.serialize())),i=schnorr.verify(this.sig,s,this.pubkey);return i?verifiedSignatures.set(this.id,this.sig):verifiedSignatures.set(this.id,!1),this.signatureVerified=i,i}}catch{return this.signatureVerified=!1,!1}}function getEventHash(){return getEventHashFromSerializedEvent(this.serialize())}function getEventHashFromSerializedEvent(n){const t=sha256(new TextEncoder().encode(n));return bytesToHex(t)}var skipClientTagOnKinds=new Set([0,4,1059,13,3,9734,5]),NDKEvent=class oe extends libExports.EventEmitter{constructor(e,s){var i;super();c(this,"ndk");c(this,"created_at");c(this,"content","");c(this,"tags",[]);c(this,"kind");c(this,"id","");c(this,"sig");c(this,"pubkey","");c(this,"signatureVerified");c(this,"_author");c(this,"relay");c(this,"publishStatus","success");c(this,"publishError");c(this,"serialize",serialize.bind(this));c(this,"getEventHash",getEventHash.bind(this));c(this,"validate",validate.bind(this));c(this,"verifySignature",verifySignature.bind(this));c(this,"isReplaceable",isReplaceable.bind(this));c(this,"isEphemeral",isEphemeral.bind(this));c(this,"isDvm",()=>this.kind&&this.kind>=5e3&&this.kind<=7e3);c(this,"isParamReplaceable",isParamReplaceable.bind(this));c(this,"encode",encode.bind(this));c(this,"encrypt",encrypt.bind(this));c(this,"decrypt",decrypt.bind(this));c(this,"fetchTaggedEvent",fetchTaggedEvent.bind(this));c(this,"fetchRootEvent",fetchRootEvent.bind(this));c(this,"fetchReplyEvent",fetchReplyEvent.bind(this));c(this,"repost",repost.bind(this));this.ndk=e,this.created_at=s==null?void 0:s.created_at,this.content=(s==null?void 0:s.content)||"",this.tags=(s==null?void 0:s.tags)||[],this.id=(s==null?void 0:s.id)||"",this.sig=s==null?void 0:s.sig,this.pubkey=(s==null?void 0:s.pubkey)||"",this.kind=s==null?void 0:s.kind,s instanceof oe&&(this.relay&&(this.relay=s.relay,(i=this.ndk)==null||i.subManager.seenEvent(s.id,this.relay)),this.publishStatus=s.publishStatus,this.publishError=s.publishError)}get onRelays(){let e=[];return this.ndk?e=this.ndk.subManager.seenEvents.get(this.id)||[]:this.relay&&e.push(this.relay),e}static deserialize(e,s){return new oe(e,deserialize(s))}rawEvent(){return{created_at:this.created_at,content:this.content,tags:this.tags,kind:this.kind,pubkey:this.pubkey,id:this.id,sig:this.sig}}set author(e){var s;this.pubkey=e.pubkey,this._author=e,(s=this._author).ndk??(s.ndk=this.ndk)}get author(){if(this._author)return this._author;if(!this.ndk)throw new Error("No NDK instance found");const e=this.ndk.getUser({pubkey:this.pubkey});return this._author=e,e}tagExternal(e,s,i){const r=["i"],a=["k"];switch(s){case"url":{const o=new URL(e);o.hash="",r.push(o.toString()),a.push(`${o.protocol}//${o.host}`);break}case"hashtag":r.push(`#${e.toLowerCase()}`),a.push("#");break;case"geohash":r.push(`geo:${e.toLowerCase()}`),a.push("geo");break;case"isbn":r.push(`isbn:${e.replace(/-/g,"")}`),a.push("isbn");break;case"podcast:guid":r.push(`podcast:guid:${e}`),a.push("podcast:guid");break;case"podcast:item:guid":r.push(`podcast:item:guid:${e}`),a.push("podcast:item:guid");break;case"podcast:publisher:guid":r.push(`podcast:publisher:guid:${e}`),a.push("podcast:publisher:guid");break;case"isan":r.push(`isan:${e.split("-").slice(0,4).join("-")}`),a.push("isan");break;case"doi":r.push(`doi:${e.toLowerCase()}`),a.push("doi");break;default:throw new Error(`Unsupported NIP-73 entity type: ${s}`)}i&&r.push(i),this.tags.push(r),this.tags.push(a)}tag(e,s,i,r,a){let o=[];if(e.fetchProfile!==void 0){if(r??(r="p"),r==="p"&&(a==null?void 0:a.pTags)===!1)return;const h=[r,e.pubkey];s&&h.push("",s),o.push(h)}else if(e instanceof oe){const h=e;if(i??(i=(h==null?void 0:h.pubkey)===this.pubkey),o=h.referenceTags(s,i,r,a),(a==null?void 0:a.pTags)!==!1)for(const u of h.getMatchingTags("p"))u[1]!==this.pubkey&&(this.tags.find(f=>f[0]==="p"&&f[1]===u[1])||this.tags.push(["p",u[1]]))}else if(Array.isArray(e))o=[e];else throw new Error("Invalid argument",e);this.tags=mergeTags(this.tags,o)}async toNostrEvent(e,s){var a,o;if(!e&&this.pubkey===""){const l=await((o=(a=this.ndk)==null?void 0:a.signer)==null?void 0:o.user());this.pubkey=(l==null?void 0:l.pubkey)||""}this.created_at||(this.created_at=Math.floor(Date.now()/1e3));const{content:i,tags:r}=await this.generateTags(s);this.content=i||"",this.tags=r;try{this.id=this.getEventHash()}catch{}return this.rawEvent()}getMatchingTags(e,s){const i=this.tags.filter(r=>r[0]===e);return s===void 0?i:i.filter(r=>r[3]===s)}hasTag(e,s){return this.tags.some(i=>i[0]===e&&(!s||i[3]===s))}tagValue(e,s){const i=this.getMatchingTags(e,s);if(i.length!==0)return i[0][1]}get alt(){return this.tagValue("alt")}set alt(e){this.removeTag("alt"),e&&this.tags.push(["alt",e])}get dTag(){return this.tagValue("d")}set dTag(e){this.removeTag("d"),e&&this.tags.push(["d",e])}removeTag(e,s){const i=Array.isArray(e)?e:[e];this.tags=this.tags.filter(r=>{const a=i.includes(r[0]),o=s?r[3]===s:!0;return!(a&&o)})}replaceTag(e){this.removeTag(e[0]),this.tags.push(e)}async sign(e,s){var r,a;e?this.author=await e.user():((r=this.ndk)==null||r.assertSigner(),e=(a=this.ndk)==null?void 0:a.signer);const i=await this.toNostrEvent(void 0,s);return this.sig=await e.sign(i),this.sig}async publishReplaceable(e,s,i){return this.id="",this.created_at=Math.floor(Date.now()/1e3),this.sig="",this.publish(e,s,i)}async publish(e,s,i,r){var l,h,u;if(i||(i=1),this.sig||await this.sign(void 0,r),!this.ndk)throw new Error("NDKEvent must be associated with an NDK instance to publish");if((!e||e.size===0)&&(e=this.ndk.devWriteRelaySet||await calculateRelaySetFromEvent(this.ndk,this,i)),this.kind===5&&((l=this.ndk.cacheAdapter)!=null&&l.deleteEventIds)){const f=this.getMatchingTags("e").map(p=>p[1]);this.ndk.cacheAdapter.deleteEventIds(f)}const a=this.rawEvent();if((h=this.ndk.cacheAdapter)!=null&&h.addUnpublishedEvent&&shouldTrackUnpublishedEvent(this))try{this.ndk.cacheAdapter.addUnpublishedEvent(this,e.relayUrls)}catch(f){console.error("Error adding unpublished event to cache",f)}this.kind===5&&((u=this.ndk.cacheAdapter)!=null&&u.deleteEventIds)&&this.ndk.cacheAdapter.deleteEventIds(this.getMatchingTags("e").map(f=>f[1])),this.ndk.subManager.dispatchEvent(a,void 0,!0);const o=await e.publish(this,s,i);return o.forEach(f=>{var p;return(p=this.ndk)==null?void 0:p.subManager.seenEvent(this.id,f)}),o}async generateTags(e){var a,o,l;let s=[];const i=await generateContentTags(this.content,this.tags,e,this),r=i.content;if(s=i.tags,this.kind&&this.isParamReplaceable()&&!this.getMatchingTags("d")[0]){const u=this.tagValue("title");let p=[...Array(u?6:16)].map(()=>Math.random().toString(36)[2]).join("");u&&u.length>0&&(p=`${u.replace(/[^a-z0-9]+/gi,"-").replace(/^-|-$/g,"")}-${p}`),s.push(["d",p])}if(this.shouldAddClientTag){const h=["client",((a=this.ndk)==null?void 0:a.clientName)??""];(o=this.ndk)!=null&&o.clientNip89&&h.push((l=this.ndk)==null?void 0:l.clientNip89),s.push(h)}else this.shouldStripClientTag&&(s=s.filter(h=>h[0]!=="client"));return{content:r||"",tags:s}}get shouldAddClientTag(){var e,s;return!(!((e=this.ndk)!=null&&e.clientName)&&!((s=this.ndk)!=null&&s.clientNip89)||skipClientTagOnKinds.has(this.kind)||this.isEphemeral()||this.isReplaceable()&&!this.isParamReplaceable()||this.isDvm()||this.hasTag("client"))}get shouldStripClientTag(){return skipClientTagOnKinds.has(this.kind)}muted(){var r,a;const e=(r=this.ndk)==null?void 0:r.mutedIds.get(this.pubkey);if(e&&e==="p")return"author";const s=this.tagReference(),i=(a=this.ndk)==null?void 0:a.mutedIds.get(s[1]);return i&&i===s[0]?"event":null}replaceableDTag(){if(this.kind&&this.kind>=3e4&&this.kind<=4e4){const e=this.getMatchingTags("d")[0];return e?e[1]:""}throw new Error("Event is not a parameterized replaceable event")}deduplicationKey(){return this.kind===0||this.kind===3||this.kind&&this.kind>=1e4&&this.kind<2e4?`${this.kind}:${this.pubkey}`:this.tagId()}tagId(){return this.isParamReplaceable()?this.tagAddress():this.id}tagAddress(){if(this.isParamReplaceable()){const e=this.dTag??"";return`${this.kind}:${this.pubkey}:${e}`}if(this.isReplaceable())return`${this.kind}:${this.pubkey}:`;throw new Error("Event is not a replaceable event")}tagType(){return this.isParamReplaceable()?"a":"e"}tagReference(e){let s;return this.isParamReplaceable()?s=["a",this.tagAddress()]:s=["e",this.tagId()],this.relay?s.push(this.relay.url):s.push(""),s.push(e??""),this.isParamReplaceable()||s.push(this.pubkey),s}referenceTags(e,s,i,r){let a=[];return this.isParamReplaceable()?a=[[i??"a",this.tagAddress()],[i??"e",this.id]]:a=[[i??"e",this.id]],a=a.map(o=>{var l,h,u;return o[0]==="e"||e?o.push(((l=this.relay)==null?void 0:l.url)??""):(h=this.relay)!=null&&h.url&&o.push((u=this.relay)==null?void 0:u.url),o}),a.forEach(o=>{o[0]==="e"?(o.push(e??""),o.push(this.pubkey)):e&&o.push(e)}),a=[...a,...this.getMatchingTags("h")],!s&&(r==null?void 0:r.pTags)!==!1&&a.push(...this.author.referenceTags()),a}filter(){return this.isParamReplaceable()?{"#a":[this.tagId()]}:{"#e":[this.tagId()]}}nip22Filter(){return this.isParamReplaceable()?{"#A":[this.tagId()]}:{"#E":[this.tagId()]}}async delete(e,s=!0){var r;if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const i=new oe(this.ndk,{kind:5,content:e||""});return i.tag(this,void 0,!0),i.tags.push(["k",(r=this.kind)==null?void 0:r.toString()]),s&&(this.emit("deleted"),await i.publish()),i}set isProtected(e){this.removeTag("-"),e&&this.tags.push(["-"])}get isProtected(){return this.hasTag("-")}async react(e,s=!0){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner();const i=new oe(this.ndk,{kind:7,content:e});return i.tag(this),this.kind!==1&&i.tags.push(["k",`${this.kind}`]),s&&await i.publish(),i}get isValid(){return this.validate()}get inspect(){return JSON.stringify(this.rawEvent(),null,4)}dump(){console.debug(JSON.stringify(this.rawEvent(),null,4)),console.debug("Event on relays:",this.onRelays.map(e=>e.url).join(", "))}reply(e,s){var r,a,o,l,h;const i=new oe(this.ndk);if(this.kind===1&&!e)i.kind=1,this.hasTag("e")?i.tags=[...i.tags,...this.getMatchingTags("e"),...this.getMatchingTags("p"),...this.getMatchingTags("a"),...this.referenceTags("reply",!1,void 0,s)]:i.tag(this,"root",!1,void 0,s);else{i.kind=1111;const u=["A","E","I","P"],f=this.tags.filter(p=>u.includes(p[0]));if(f.length>0){const p=this.tagValue("K");i.tags.push(...f),p&&i.tags.push(["K",p]);let g;if(this.isParamReplaceable()){g=["a",this.tagAddress()];const m=((r=this.relay)==null?void 0:r.url)??"";m&&g.push(m)}else{g=["e",this.tagId()];const m=((a=this.relay)==null?void 0:a.url)??"";g.push(m),g.push(this.pubkey)}i.tags.push(g)}else{let p,g;const m=((o=this.relay)==null?void 0:o.url)??"";this.isParamReplaceable()?(p=["a",this.tagAddress(),m],g=["A",this.tagAddress(),m]):(p=["e",this.tagId(),m,this.pubkey],g=["E",this.tagId(),m,this.pubkey]),i.tags.push(p),i.tags.push(g),i.tags.push(["K",(l=this.kind)==null?void 0:l.toString()]),(s==null?void 0:s.pTags)!==!1&&(s==null?void 0:s.pTagOnATags)!==!1&&i.tags.push(["P",this.pubkey])}i.tags.push(["k",(h=this.kind)==null?void 0:h.toString()]),(s==null?void 0:s.pTags)!==!1&&(i.tags.push(...this.getMatchingTags("p")),i.tags.push(["p",this.pubkey]))}return i}},untrackedUnpublishedEvents=new Set([24133,13194,23194,23195]);function shouldTrackUnpublishedEvent(n){return!untrackedUnpublishedEvents.has(n.kind)}var NDKPool=class extends libExports.EventEmitter{constructor(t,e,s,{debug:i,name:r}={}){super();c(this,"_relays",new Map);c(this,"status","idle");c(this,"autoConnectRelays",new Set);c(this,"poolBlacklistRelayUrls",new Set);c(this,"debug");c(this,"temporaryRelayTimers",new Map);c(this,"flappingRelays",new Set);c(this,"backoffTimes",new Map);c(this,"ndk");c(this,"disconnectionTimes",new Map);c(this,"systemEventDetector");c(this,"_name","unnamed");this.debug=i??s.debug.extend("pool"),r&&(this._name=r),this.ndk=s,this.relayUrls=t,this.poolBlacklistRelayUrls=new Set(e),this.ndk.pools.push(this)}get blacklistRelayUrls(){const t=new Set(this.ndk.blacklistRelayUrls);return this.poolBlacklistRelayUrls.forEach(e=>t.add(e)),t}get relays(){return this._relays}set relayUrls(t){this._relays.clear();for(const e of t){const s=new NDKRelay(e,void 0,this.ndk);s.connectivity.netDebug=this.ndk.netDebug,this.addRelay(s)}}get name(){return this._name}set name(t){this._name=t,this.debug=this.debug.extend(t)}useTemporaryRelay(t,e=3e4,s){const i=this.relays.has(t.url);i||(this.addRelay(t),this.debug("Adding temporary relay %s for filters %o",t.url,s));const r=this.temporaryRelayTimers.get(t.url);if(r&&clearTimeout(r),!i||r){const a=setTimeout(()=>{var o;(o=this.ndk.explicitRelayUrls)!=null&&o.includes(t.url)||this.removeRelay(t.url)},e);this.temporaryRelayTimers.set(t.url,a)}}addRelay(t,e=!0){var w,b;const s=this.relays.has(t.url),i=(w=this.blacklistRelayUrls)==null?void 0:w.has(t.url),r=t.url.includes("/npub1");let a=!0;const o=t.url;if(s)return;if(i){this.debug(`Refusing to add relay ${o}: blacklisted`);return}if(r){this.debug(`Refusing to add relay ${o}: is a filter relay`);return}if((b=this.ndk.cacheAdapter)!=null&&b.getRelayStatus){const E=this.ndk.cacheAdapter.getRelayStatus(o);if(E!=null&&E.dontConnectBefore){if(E.dontConnectBefore>Date.now()){const $=E.dontConnectBefore-Date.now();this.debug(`Refusing to add relay ${o}: delayed connect for ${$}ms`),setTimeout(()=>{this.addRelay(t,e)},$);return}a=!1}}const l=E=>this.emit("notice",t,E),h=()=>this.handleRelayConnect(o),u=()=>this.handleRelayReady(t),f=()=>{this.recordDisconnection(t),this.emit("relay:disconnect",t)},p=()=>this.handleFlapping(t),g=E=>this.emit("relay:auth",t,E),m=()=>this.emit("relay:authed",t);t.off("notice",l),t.off("connect",h),t.off("ready",u),t.off("disconnect",f),t.off("flapping",p),t.off("auth",g),t.off("authed",m),t.on("notice",l),t.on("connect",h),t.on("ready",u),t.on("disconnect",f),t.on("flapping",p),t.on("auth",g),t.on("authed",m),t.on("delayed-connect",E=>{var $;($=this.ndk.cacheAdapter)!=null&&$.updateRelayStatus&&this.ndk.cacheAdapter.updateRelayStatus(t.url,{dontConnectBefore:Date.now()+E})}),this._relays.set(o,t),e&&this.autoConnectRelays.add(o),e&&this.status==="active"&&(this.emit("relay:connecting",t),t.connect(void 0,a).catch(E=>{this.debug(`Failed to connect to relay ${o}`,E)}))}removeRelay(t){const e=this.relays.get(t);if(e)return e.disconnect(),this.relays.delete(t),this.autoConnectRelays.delete(t),this.emit("relay:disconnect",e),!0;const s=this.temporaryRelayTimers.get(t);return s&&(clearTimeout(s),this.temporaryRelayTimers.delete(t)),!1}isRelayConnected(t){const e=normalizeRelayUrl(t),s=this.relays.get(e);return s?s.status===5:!1}getRelay(t,e=!0,s=!1,i){let r=this.relays.get(normalizeRelayUrl(t));return r||(r=new NDKRelay(t,void 0,this.ndk),r.connectivity.netDebug=this.ndk.netDebug,s?this.useTemporaryRelay(r,3e4,i):this.addRelay(r,e)),r}handleRelayConnect(t){const e=this.relays.get(t);if(!e){console.error("NDK BUG: relay not found in pool",{relayUrl:t});return}this.emit("relay:connect",e),this.stats().connected===this.relays.size&&this.emit("connect")}handleRelayReady(t){this.emit("relay:ready",t)}async connect(t){this.status="active",this.debug(`Connecting to ${this.relays.size} relays${t?`, timeout ${t}ms`:""}...`);const e=Array.from(this.autoConnectRelays.keys()).map(a=>this.relays.get(a)).filter(a=>!!a);for(const a of e)a.status!==5&&a.status!==4&&(this.emit("relay:connecting",a),a.connect().catch(o=>{this.debug(`Failed to connect to relay ${a.url}: ${o??"No reason specified"}`)}));const s=()=>e.every(a=>a.status===5),i=new Promise(a=>{if(s()){a();return}const o=[];for(const l of e){const h=()=>{if(s()){for(let u=0;u<e.length;u++)e[u].off("connect",o[u]);a()}};o.push(h),l.on("connect",h)}}),r=typeof t=="number"?new Promise(a=>setTimeout(a,t)):new Promise(()=>{});await Promise.race([i,r])}checkOnFlappingRelays(){const t=this.flappingRelays.size,e=this.relays.size;if(t/e>=.8)for(const s of this.flappingRelays)this.backoffTimes.set(s,0)}recordDisconnection(t){const e=Date.now();this.disconnectionTimes.set(t.url,e);for(const[s,i]of this.disconnectionTimes.entries())e-i>1e4&&this.disconnectionTimes.delete(s);this.checkForSystemWideDisconnection()}checkForSystemWideDisconnection(){const t=Date.now(),e=[];for(const s of this.disconnectionTimes.values())t-s<5e3&&e.push(s);e.length>this.relays.size/2&&this.relays.size>1&&(this.debug(`System-wide disconnection detected: ${e.length}/${this.relays.size} relays disconnected`),this.handleSystemWideReconnection())}handleSystemWideReconnection(){this.debug("Initiating system-wide reconnection with reset backoff"),this.systemEventDetector&&clearTimeout(this.systemEventDetector),this.systemEventDetector=setTimeout(()=>{this.systemEventDetector=void 0},1e4);for(const t of this.relays.values())t.connectivity&&(t.connectivity.resetReconnectionState(),t.status!==5&&t.status!==4&&t.connect().catch(e=>{this.debug(`Failed to reconnect relay ${t.url} after system event: ${e}`)}));this.disconnectionTimes.clear()}handleFlapping(t){this.debug(`Relay ${t.url} is flapping`);let e=this.backoffTimes.get(t.url)||5e3;e=e*2,this.backoffTimes.set(t.url,e),this.debug(`Backoff time for ${t.url} is ${e}ms`),setTimeout(()=>{this.debug(`Attempting to reconnect to ${t.url}`),this.emit("relay:connecting",t),t.connect(),this.checkOnFlappingRelays()},e),t.disconnect(),this.emit("flapping",t)}size(){return this.relays.size}stats(){const t={total:0,connected:0,disconnected:0,connecting:0};for(const e of this.relays.values())t.total++,e.status===5?t.connected++:e.status===1?t.disconnected++:e.status===4&&t.connecting++;return t}connectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5)}permanentAndConnectedRelays(){return Array.from(this.relays.values()).filter(t=>t.status>=5&&!this.temporaryRelayTimers.has(t.url))}urls(){return Array.from(this.relays.keys())}},ne,NDKCashuMintList=(ne=class extends NDKEvent{constructor(e,s){super(e,s);c(this,"_p2pk");this.kind??(this.kind=10019)}static from(e){return new ne(e.ndk,e)}set relays(e){this.tags=this.tags.filter(s=>s[0]!=="relay");for(const s of e)this.tags.push(["relay",s])}get relays(){const e=[];for(const s of this.tags)s[0]==="relay"&&e.push(s[1]);return e}set mints(e){this.tags=this.tags.filter(s=>s[0]!=="mint");for(const s of e)this.tags.push(["mint",s])}get mints(){const e=[];for(const s of this.tags)s[0]==="mint"&&e.push(s[1]);return Array.from(new Set(e))}get p2pk(){return this._p2pk?this._p2pk:(this._p2pk=this.tagValue("pubkey")??this.pubkey,this._p2pk)}set p2pk(e){this._p2pk=e,this.removeTag("pubkey"),e&&this.tags.push(["pubkey",e])}get relaySet(){return NDKRelaySet.fromRelayUrls(this.relays,this.ndk)}},c(ne,"kind",10019),c(ne,"kinds",[10019]),ne),U;U=class extends NDKEvent{constructor(e,s){super(e,s);c(this,"debug");c(this,"_proofs",[]);c(this,"sender",this.author);this.kind??(this.kind=9321),this.debug=(e==null?void 0:e.debug.extend("nutzap"))??createDebug2("ndk:nutzap"),this.alt||(this.alt="This is a nutzap");try{const i=this.getMatchingTags("proof");i.length?this._proofs=i.map(r=>JSON.parse(r[1])):this._proofs=JSON.parse(this.content)}catch{return}}static from(e){const s=new U(e.ndk,e);if(!(!s._proofs||!s._proofs.length))return s}set comment(e){this.content=e??""}get comment(){const e=this.tagValue("comment");return e||this.content}set proofs(e){this._proofs=e,this.tags=this.tags.filter(s=>s[0]!=="proof");for(const s of e)this.tags.push(["proof",JSON.stringify(s)])}get proofs(){return this._proofs}get rawP2pk(){var s;const e=this.proofs[0];try{const i=JSON.parse(e.secret);let r;if(typeof i=="string"?(r=JSON.parse(i),this.debug("stringified payload",e.secret)):typeof i=="object"&&(r=i),Array.isArray(r)&&r[0]==="P2PK"&&r.length>1&&typeof r[1]=="object"&&r[1]!==null||typeof r=="object"&&r!==null&&typeof((s=r[1])==null?void 0:s.data)=="string")return r[1].data}catch(i){this.debug("error parsing p2pk pubkey",i,this.proofs[0])}}get p2pk(){const e=this.rawP2pk;if(e)return e.startsWith("02")?e.slice(2):e}get mint(){return this.tagValue("u")}set mint(e){this.replaceTag(["u",e])}get unit(){let e=this.tagValue("unit")??"sat";return e!=null&&e.startsWith("msat")&&(e="sat"),e}set unit(e){if(this.removeTag("unit"),e!=null&&e.startsWith("msat"))throw new Error("msat is not allowed, use sat denomination instead");e&&this.tag(["unit",e])}get amount(){return this.proofs.reduce((s,i)=>s+i.amount,0)}set target(e){this.tags=this.tags.filter(s=>s[0]!=="p"),e instanceof NDKEvent&&this.tags.push(e.tagReference())}set recipientPubkey(e){this.removeTag("p"),this.tag(["p",e])}get recipientPubkey(){return this.tagValue("p")}get recipient(){const e=this.recipientPubkey;return this.ndk?this.ndk.getUser({pubkey:e}):new NDKUser({pubkey:e})}async toNostrEvent(){this.unit==="msat"&&(this.unit="sat"),this.removeTag("amount"),this.tags.push(["amount",this.amount.toString()]);const e=await super.toNostrEvent();return e.content=this.comment,e}get isValid(){let e=0,s=0,i=0;for(const r of this.tags)r[0]==="e"&&e++,r[0]==="p"&&s++,r[0]==="u"&&i++;return s===1&&i===1&&e<=1&&this.proofs.length>0}},c(U,"kind",9321),c(U,"kinds",[U.kind]);var signerRegistry=new Map;function registerSigner(n,t){signerRegistry.set(n,t)}var NDKPrivateKeySigner=class Se{constructor(t,e){c(this,"_user");c(this,"_privateKey");c(this,"_pubkey");if(typeof t=="string")if(t.startsWith("nsec1")){const{type:s,data:i}=nip19_exports$2.decode(t);if(s==="nsec")this._privateKey=i;else throw new Error("Invalid private key provided.")}else if(t.length===64)this._privateKey=hexToBytes(t);else throw new Error("Invalid private key provided.");else this._privateKey=t;this._pubkey=getPublicKey(this._privateKey),e&&(this._user=e.getUser({pubkey:this._pubkey})),this._user??(this._user=new NDKUser({pubkey:this._pubkey}))}get privateKey(){if(!this._privateKey)throw new Error("Not ready");return bytesToHex(this._privateKey)}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}get nsec(){if(!this._privateKey)throw new Error("Not ready");return nip19_exports$2.nsecEncode(this._privateKey)}get npub(){if(!this._pubkey)throw new Error("Not ready");return nip19_exports$2.npubEncode(this._pubkey)}static generate(){const t=generateSecretKey();return new Se(t)}async blockUntilReady(){return this._user}async user(){return this._user}get userSync(){return this._user}async sign(t){if(!this._privateKey)throw Error("Attempted to sign without a private key");return finalizeEvent(t,this._privateKey).sig}async encryptionEnabled(t){const e=[];return(!t||t==="nip04")&&e.push("nip04"),(!t||t==="nip44")&&e.push("nip44"),e}async encrypt(t,e,s){if(!this._privateKey||!this.privateKey)throw Error("Attempted to encrypt without a private key");const i=t.pubkey;if(s==="nip44"){const r=nip44_exports.v2.utils.getConversationKey(this._privateKey,i);return await nip44_exports.v2.encrypt(e,r)}return await nip04_exports.encrypt(this._privateKey,i,e)}async decrypt(t,e,s){if(!this._privateKey||!this.privateKey)throw Error("Attempted to decrypt without a private key");const i=t.pubkey;if(s==="nip44"){const r=nip44_exports.v2.utils.getConversationKey(this._privateKey,i);return await nip44_exports.v2.decrypt(e,r)}return await nip04_exports.decrypt(this._privateKey,i,e)}toPayload(){if(!this._privateKey)throw new Error("Private key not available");const t={type:"private-key",payload:this.privateKey};return JSON.stringify(t)}static async fromPayload(t,e){const s=JSON.parse(t);if(s.type!=="private-key")throw new Error(`Invalid payload type: expected 'private-key', got ${s.type}`);if(!s.payload||typeof s.payload!="string")throw new Error("Invalid payload content for private-key signer");return new Se(s.payload,e)}};registerSigner("private-key",NDKPrivateKeySigner);async function follows(n,t,e=3){var i,r;if(!this.ndk)throw new Error("NDK not set");const s=await this.ndk.fetchEvent({kinds:[e],authors:[this.pubkey]},n||{groupable:!1});if(s){const a=new Set;return s.tags.forEach(o=>{o[0]==="p"&&a.add(o[1])}),t&&((r=(i=this.ndk)==null?void 0:i.outboxTracker)==null||r.trackUsers(Array.from(a))),[...a].reduce((o,l)=>{const h=new NDKUser({pubkey:l});return h.ndk=this.ndk,o.add(h),o},new Set)}return new Set}var NIP05_REGEX=/^(?:([\w.+-]+)@)?([\w.-]+)$/;async function getNip05For(n,t,e=fetch,s={}){return await n.queuesNip05.add({id:t,func:async()=>{var l,h,u;if((l=n.cacheAdapter)!=null&&l.loadNip05){const f=await n.cacheAdapter.loadNip05(t);if(f!=="missing"){if(f){const p=new NDKUser({pubkey:f.pubkey,relayUrls:f.relays,nip46Urls:f.nip46});return p.ndk=n,p}if(s.cache!=="no-cache")return null}}const i=t.match(NIP05_REGEX);if(!i)return null;const[r,a="_",o]=i;try{const f=await e(`https://${o}/.well-known/nostr.json?name=${a}`,s),{names:p,relays:g,nip46:m}=parseNIP05Result(await f.json()),w=p[a.toLowerCase()];let b=null;return w&&(b={pubkey:w,relays:g==null?void 0:g[w],nip46:m==null?void 0:m[w]}),(h=n==null?void 0:n.cacheAdapter)!=null&&h.saveNip05&&n.cacheAdapter.saveNip05(t,b),b}catch(f){return(u=n==null?void 0:n.cacheAdapter)!=null&&u.saveNip05&&(n==null||n.cacheAdapter.saveNip05(t,null)),console.error("Failed to fetch NIP05 for",t,f),null}}})}function parseNIP05Result(n){const t={names:{}};for(const[e,s]of Object.entries(n.names))typeof e=="string"&&typeof s=="string"&&(t.names[e.toLowerCase()]=s);if(n.relays){t.relays={};for(const[e,s]of Object.entries(n.relays))typeof e=="string"&&Array.isArray(s)&&(t.relays[e]=s.filter(i=>typeof i=="string"))}if(n.nip46){t.nip46={};for(const[e,s]of Object.entries(n.nip46))typeof e=="string"&&Array.isArray(s)&&(t.nip46[e]=s.filter(i=>typeof i=="string"))}return t}function profileFromEvent(n){const t={};let e;try{e=JSON.parse(n.content)}catch(s){throw new Error(`Failed to parse profile event: ${s}`)}t.profileEvent=JSON.stringify(n.rawEvent());for(const s of Object.keys(e))switch(s){case"name":t.name=e.name;break;case"display_name":t.displayName=e.display_name;break;case"image":case"picture":t.picture=e.picture||e.image,t.image=t.picture;break;case"banner":t.banner=e.banner;break;case"bio":t.bio=e.bio;break;case"nip05":t.nip05=e.nip05;break;case"lud06":t.lud06=e.lud06;break;case"lud16":t.lud16=e.lud16;break;case"about":t.about=e.about;break;case"website":t.website=e.website;break;default:t[s]=e[s];break}return t.created_at=n.created_at,t}function serializeProfile(n){const t={};for(const[e,s]of Object.entries(n))switch(e){case"username":case"name":t.name=s;break;case"displayName":t.display_name=s;break;case"image":case"picture":t.picture=s;break;case"bio":case"about":t.about=s;break;default:t[e]=s;break}return JSON.stringify(t)}var NDKUser=class Ke{constructor(t){c(this,"ndk");c(this,"profile");c(this,"profileEvent");c(this,"_npub");c(this,"_pubkey");c(this,"relayUrls",[]);c(this,"nip46Urls",[]);c(this,"follows",follows.bind(this));if(t.npub&&(this._npub=t.npub),t.hexpubkey&&(this._pubkey=t.hexpubkey),t.pubkey&&(this._pubkey=t.pubkey),t.relayUrls&&(this.relayUrls=t.relayUrls),t.nip46Urls&&(this.nip46Urls=t.nip46Urls),t.nprofile)try{const e=nip19_exports$2.decode(t.nprofile);e.type==="nprofile"&&(this._pubkey=e.data.pubkey,e.data.relays&&e.data.relays.length>0&&this.relayUrls.push(...e.data.relays))}catch(e){console.error("Failed to decode nprofile",e)}}get npub(){if(!this._npub){if(!this._pubkey)throw new Error("pubkey not set");this._npub=nip19_exports$2.npubEncode(this.pubkey)}return this._npub}get nprofile(){var e,s;const t=(s=(e=this.profileEvent)==null?void 0:e.onRelays)==null?void 0:s.map(i=>i.url);return nip19_exports$2.nprofileEncode({pubkey:this.pubkey,relays:t})}set npub(t){this._npub=t}get pubkey(){if(!this._pubkey){if(!this._npub)throw new Error("npub not set");this._pubkey=nip19_exports$2.decode(this.npub).data}return this._pubkey}set pubkey(t){this._pubkey=t}filter(){return{"#p":[this.pubkey]}}async getZapInfo(t){if(!this.ndk)throw new Error("No NDK instance found");const e=async a=>{if(!t)return a;let o;const l=new Promise((h,u)=>{o=setTimeout(()=>u(new Error("Timeout")),t)});try{const h=await Promise.race([a,l]);return o&&clearTimeout(o),h}catch(h){if(h instanceof Error&&h.message==="Timeout")try{return await a}catch{return}return}},[s,i]=await Promise.all([e(this.fetchProfile()),e(this.ndk.fetchEvent({kinds:[10019],authors:[this.pubkey]}))]),r=new Map;if(i){const a=NDKCashuMintList.from(i);a.mints.length>0&&r.set("nip61",{mints:a.mints,relays:a.relays,p2pk:a.p2pk})}if(s){const{lud06:a,lud16:o}=s;r.set("nip57",{lud06:a,lud16:o})}return r}static async fromNip05(t,e,s=!1){if(!e)throw new Error("No NDK instance found");const i={};s&&(i.cache="no-cache");const r=await getNip05For(e,t,e==null?void 0:e.httpFetch,i);if(r){const a=new Ke({pubkey:r.pubkey,relayUrls:r.relays,nip46Urls:r.nip46});return a.ndk=e,a}}async fetchProfile(t,e=!1){if(!this.ndk)throw new Error("NDK not set");let s=null;if(this.ndk.cacheAdapter&&(this.ndk.cacheAdapter.fetchProfile||this.ndk.cacheAdapter.fetchProfileSync)&&(t==null?void 0:t.cacheUsage)!=="ONLY_RELAY"){let i=null;if(this.ndk.cacheAdapter.fetchProfileSync?i=this.ndk.cacheAdapter.fetchProfileSync(this.pubkey):this.ndk.cacheAdapter.fetchProfile&&(i=await this.ndk.cacheAdapter.fetchProfile(this.pubkey)),i)return this.profile=i,i}return t??(t={}),t.cacheUsage??(t.cacheUsage="ONLY_RELAY"),t.closeOnEose??(t.closeOnEose=!0),t.groupable??(t.groupable=!0),t.groupableDelay??(t.groupableDelay=250),s||(s=await this.ndk.fetchEvent({kinds:[0],authors:[this.pubkey]},t)),s?(this.profile=profileFromEvent(s),e&&this.profile&&this.ndk.cacheAdapter&&this.ndk.cacheAdapter.saveProfile&&this.ndk.cacheAdapter.saveProfile(this.pubkey,this.profile),this.profile):null}async followSet(t,e,s=3){const i=await this.follows(t,e,s);return new Set(Array.from(i).map(r=>r.pubkey))}tagReference(){return["p",this.pubkey]}referenceTags(t){const e=[["p",this.pubkey]];return t&&e[0].push("",t),e}async publish(){if(!this.ndk)throw new Error("No NDK instance found");if(!this.profile)throw new Error("No profile available");this.ndk.assertSigner(),await new NDKEvent(this.ndk,{kind:0,content:serializeProfile(this.profile)}).publish()}async follow(t,e,s=3){if(!this.ndk)throw new Error("No NDK instance found");if(this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,s)),e.has(t))return!1;e.add(t);const i=new NDKEvent(this.ndk,{kind:s});for(const r of e)i.tag(r);return await i.publish(),!0}async unfollow(t,e,s=3){if(!this.ndk)throw new Error("No NDK instance found");this.ndk.assertSigner(),e||(e=await this.follows(void 0,void 0,s));const i=new Set;let r=!1;for(const o of e)o.pubkey!==t.pubkey?i.add(o):r=!0;if(!r)return!1;const a=new NDKEvent(this.ndk,{kind:s});for(const o of i)a.tag(o);return await a.publish()}async validateNip05(t){if(!this.ndk)throw new Error("No NDK instance found");const e=await getNip05For(this.ndk,t);return e===null?null:e.pubkey===this.pubkey}};function disconnect(n,t){return t??(t=createDebug2("ndk:relay:auth-policies:disconnect")),async e=>{t==null||t(`Relay ${e.url} requested authentication, disconnecting`),n.removeRelay(e.url)}}async function signAndAuth(n,t,e,s,i,r){try{await n.sign(e),i(n)}catch(a){s==null||s(`Failed to publish auth event to relay ${t.url}`,a),r(n)}}function signIn({ndk:n,signer:t,debug:e}={}){return e??(e=createDebug2("ndk:auth-policies:signIn")),async(s,i)=>{e==null||e(`Relay ${s.url} requested authentication, signing in`);const r=new NDKEvent(n);return r.kind=22242,r.tags=[["relay",s.url],["challenge",i]],t??(t=n==null?void 0:n.signer),new Promise(async(a,o)=>{t?await signAndAuth(r,s,t,e,a,o):n==null||n.once("signer:ready",async l=>{await signAndAuth(r,s,l,e,a,o)})})}}var NDKRelayAuthPolicies={disconnect,signIn},NDKNip07Signer=class Ue{constructor(t=1e3,e){c(this,"_userPromise");c(this,"encryptionQueue",[]);c(this,"encryptionProcessing",!1);c(this,"debug");c(this,"waitTimeout");c(this,"_pubkey");c(this,"ndk");c(this,"_user");this.debug=createDebug2("ndk:nip07"),this.waitTimeout=t,this.ndk=e}get pubkey(){if(!this._pubkey)throw new Error("Not ready");return this._pubkey}async blockUntilReady(){var s;await this.waitForExtension();const t=await((s=window.nostr)==null?void 0:s.getPublicKey());if(!t)throw new Error("User rejected access");this._pubkey=t;let e;return this.ndk?e=this.ndk.getUser({pubkey:t}):e=new NDKUser({pubkey:t}),this._user=e,e}async user(){return this._userPromise||(this._userPromise=this.blockUntilReady()),this._userPromise}get userSync(){if(!this._user)throw new Error("User not ready");return this._user}async sign(t){var s;await this.waitForExtension();const e=await((s=window.nostr)==null?void 0:s.signEvent(t));if(!e)throw new Error("Failed to sign event");return e.sig}async relays(t){var i,r;await this.waitForExtension();const e=await((r=(i=window.nostr)==null?void 0:i.getRelays)==null?void 0:r.call(i))||{},s=[];for(const a of Object.keys(e))e[a].read&&e[a].write&&s.push(a);return s.map(a=>new NDKRelay(a,t==null?void 0:t.relayAuthDefaultPolicy,t))}async encryptionEnabled(t){var s,i;const e=[];return(!t||t==="nip04")&&((s=window.nostr)!=null&&s.nip04)&&e.push("nip04"),(!t||t==="nip44")&&((i=window.nostr)!=null&&i.nip44)&&e.push("nip44"),e}async encrypt(t,e,s="nip04"){if(!await this.encryptionEnabled(s))throw new Error(`${s}encryption is not available from your browser extension`);await this.waitForExtension();const i=t.pubkey;return this.queueEncryption(s,"encrypt",i,e)}async decrypt(t,e,s="nip04"){if(!await this.encryptionEnabled(s))throw new Error(`${s}encryption is not available from your browser extension`);await this.waitForExtension();const i=t.pubkey;return this.queueEncryption(s,"decrypt",i,e)}async queueEncryption(t,e,s,i){return new Promise((r,a)=>{this.encryptionQueue.push({scheme:t,method:e,counterpartyHexpubkey:s,value:i,resolve:r,reject:a}),this.encryptionProcessing||this.processEncryptionQueue()})}async processEncryptionQueue(t,e=0){var u,f;if(!t&&this.encryptionQueue.length===0){this.encryptionProcessing=!1;return}this.encryptionProcessing=!0;const s=t||this.encryptionQueue.shift();if(!s){this.encryptionProcessing=!1;return}const{scheme:i,method:r,counterpartyHexpubkey:a,value:o,resolve:l,reject:h}=s;this.debug("Processing encryption queue item",{method:r,counterpartyHexpubkey:a,value:o});try{const p=await((f=(u=window.nostr)==null?void 0:u[i])==null?void 0:f[r](a,o));if(!p)throw new Error("Failed to encrypt/decrypt");l(p)}catch(p){const g=p instanceof Error?p.message:String(p);if(g.includes("call already executing")&&e<5){this.debug("Retrying encryption queue item",{method:r,counterpartyHexpubkey:a,value:o,retries:e}),setTimeout(()=>{this.processEncryptionQueue(s,e+1)},50*e);return}h(p instanceof Error?p:new Error(g))}this.processEncryptionQueue()}waitForExtension(){return new Promise((t,e)=>{if(window.nostr){t();return}let s;const i=setInterval(()=>{window.nostr&&(clearTimeout(s),clearInterval(i),t())},100);s=setTimeout(()=>{clearInterval(i),e(new Error("NIP-07 extension not available"))},this.waitTimeout)})}toPayload(){return JSON.stringify({type:"nip07",payload:""})}static async fromPayload(t,e){const s=JSON.parse(t);if(s.type!=="nip07")throw new Error(`Invalid payload type: expected 'nip07', got ${s.type}`);return new Ue(void 0,e)}};registerSigner("nip07",NDKNip07Signer);var NDKNostrRpc=class extends libExports.EventEmitter{constructor(t,e,s,i){super();c(this,"ndk");c(this,"signer");c(this,"relaySet");c(this,"debug");c(this,"encryptionType","nip04");c(this,"pool");if(this.ndk=t,this.signer=e,i){this.pool=new NDKPool(i,[],t,{debug:s.extend("rpc-pool"),name:"Nostr RPC"}),this.relaySet=new NDKRelaySet(new Set,t,this.pool);for(const r of i){const a=this.pool.getRelay(r,!1,!1);a.authPolicy=NDKRelayAuthPolicies.signIn({ndk:t,signer:e,debug:s}),this.relaySet.addRelay(a),a.connect()}}this.debug=s.extend("rpc")}subscribe(t){const e=this.ndk.subscribe(t,{closeOnEose:!1,groupable:!1,cacheUsage:"ONLY_RELAY",pool:this.pool,relaySet:this.relaySet},!1);return e.on("event",async s=>{try{const i=await this.parseEvent(s);i.method?this.emit("request",i):(this.emit(`response-${i.id}`,i),this.emit("response",i))}catch(i){this.debug("error parsing event",i,s.rawEvent())}}),new Promise(s=>{e.on("eose",()=>{this.debug("eosed"),s(e)}),e.start()})}async parseEvent(t){this.encryptionType==="nip44"&&t.content.includes("?iv=")?this.encryptionType="nip04":this.encryptionType==="nip04"&&!t.content.includes("?iv=")&&(this.encryptionType="nip44");const e=this.ndk.getUser({pubkey:t.pubkey});e.ndk=this.ndk;let s;try{s=await this.signer.decrypt(e,t.content,this.encryptionType)}catch{const f=this.encryptionType==="nip04"?"nip44":"nip04";s=await this.signer.decrypt(e,t.content,f),this.encryptionType=f}const i=JSON.parse(s),{id:r,method:a,params:o,result:l,error:h}=i;return a?{id:r,pubkey:t.pubkey,method:a,params:o,event:t}:{id:r,result:l,error:h,event:t}}async sendResponse(t,e,s,i=24133,r){const a={id:t,result:s};r&&(a.error=r);const o=await this.signer.user(),l=this.ndk.getUser({pubkey:e}),h=new NDKEvent(this.ndk,{kind:i,content:JSON.stringify(a),tags:[["p",e]],pubkey:o.pubkey});h.content=await this.signer.encrypt(l,h.content,this.encryptionType),await h.sign(this.signer),await h.publish(this.relaySet)}async sendRequest(t,e,s=[],i=24133,r){const a=Math.random().toString(36).substring(7),o=await this.signer.user(),l=this.ndk.getUser({pubkey:t}),h={id:a,method:e,params:s},u=new Promise(()=>{const p=g=>{g.result==="auth_url"?(this.once(`response-${a}`,p),this.emit("authUrl",g.error)):r&&r(g)};this.once(`response-${a}`,p)}),f=new NDKEvent(this.ndk,{kind:i,content:JSON.stringify(h),tags:[["p",t]],pubkey:o.pubkey});return f.content=await this.signer.encrypt(l,f.content,this.encryptionType),await f.sign(this.signer),await f.publish(this.relaySet),u}};async function ndkSignerFromPayload(n,t){let e;try{e=JSON.parse(n)}catch(i){console.error("Failed to parse signer payload string",n,i);return}if(!e||typeof e.type!="string"){console.error("Failed to parse signer payload string",n,new Error("Missing type field"));return}const s=signerRegistry.get(e.type);if(!s)throw new Error(`Unknown signer type: ${e.type}`);try{return await s.fromPayload(n,t)}catch(i){const r=i instanceof Error?i.message:String(i);throw new Error(`Failed to deserialize signer type ${e.type}: ${r}`)}}function nostrConnectGenerateSecret(){return Math.random().toString(36).substring(2,15)}function generateNostrConnectUri(n,t,e,s){const i={name:s!=null&&s.name?encodeURIComponent(s.name):"",url:s!=null&&s.url?encodeURIComponent(s.url):"",image:s!=null&&s.image?encodeURIComponent(s.image):"",perms:s!=null&&s.perms?encodeURIComponent(s.perms):""};let r=`nostrconnect://${n}?image=${i.image}&url=${i.url}&name=${i.name}&perms=${i.perms}&secret=${encodeURIComponent(t)}`;return e&&(r+=`&relay=${encodeURIComponent(e)}`),r}var NDKNip46Signer=class Te extends libExports.EventEmitter{constructor(e,s,i,r,a){super();c(this,"ndk");c(this,"_user");c(this,"bunkerPubkey");c(this,"userPubkey");c(this,"secret");c(this,"localSigner");c(this,"nip05");c(this,"rpc");c(this,"debug");c(this,"relayUrls");c(this,"subscription");c(this,"nostrConnectUri");c(this,"nostrConnectSecret");this.ndk=e,this.debug=e.debug.extend("nip46:signer"),this.relayUrls=r,i?typeof i=="string"?this.localSigner=new NDKPrivateKeySigner(i):this.localSigner=i:this.localSigner=NDKPrivateKeySigner.generate(),s===!1||(s?s.startsWith("bunker://")?this.bunkerFlowInit(s):this.nip05Init(s):this.nostrconnectFlowInit(a)),this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls)}get pubkey(){if(!this.userPubkey)throw new Error("Not ready");return this.userPubkey}static bunker(e,s,i){return new Te(e,s,i)}static nostrconnect(e,s,i,r){return new Te(e,void 0,i,[s],r)}nostrconnectFlowInit(e){var i;this.nostrConnectSecret=nostrConnectGenerateSecret();const s=this.localSigner.pubkey;this.nostrConnectUri=generateNostrConnectUri(s,this.nostrConnectSecret,(i=this.relayUrls)==null?void 0:i[0],e)}bunkerFlowInit(e){const s=new URL(e),i=s.hostname||s.pathname.replace(/^\/\//,""),r=s.searchParams.get("pubkey"),a=s.searchParams.getAll("relay"),o=s.searchParams.get("secret");this.bunkerPubkey=i,this.userPubkey=r,this.relayUrls=a,this.secret=o}nip05Init(e){this.nip05=e}async startListening(){if(this.subscription)return;const e=await this.localSigner.user();if(!e)throw new Error("Local signer not ready");this.subscription=await this.rpc.subscribe({kinds:[24133],"#p":[e.pubkey]})}async user(){return this._user?this._user:this.blockUntilReady()}get userSync(){if(!this._user)throw new Error("Remote user not ready synchronously");return this._user}async blockUntilReadyNostrConnect(){return new Promise((e,s)=>{const i=r=>{r.result===this.nostrConnectSecret&&(this._user=r.event.author,this.userPubkey=r.event.pubkey,this.bunkerPubkey=r.event.pubkey,this.rpc.off("response",i),e(this._user))};this.startListening(),this.rpc.on("response",i)})}async blockUntilReady(){if(!this.bunkerPubkey&&!this.nostrConnectSecret&&!this.nip05)throw new Error("Bunker pubkey not set");if(this.nostrConnectSecret)return this.blockUntilReadyNostrConnect();if(this.nip05&&!this.userPubkey){const e=await NDKUser.fromNip05(this.nip05,this.ndk);e&&(this._user=e,this.userPubkey=e.pubkey,this.relayUrls=e.nip46Urls,this.rpc=new NDKNostrRpc(this.ndk,this.localSigner,this.debug,this.relayUrls))}if(!this.bunkerPubkey&&this.userPubkey)this.bunkerPubkey=this.userPubkey;else if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");return await this.startListening(),this.rpc.on("authUrl",(...e)=>{this.emit("authUrl",...e)}),new Promise((e,s)=>{const i=[this.userPubkey??""];if(this.secret&&i.push(this.secret),!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"connect",i,24133,r=>{r.result==="ack"?this.getPublicKey().then(a=>{this.userPubkey=a,this._user=this.ndk.getUser({pubkey:a}),e(this._user)}):s(r.error)})})}stop(){var e;(e=this.subscription)==null||e.stop(),this.subscription=void 0}async getPublicKey(){return this.userPubkey?this.userPubkey:new Promise((e,s)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"get_public_key",[],24133,i=>{e(i.result)})})}async encryptionEnabled(e){return e?[e]:Promise.resolve(["nip04","nip44"])}async encrypt(e,s,i="nip04"){return this.encryption(e,s,i,"encrypt")}async decrypt(e,s,i="nip04"){return this.encryption(e,s,i,"decrypt")}async encryption(e,s,i,r){return new Promise((o,l)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,`${i}_${r}`,[e.pubkey,s],24133,h=>{h.error?l(h.error):o(h.result)})})}async sign(e){return new Promise((i,r)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"sign_event",[JSON.stringify(e)],24133,a=>{if(a.error)r(a.error);else{const o=JSON.parse(a.result);i(o.sig)}})})}async createAccount(e,s,i){await this.startListening();const r=[];return e&&r.push(e),s&&r.push(s),i&&r.push(i),new Promise((a,o)=>{if(!this.bunkerPubkey)throw new Error("Bunker pubkey not set");this.rpc.sendRequest(this.bunkerPubkey,"create_account",r,24133,l=>{if(l.error)o(l.error);else{const h=l.result;a(h)}})})}toPayload(){if(!this.bunkerPubkey||!this.userPubkey)throw new Error("NIP-46 signer is not fully initialized for serialization");const e={type:"nip46",payload:{bunkerPubkey:this.bunkerPubkey,userPubkey:this.userPubkey,relayUrls:this.relayUrls,secret:this.secret,localSignerPayload:this.localSigner.toPayload(),nip05:this.nip05||null}};return JSON.stringify(e)}static async fromPayload(e,s){if(!s)throw new Error("NDK instance is required to deserialize NIP-46 signer");const i=JSON.parse(e);if(i.type!=="nip46")throw new Error(`Invalid payload type: expected 'nip46', got ${i.type}`);const r=i.payload;if(!r||typeof r!="object"||!r.localSignerPayload)throw new Error("Invalid payload content for nip46 signer");const a=await ndkSignerFromPayload(r.localSignerPayload,s);if(!a)throw new Error("Failed to deserialize local signer for NIP-46");if(!(a instanceof NDKPrivateKeySigner))throw new Error("Local signer must be an instance of NDKPrivateKeySigner");let o;return o=new Te(s,!1,a,r.relayUrls),o.userPubkey=r.userPubkey,o.bunkerPubkey=r.bunkerPubkey,o.relayUrls=r.relayUrls,o.secret=r.secret,r.userPubkey&&(o._user=new NDKUser({pubkey:r.userPubkey}),o._user&&(o._user.ndk=s)),o}};registerSigner("nip46",NDKNip46Signer);createDebug2("ndk:active-user");createDebug2("ndk:zapper:ln");createDebug2("ndk:zapper");var nip19_exports={};__reExport(nip19_exports,nip19_star);async function eventTagsWarmUp(n,t){const e=await t.limit(n.maxSize).toArray();for(const s of e)n.add(s.tagValue,s.eventId,!1)}var eventTagsDump=(n,t)=>async(e,s)=>{const i=[];for(const r of e){const a=s.get(r);if(a)for(const o of a)i.push({tagValue:r,eventId:o})}i.length>0&&(t(`Saving ${i.length} events cache entries to database`),await n.bulkPut(i)),e.clear()};async function eventsWarmUp(n,t){const e=await t.limit(n.maxSize).toArray();for(const s of e)n.set(s.id,s,!1)}var eventsDump=(n,t)=>async(e,s)=>{const i=[];for(const r of e){const a=s.get(r);a&&i.push(a)}i.length>0&&(t(`Saving ${i.length} events cache entries to database`),await n.bulkPut(i)),e.clear()};async function nip05WarmUp(n,t){const e=await t.limit(n.maxSize).toArray();for(const s of e)n.set(s.nip05,s,!1)}var nip05Dump=(n,t)=>async(e,s)=>{const i=[];for(const r of e){const a=s.get(r);a&&i.push({nip05:r,...a})}i.length&&(t(`Saving ${i.length} NIP-05 cache entries to database`),await n.bulkPut(i)),e.clear()},Database=class extends Dexie{constructor(t){super(t);c(this,"profiles");c(this,"events");c(this,"eventTags");c(this,"nip05");c(this,"lnurl");c(this,"relayStatus");c(this,"unpublishedEvents");this.version(15).stores({profiles:"&pubkey",events:"&id, kind",eventTags:"&tagValue",nip05:"&nip05",lnurl:"&pubkey",relayStatus:"&url",unpublishedEvents:"&id"})}},db;function createDatabase(n){db=new Database(n)}var d=createDebug2("ndk:dexie-adapter:profiles");async function profilesWarmUp(n,t){const e=await t.limit(n.maxSize).toArray();for(const s of e){const i=s;n.set(s.pubkey,i,!1)}d("Loaded %d profiles from database",n.size())}var profilesDump=(n,t)=>async(e,s)=>{const i=[];for(const r of e){const a=s.get(r);a&&i.push(a)}i.length&&(t(`Saving ${i.length} users to database`),await n.bulkPut(i)),e.clear()};async function relayInfoWarmUp(n,t){const e=await t.limit(n.maxSize).toArray();for(const s of e)n.set(s.url,{url:s.url,updatedAt:s.updatedAt,lastConnectedAt:s.lastConnectedAt,dontConnectBefore:s.dontConnectBefore},!1)}var relayInfoDump=(n,t)=>async(e,s)=>{const i=[];for(const r of e){const a=s.get(r);a&&i.push({url:r,updatedAt:a.updatedAt,lastConnectedAt:a.lastConnectedAt,dontConnectBefore:a.dontConnectBefore})}i.length>0&&(t(`Saving ${i.length} relay status cache entries to database`),await n.bulkPut(i)),e.clear()},WRITE_STATUS_THRESHOLD=3;async function unpublishedEventsWarmUp(n,t){await t.each(e=>{n.set(e.event.id,e,!1)})}function unpublishedEventsDump(n,t){return async(e,s)=>{const i=[];for(const r of e){const a=s.get(r);a&&i.push(a)}i.length>0&&(t(`Saving ${i.length} unpublished events cache entries to database`),await n.bulkPut(i)),e.clear()}}async function discardUnpublishedEvent(n,t){await n.delete(t)}async function getUnpublishedEvents(n){const t=[];return await n.each(e=>{t.push({event:new NDKEvent(void 0,e.event),relays:Object.keys(e.relays),lastTryAt:e.lastTryAt})}),t}function addUnpublishedEvent(n,t){const e={};t.forEach(i=>e[i]=!1),this.unpublishedEvents.set(n.id,{id:n.id,event:n.rawEvent(),relays:e});const s=i=>{const r=i.url,a=this.unpublishedEvents.get(n.id);if(!a){n.off("publushed",s);return}a.relays[r]=!0,this.unpublishedEvents.set(n.id,a);const o=Object.values(a.relays).filter(h=>h).length,l=Object.values(a.relays).length-o;(o>=WRITE_STATUS_THRESHOLD||l===0)&&(this.unpublishedEvents.delete(n.id),n.off("published",s))};n.on("published",s)}async function zapperWarmUp(n,t){const e=await t.limit(n.maxSize).toArray();for(const s of e)n.set(s.pubkey,{document:s.document,fetchedAt:s.fetchedAt},!1)}var zapperDump=(n,t)=>async(e,s)=>{const i=[];for(const r of e){const a=s.get(r);a&&i.push({pubkey:r,...a})}i.length&&(t(`Saving ${i.length} zapper cache entries to database`),await n.bulkPut(i)),e.clear()},CacheHandler=class{constructor(n){c(this,"cache");c(this,"dirtyKeys",new Set);c(this,"options");c(this,"debug");c(this,"indexes");c(this,"isSet",!1);c(this,"maxSize",0);this.debug=n.debug,this.options=n,this.maxSize=n.maxSize,n.maxSize>0&&(this.cache=new distExports.LRUCache({maxSize:n.maxSize}),setInterval(()=>this.dump().catch(console.error),1e3*10)),this.indexes=new Map}getSet(n){var t;return(t=this.cache)==null?void 0:t.get(n)}getAllWithFilter(n){var e;const t=new Map;return(e=this.cache)==null||e.forEach((s,i)=>{n(i,s)&&t.set(i,s)}),t}get(n){var t;return(t=this.cache)==null?void 0:t.get(n)}async getWithFallback(n,t){let e=this.get(n);return e||(e=await t.get(n),e&&this.set(n,e)),e}async getManyWithFallback(n,t){const e=[],s=[];for(const i of n){const r=this.get(i);r?e.push(r):s.push(i)}if(e.length>0&&this.debug(`Cache hit for keys ${e.length} and miss for ${s.length} keys`),s.length>0){const i=Date.now(),r=await t.bulkGet(s),a=Date.now();let o=0;for(const l of r)l&&(this.set(l.id,l),e.push(l),o++);this.debug(`Time spent querying database: ${a-i}ms for ${s.length} keys, which added ${o} entries to the cache`)}return e}add(n,t,e=!0){var i;const s=this.get(n)??new Set;s.add(t),(i=this.cache)==null||i.set(n,s),e&&this.dirtyKeys.add(n)}set(n,t,e=!0){var s;(s=this.cache)==null||s.set(n,t),e&&this.dirtyKeys.add(n);for(const[i,r]of this.indexes.entries()){const a=t[i];if(a){const o=r.get(a)||new Set;o.add(n),r.set(a,o)}}}size(){var n;return((n=this.cache)==null?void 0:n.size)||0}delete(n){var t;(t=this.cache)==null||t.delete(n),this.dirtyKeys.add(n)}async dump(){this.dirtyKeys.size>0&&this.cache&&(await this.options.dump(this.dirtyKeys,this.cache),this.dirtyKeys.clear())}addIndex(n){this.indexes.set(n,new distExports.LRUCache({maxSize:this.options.maxSize}))}getFromIndex(n,t){const e=new Set,s=this.indexes.get(n);if(s){const i=s.get(t);if(i)for(const r of i.values()){const a=this.get(r);a&&e.add(a)}}return e}},INDEXABLE_TAGS_LIMIT=10,NDKCacheAdapterDexie=class{constructor(n={}){c(this,"debug");c(this,"locking",!1);c(this,"ready",!1);c(this,"profiles");c(this,"zappers");c(this,"nip05s");c(this,"events");c(this,"eventTags");c(this,"relayInfo");c(this,"unpublishedEvents");c(this,"warmedUp",!1);c(this,"warmUpPromise");c(this,"devMode",!1);c(this,"saveSig");c(this,"_onReady");c(this,"addUnpublishedEvent",addUnpublishedEvent.bind(this));c(this,"getUnpublishedEvents",()=>getUnpublishedEvents(db.unpublishedEvents));c(this,"discardUnpublishedEvent",n=>discardUnpublishedEvent(db.unpublishedEvents,n));createDatabase(n.dbName||"ndk"),this.debug=n.debug||createDebug2("ndk:dexie-adapter"),this.saveSig=n.saveSig||!1,this.profiles=new CacheHandler({maxSize:n.profileCacheSize||1e5,dump:profilesDump(db.profiles,this.debug),debug:this.debug}),this.zappers=new CacheHandler({maxSize:n.zapperCacheSize||200,dump:zapperDump(db.lnurl,this.debug),debug:this.debug}),this.nip05s=new CacheHandler({maxSize:n.nip05CacheSize||1e3,dump:nip05Dump(db.nip05,this.debug),debug:this.debug}),this.events=new CacheHandler({maxSize:n.eventCacheSize||5e4,dump:eventsDump(db.events,this.debug),debug:this.debug}),this.events.addIndex("pubkey"),this.events.addIndex("kind"),this.eventTags=new CacheHandler({maxSize:n.eventTagsCacheSize||1e5,dump:eventTagsDump(db.eventTags,this.debug),debug:this.debug}),this.relayInfo=new CacheHandler({maxSize:500,debug:this.debug,dump:relayInfoDump(db.relayStatus,this.debug)}),this.unpublishedEvents=new CacheHandler({maxSize:5e3,debug:this.debug,dump:unpublishedEventsDump(db.unpublishedEvents,this.debug)});const t=(s,i)=>{const r=Date.now();return i().then(()=>{const a=Date.now();this.debug(s,"took",a-r,"ms")})},e=Date.now();this.warmUpPromise=Promise.allSettled([t("profilesWarmUp",()=>profilesWarmUp(this.profiles,db.profiles)),t("zapperWarmUp",()=>zapperWarmUp(this.zappers,db.lnurl)),t("nip05WarmUp",()=>nip05WarmUp(this.nip05s,db.nip05)),t("relayInfoWarmUp",()=>relayInfoWarmUp(this.relayInfo,db.relayStatus)),t("unpublishedEventsWarmUp",()=>unpublishedEventsWarmUp(this.unpublishedEvents,db.unpublishedEvents)),t("eventsWarmUp",()=>eventsWarmUp(this.events,db.events)),t("eventTagsWarmUp",()=>eventTagsWarmUp(this.eventTags,db.eventTags))]),this.warmUpPromise.then(()=>{const s=Date.now();this.warmedUp=!0,this.ready=!0,this.locking=!0,this.debug("Warm up completed, time",s-e,"ms"),this._onReady&&this._onReady()})}onReady(n){this._onReady=n}async query(n){if(!this.warmedUp){const s=Date.now();await this.warmUpPromise,this.debug("froze query for",Date.now()-s,"ms",n.filters)}const t=Date.now();n.filters.map(s=>this.processFilter(s,n));const e=Date.now()-t;return e>100&&this.debug("query took",e,"ms",n.filter),[]}async fetchProfile(n){return this.profiles?await this.profiles.getWithFallback(n,db.profiles):null}fetchProfileSync(n){return this.profiles?this.profiles.get(n):null}async getProfiles(n){if(this.profiles)return this.profiles.getAllWithFilter(n)}saveProfile(n,t){const e=this.profiles.get(n);if(e!=null&&e.created_at&&t.created_at&&e.created_at>=t.created_at)return;const s=Math.floor(Date.now()/1e3);this.profiles.set(n,{pubkey:n,...t,cachedAt:s}),this.debug("Saved profile for pubkey",n,t)}async loadNip05(n,t=3600){var r;const e=(r=this.nip05s)==null?void 0:r.get(n);if(e){if(e.profile===null)return e.fetchedAt+t*1e3<Date.now()?"missing":null;try{return JSON.parse(e.profile)}catch{return"missing"}}const s=await db.nip05.get({nip05:n});if(!s)return"missing";const i=Date.now();if(s.profile===null)return s.fetchedAt+t*1e3<i?"missing":null;try{return JSON.parse(s.profile)}catch{return"missing"}}async saveNip05(n,t){try{const e=t?JSON.stringify(t):null;this.nip05s.set(n,{profile:e,fetchedAt:Date.now()})}catch(e){console.error("Failed to save NIP-05 profile for nip05:",n,e)}}async loadUsersLNURLDoc(n,t=86400,e=3600){var a;const s=(a=this.zappers)==null?void 0:a.get(n);if(s){if(s.document===null)return s.fetchedAt+e*1e3<Date.now()?"missing":null;try{return JSON.parse(s.document)}catch{return"missing"}}const i=await db.lnurl.get({pubkey:n});if(!i)return"missing";const r=Date.now();if(i.fetchedAt+t*1e3<r)return"missing";if(i.document===null)return i.fetchedAt+e*1e3<r?"missing":null;try{return JSON.parse(i.document)}catch{return"missing"}}async saveUsersLNURLDoc(n,t){var e;try{const s=t?JSON.stringify(t):null;(e=this.zappers)==null||e.set(n,{document:s,fetchedAt:Date.now()})}catch(s){console.error("Failed to save LNURL document for pubkey:",n,s)}}processFilter(n,t){const e={...n};e.limit=void 0;const s=new Set(Object.keys(e||{}));s.delete("since"),s.delete("limit"),s.delete("until");try{if(this.byNip33Query(s,n,t)||this.byAuthors(n,t)||this.byIdsQuery(n,t)||this.byTags(n,t)||this.byKinds(s,n,t))return}catch(i){console.error(i)}}async deleteEventIds(n){n.forEach(t=>this.events.delete(t)),await db.events.where({id:n}).delete()}async setEvent(n,t,e){if(n.kind===0){if(!this.profiles)return;try{const i=profileFromEvent(n);this.saveProfile(n.pubkey,i)}catch{this.debug(`Failed to save profile for pubkey: ${n.pubkey}`)}}let s=!0;if(n.isParamReplaceable()){const i=this.events.get(n.tagId());i&&n.created_at&&i.createdAt>n.created_at&&(s=!1)}if(s){const i={id:n.tagId(),pubkey:n.pubkey,kind:n.kind,createdAt:n.created_at??Date.now(),relay:e==null?void 0:e.url,event:n.serialize(this.saveSig,!0)};this.saveSig&&n.sig&&(i.sig=n.sig),this.events.set(n.tagId(),i);const r=getIndexableTags(n);for(const a of r)this.eventTags.add(a[0]+a[1],n.tagId())}}updateRelayStatus(n,t){const e={url:n,updatedAt:Date.now(),...t};this.relayInfo.set(n,e)}getRelayStatus(n){const t=this.relayInfo.get(n);if(t)return{lastConnectedAt:t.lastConnectedAt,dontConnectBefore:t.dontConnectBefore}}byAuthors(n,t){if(!n.authors)return!1;let e=0;for(const s of n.authors){let i=Array.from(this.events.getFromIndex("pubkey",s));n.kinds&&(i=i.filter(r=>{var a;return(a=n.kinds)==null?void 0:a.includes(r.kind)})),foundEvents(t,i,n),e+=i.length}return!0}byIdsQuery(n,t){if(n.ids){for(const e of n.ids){const s=this.events.get(e);s&&foundEvent(t,s,s.relay,n)}return!0}return!1}byNip33Query(n,t,e){const s=["#d","authors","kinds"];if(n.size===s.length&&s.every(r=>n.has(r))&&t.kinds&&t.authors){for(const r of t.kinds)if(r>=3e4&&r<4e4)for(const o of t.authors)for(const l of t["#d"]){const h=`${r}:${o}:${l}`,u=this.events.get(h);u&&foundEvent(e,u,u.relay,t)}return!0}return!1}byTags(n,t){const e=Object.entries(n).filter(([s])=>s.startsWith("#")&&s.length===2).map(([s,i])=>[s[1],i]);if(e.length===0)return!1;for(const[s,i]of e)for(const r of i){const a=s+r,o=this.eventTags.getSet(a);o&&o.forEach(l=>{const h=this.events.get(l);h&&(!n.kinds||n.kinds.includes(h.kind))&&foundEvent(t,h,h.relay,n)})}return!0}byKinds(n,t,e){if(!t.kinds||n.size!==1||!n.has("kinds"))return!1;const s=t.limit||500;let i=0;const r=new Set,a=[...t.kinds].sort((o,l)=>{var h,u,f,p;return(((u=(h=this.events.indexes.get("kind"))==null?void 0:h.get(o))==null?void 0:u.size)||0)-(((p=(f=this.events.indexes.get("kind"))==null?void 0:f.get(l))==null?void 0:p.size)||0)});for(const o of a){const l=this.events.getFromIndex("kind",o);for(const h of l)if(!r.has(h.id)&&(r.add(h.id),foundEvent(e,h,h.relay,t),i++,i>=s))break;if(i>=s)break}return!0}};function foundEvents(n,t,e){e!=null&&e.limit&&t.length>e.limit&&(t=t.sort((s,i)=>i.createdAt-s.createdAt).slice(0,e.limit));for(const s of t)foundEvent(n,s,s.relay,e)}function foundEvent(n,t,e,s){try{const i=deserialize(t.event);if(s&&!matchFilter(s,i))return;const r=new NDKEvent(void 0,i),a=e?n.pool.getRelay(e,!1):void 0;r.relay=a,n.eventReceived(r,a,!0)}catch(i){console.error("failed to deserialize event",i)}}function getIndexableTags(n){const t=[];if(n.kind===3)return[];for(const e of n.tags)if(e[0].length===1&&(t.push(e),t.length>=INDEXABLE_TAGS_LIMIT))return[];return t}export{NDKEvent$1 as N,NDKSubscriptionCacheUsage as a,NDK as b,NDKCacheAdapterDexie as c,NDKNip07Signer$1 as d,NDKPrivateKeySigner$1 as e};
